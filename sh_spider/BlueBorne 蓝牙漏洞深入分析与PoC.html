<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>BlueBorne 蓝牙漏洞深入分析与PoC - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="作者：huahuaisadog @ 360VulpeckerTeam0x00前些天，armis爆出了一系列蓝牙的漏洞，无接触无感知接管系统的能力有点可怕，而且基本上影响所有的蓝牙设备，危害不可估量，可以看这里来了解一下它的逆天能力：只要手…" />
    <meta name="keywords" content="" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">BlueBorne 蓝牙漏洞深入分析与PoC</h1>
                <p class="art_time">5小时 前发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/technology">技术</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>2,409</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>armis给出了他们的whitepaper，对蓝牙架构和这几个漏洞的分析可以说非常详尽了，先膜一发。不过他们没有给出这些漏洞的PoC或者是exp，只给了一个针对Android的“BlueBorne检测app"，但是逆向这个发现仅仅是检测了系统的补丁日期。于是我来</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p><strong><span style="font-family:宋体">作者：</span>huahuaisadog @ 360VulpeckerTeam</strong></p>
<p><span style="font-size: 20px;"><strong>0x00</strong></span></p>
<p><span style="font-family:宋体">前些天，</span>armis<span style="font-family:宋体">爆出了一系列蓝牙的漏洞，<strong>无接触无感知接管系统</strong>的能力有点可怕，而且基本上影响所有的蓝牙设备，危害不可估量，可以<a href="https://www.armis.com/blueborne/" target="_self">看这里</a></span><span style="font-family:宋体">来了解一下它的逆天能力：只要手机开启了蓝牙，就可能被远程控制。现在手机这么多，利用这个漏洞写出蠕虫化的工具，那么可能又是一个手机版的低配</span>wannacry<span style="font-family:宋体">了。我们</span>360Vulpecker Team<span style="font-family:宋体">在了解到这些相关信息后，快速进行了跟进分析。</span> armis<span style="font-family:宋体">给出了他们的</span>whitepaper<span style="font-family:宋体">，对蓝牙架构和这几个漏洞的分析可以说非常详尽了，先膜一发。不过他们没有给出这些漏洞的</span>PoC<span style="font-family:宋体">或者是</span>exp<span style="font-family:宋体">，只给了一个针对</span>Android<span style="font-family:宋体">的“</span>BlueBorne<span style="font-family:宋体">检测</span>app&quot;<span style="font-family:宋体">，但是逆向这个发现<strong>仅仅是检测了系统的补丁日期</strong>。于是我来拾一波牙慧，把这几个漏洞再分析一下，然后把</span>poc<span style="font-family:宋体">编写出来：</span>&nbsp;</p>
<p>* CVE-2017-1000250 Linux bluetoothd<span style="font-family:宋体">进程信息泄露</span>&nbsp;</p>
<p>* CVE-2017-1000251 Linux <span style="font-family:宋体">内核栈溢出</span>&nbsp;</p>
<p>* CVE-2017-0785 Android com.android.bluetooth<span style="font-family:宋体">进程信息泄露</span>&nbsp;</p>
<p>* CVE-2017-0781 Android com.android.bluetooth<span style="font-family:宋体">进程堆溢出</span>&nbsp;</p>
<p>* CVE-2017-0782 Android com.android.bluetooth<span style="font-family:宋体">进程堆溢出</span></p>
<p><strong><span style="font-family:宋体">以上</span>PoC</strong><strong><span style="font-family:宋体">代码均在</span></strong></p>
<p><a href="https://github.com/marsyy/littl_tools/tree/master/bluetooth"><strong>https://github.com/marsyy/littl_tools/tree/master/bluetooth</strong></a><strong>&nbsp;</strong></p>
<p><span style="font-family:宋体">由于也是因为这几个漏洞才从零开始搞蓝牙，所以应该有些分析不到位的地方，还请各路大牛斧正。</span></p>
<p><span style="font-size: 20px;"><strong>0x01 </strong><strong><span style="font-family: 宋体;">蓝牙架构及代码分布</span></strong></span></p>
<p><span style="font-family:宋体">这里首先应该祭出</span>armis<span style="font-family:宋体">的</span>paper<span style="font-family:宋体">里的图：</span>&nbsp;</p>
<p><img title="1506737635160270.png" alt="1.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737635160270.png"/><noscript><img title="1506737635160270.png" alt="1.png" src="/uploads/20170930/1506737635160270.png"/></noscript></p>
<p style="text-align: center;">1</p>
<p><span style="font-family:宋体">图上把蓝牙的各个层次关系描述得很详尽，不过我们这里暂时只需要关心这么几层：</span><strong>HCI</strong><strong><span style="font-family:宋体">，</span>L2CAP</strong><strong><span style="font-family:宋体">，</span>BNEP</strong><strong><span style="font-family:宋体">，</span>SDP</strong><span style="font-family:宋体">。</span>BNEP<span style="font-family:宋体">和</span>SDP<span style="font-family:宋体">是比较上层的服务，</span>HCI<span style="font-family:宋体">在最底层，直接和蓝牙设备打交道。而承载在蓝牙服务和底层设备之间的桥梁，也就是</span>L2CAP<span style="font-family:宋体">层了。每一层都有它协议规定的数据组织结构，所有层的数据包组合在一起，就是一个完整的蓝牙包（一个</span>SDP<span style="font-family:宋体">包为例）：</span>&nbsp;</p>
<p><img title="1506737646403959.png" alt="2.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737646403959.png"/><noscript><img title="1506737646403959.png" alt="2.png" src="/uploads/20170930/1506737646403959.png"/></noscript></p>
<p style="text-align: center;">2</p>
<p><span style="font-family:宋体">虽然协议规定的架构是图上说的那样，但是具体实现是有不同的，</span>Linux<span style="font-family:宋体">用的</span><strong>BlueZ</strong><span style="font-family:宋体">，而现在的</span>Android<span style="font-family:宋体">用的</span><strong>BlueDroid</strong><span style="font-family:宋体">，也就针对这两种架构说一说代码的具体分布。</span></p>
<p><strong>BlueZ</strong></p>
<p><span style="font-family:宋体">在</span>Linux<span style="font-family:宋体">里，用的是</span>BlueZ<span style="font-family:宋体">架构，由</span><strong>bluetoothd</strong><span style="font-family:宋体">来提供</span>BNEP,SDP<span style="font-family:宋体">这些比较上层的服务，而</span>L2CAP<span style="font-family:宋体">层则是放在内核里面。对于</span>BlueZ<span style="font-family:宋体">我们对</span>SDP<span style="font-family:宋体">和</span>L2CAP<span style="font-family:宋体">挨个分析。</span>&nbsp;</p>
<p class="MsoListParagraph" style="margin-left:24px">1，&nbsp; <span style="font-family:宋体">实现</span>SDP<span style="font-family:宋体">服务的代码在代码目录的</span><strong>/src/sdp</strong><span style="font-family:宋体">，其中</span><strong>sdp-client.c</strong><span style="font-family:宋体">是它的客户端，</span><strong>sdp-server.c</strong><span style="font-family:宋体">是它的服务端。我们要分析的漏洞都是远程的漏洞，所以<strong>问题是出在服务端里面</strong>，我们重点关注服务端。而服务端最核心的代码，应该是它对接受到的数据包的处理的过程，这个过程由</span><strong>sdp-request.c</strong><span style="font-family:宋体">来实现。当</span>L2CAP<span style="font-family:宋体">层有</span>SDP<span style="font-family:宋体">数据后，会触发</span>sdp-server.c<span style="font-family:宋体">的</span><strong>io_session_event</strong><span style="font-family:宋体">函数，来获取这个数据包，交由</span><strong>sdp-request.c</strong><span style="font-family:宋体">的</span><strong>handle_request</strong><span style="font-family:宋体">函数处理</span>(<span style="font-family:宋体">怎么处理的，后续漏洞分析的时候再讲</span>)<span style="font-family:宋体">：</span></p>
<p class="MsoListParagraph" style="margin-left:24px;text-indent:0">&nbsp;&nbsp;</p>
<p><img title="1506737665639469.png" alt="3.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737665639469.png"/><noscript><img title="1506737665639469.png" alt="3.png" src="/uploads/20170930/1506737665639469.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>3</p>
<p>2<span style="font-family:宋体">，</span> L2CAP<span style="font-family:宋体">层的代码在内核里，这里我以</span>Linux 4.2.8<span style="font-family:宋体">这份代码为例。</span>l2cap<span style="font-family:宋体">层主要由</span><strong>&nbsp;/net/bluetooth/l2capcore.c</strong><span style="font-family: 宋体">和</span><strong>/net/bluetooth/l2cap_sock.c</strong><span style="font-family:宋体">来实现。</span><strong>l2cap_core.c</strong><span style="font-family:宋体">实现了</span>L2CAP<span style="font-family:宋体">协议的主要内容，</span>l2cap_sock.c<span style="font-family:宋体">通过注册</span>sock<span style="font-family:宋体">协议的方式提供了这一层针对</span>userspace<span style="font-family:宋体">的接口。同样的我们关心一个</span>L2CAP<span style="font-family:宋体">对接受到数据包后的处理过程，</span>L2CAP<span style="font-family:宋体">的数据是由</span>HCI<span style="font-family:宋体">层传过来的，在</span>hci_core.c<span style="font-family:宋体">的</span>hci_rx_work<span style="font-family:宋体">函数里</span>&nbsp;</p>
<p><img title="1506737673421706.png" alt="4.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737673421706.png"/><noscript><img title="1506737673421706.png" alt="4.png" src="/uploads/20170930/1506737673421706.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>4</p>
<p><span style="font-family:宋体">收到数据后，会判断</span>pkt_type<span style="font-family:宋体">，符合</span>L2CAP<span style="font-family:宋体">层的</span>type<span style="font-family:宋体">是</span><strong>HCI_ACLDATA_PKT</strong><span style="font-family:宋体">，函数会走到</span><strong>hci_acldata_packet</strong><span style="font-family:宋体">，这个函数会把</span>HCI<span style="font-family:宋体">的数据剥离之后，把</span>L2CAP<span style="font-family:宋体">数据交给</span>L2CAP<span style="font-family:宋体">层的</span><strong>l2cap_recv_acldata</strong><span style="font-family:宋体">：</span></p>
<p><img title="1506737681148944.png" alt="5.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737681148944.png"/><noscript><img title="1506737681148944.png" alt="5.png" src="/uploads/20170930/1506737681148944.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>5</p>
<p><span style="font-family:宋体">同样的，对于</span>L2CAP<span style="font-family:宋体">层对数据的细致处理，我们还是等后续和漏洞来一块进行分析。</span></p>
<p><strong>BlueDroid</strong></p>
<p><span style="font-family:宋体">在现在的</span>Android<span style="font-family:宋体">里，用的是</span><strong>BlueDroid</strong><span style="font-family:宋体">架构。这个和</span>BlueZ<span style="font-family:宋体">架构有很大不同的一点是：</span><strong>BlueDroid</strong><strong><span style="font-family:宋体">将</span>L2CAP</strong><strong><span style="font-family:宋体">层放在了</span>userspace</strong><span style="font-family:宋体">。</span>SDP<span style="font-family:宋体">，</span>BNEP<span style="font-family:宋体">，</span>L2CAP<span style="font-family:宋体">统统都由</span><strong>com.android.bluetooth</strong><span style="font-family:宋体">这个进程管理。而</span>BlueDroid<span style="font-family:宋体">代码的核心目录在</span>Android<span style="font-family:宋体">源码目录下的</span>&nbsp;<strong>/sytem/bt</strong>&nbsp;<span style="font-family:宋体">，这个目录的核心产物是</span><strong>bluetooth.default.so</strong><span style="font-family:宋体">，这个</span>so<span style="font-family:宋体">集成所有</span>Android<span style="font-family:宋体">蓝牙相关的服务，而且这个</span>so<span style="font-family:宋体">没有导出任何相关接口函数，只导出了几个协议相关的全局变量供使用，所以想根据</span>so<span style="font-family:宋体">来本地检测本机是否有</span>BlueDrone<span style="font-family:宋体">漏洞，是一件比较困难的事情。对于</span>BlueDroid<span style="font-family:宋体">，由于</span>android<span style="font-family:宋体">的几个漏洞出在</span>BNEP<span style="font-family:宋体">服务和</span>SDP<span style="font-family:宋体">服务，所以也就主要就针对这两块。值得注意的是，在</span>Android<span style="font-family:宋体">里，<strong>不论是</strong></span><strong>64</strong><strong><span style="font-family:宋体">位还是</span>32</strong><strong><span style="font-family:宋体">位的系统，这个</span>bluetooth.default.so</strong><strong><span style="font-family:宋体">都是用的</span>32</strong><strong><span style="font-family:宋体">位的</span></strong><span style="font-family: 宋体">。文章里这部分代码都基于</span><strong>Android7.1.2</strong><span style="font-family:宋体">的源码。</span>&nbsp;</p>
<p><strong>1</strong><strong><span style="font-family: 宋体">，</span>BlueDroid</strong><strong><span style="font-family:宋体">的</span>SDP</strong><strong><span style="font-family:宋体">服务的代码，在</span>/system/bt/stack/sdp </strong><strong><span style="font-family:宋体">文件夹里，其中</span>sdp</strong><strong><span style="font-family:宋体">服务端对数据包的处理由</span>sdp-server.c</strong><strong><span style="font-family:宋体">实现</span></strong><span style="font-family:宋体">。</span>SDP<span style="font-family:宋体">连接建立起来后，在收到</span>SDP<span style="font-family:宋体">数据包之后呢，会触发回调函数</span>sdp_data_ind<span style="font-family:宋体">，这个函数会把数据包交个</span><strong>sdp-server.c</strong><span style="font-family:宋体">的</span>sdp_server_handle_client_req<span style="font-family:宋体">函数进行处理</span>:&nbsp;</p>
<p><strong><img title="1506737690805512.png" alt="6.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737690805512.png"/><noscript><img title="1506737690805512.png" alt="6.png" src="/uploads/20170930/1506737690805512.png"/></noscript></strong></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>6</p>
<p><strong>BlueDroid</strong><strong><span style="font-family:宋体">的</span>BNEP</strong><strong><span style="font-family:宋体">服务的代码主要在</span>/system/bt/stack/bnep/bnepmain.c</strong><span style="font-family:宋体">。</span>BNEP<span style="font-family:宋体">连接建立起来后，再收到</span>BNEP<span style="font-family:宋体">的包，和</span>SDP<span style="font-family:宋体">类似，会触发回调函数</span>bnep_data_ind<span style="font-family:宋体">，这个函数包含了所有对</span>BNEP<span style="font-family:宋体">请求的处理，漏洞也是发生在这里，具体的代码我们后续会分析。</span></p>
<p><span style="font-size: 20px;"><strong>0x02 </strong><strong><span style="font-family: 宋体;">漏洞分析以及</span>PoC</strong><strong><span style="font-family: 宋体;">写法</span></strong></span></p>
<p><span style="font-family:宋体">蓝牙的预备知识差不多了，主要是找数据包的入口。我们再基于漏洞和</span>PoC<span style="font-family:宋体">的编写过程来详细分析其中的处理过程，和相关蓝牙操作的代码该怎么写。</span></p>
<p><strong>CVE-2017-1000251</strong></p>
<p><span style="font-family:宋体">这个是</span>Linux L2CAP<span style="font-family:宋体">层的漏洞，那么就是内核里面的。先不着急看漏洞，先看</span>L2CAP<span style="font-family:宋体">层如何工作。在一个</span>L2CAP<span style="font-family:宋体">连接的过程中，我们抓取了它的数据包来分析，</span>L2CAP<span style="font-family:宋体">是怎么建立起连接的：</span>&nbsp;</p>
<p><img title="1506737698560411.png" alt="7.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737698560411.png"/><noscript><img title="1506737698560411.png" alt="7.png" src="/uploads/20170930/1506737698560411.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>7</p>
<p><span style="font-family:宋体">我们注意这么几个包：</span>&nbsp;sent_infomation_request&nbsp;,&nbsp;send_connection_request,&nbsp;send_configure_request<span style="font-family:宋体">。抓包可以看到，在一次完整的</span>L2CAP<span style="font-family:宋体">连接的建立过程中，发起连接的机器，会主动送出这么几个包。其中</span>infomation_request<span style="font-family:宋体">是为了得到对方机器的名称等信息，</span>connection_request<span style="font-family:宋体">是为了建立</span>L2CAP<span style="font-family:宋体">真正的连接，主要是为了确定双方的</span>CHANNEL ID<span style="font-family:宋体">，后续的数据包传输都要跟着这个</span>channel id <span style="font-family:宋体">走（图上的</span>SCID, DCID<span style="font-family:宋体">），这个</span>channel<span style="font-family:宋体">也就是我们所说的连接。在</span>connection_request<span style="font-family:宋体">处理完毕之后，连接状态将变成</span> BT_CONNECT2 <span style="font-family:宋体">。随后机器会发起</span>configure_request,<span style="font-family:宋体">这一步就到了</span>armis<span style="font-family:宋体">的</span>paper<span style="font-family:宋体">第十页所说的</span>configuration &nbsp;process:&nbsp;</p>
<p><img title="1506737707677320.png" alt="8.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737707677320.png"/><noscript><img title="1506737707677320.png" alt="8.png" src="/uploads/20170930/1506737707677320.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>8</p>
<p><span style="font-family:宋体">这个过程完成后，整个</span>L2CAP<span style="font-family:宋体">层的连接也就建立完成。</span></p>
<p><span style="font-family:宋体">从上述过程看，可以发现</span>L2CAP<span style="font-family:宋体">层连接的建立，主要是对上述三个请求的发起和处理。而我们的漏洞，也其实就发生在</span>configuration &nbsp;process<span style="font-family:宋体">。我们先分析接收端收到这三个请求后，处理的逻辑在哪里，也就是我们前文提到的</span>L2CAP<span style="font-family:宋体">对接受到的数据的处理过程：</span>&nbsp;</p>
<p>1<span style="font-family:宋体">，在</span>l2cap_recv_acldata<span style="font-family:宋体">接收到数据后，数据包会传给</span>l2cap_recv_frame&nbsp;</p>
<p>2<span style="font-family:宋体">，</span>l2cap_recv_frame<span style="font-family:宋体">会取出检查</span>L2CAP<span style="font-family:宋体">的头部数据，然后检查根据头部里的</span>cid<span style="font-family:宋体">字段，来选择处理逻辑：</span>&nbsp;</p>
<p><img title="1506737716972150.png" alt="9.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737716972150.png"/><noscript><img title="1506737716972150.png" alt="9.png" src="/uploads/20170930/1506737716972150.png"/></noscript>&nbsp;</p>
<p style="text-align: center;"><span style="font-family:宋体">图</span> 9</p>
<p>3<span style="font-family:宋体">，底层</span>L2CAP<span style="font-family:宋体">的连接，</span>cid<span style="font-family:宋体">固定是</span>L2CAP_CID_SIGNALING<span style="font-family:宋体">，于是会走</span>l2cap_sig_channel<span style="font-family:宋体">，</span>l2cap_sig_channel<span style="font-family:宋体">得到的是剥离了头部的</span>L2CAP<span style="font-family:宋体">的数据，这一部将把数据里的</span>cmd<span style="font-family:宋体">头部解析并剥离，再传给</span>l2cap_bredr_sig_cmd<span style="font-family:宋体">进行处理：</span></p>
<p><img title="1506737724666759.png" alt="10.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737724666759.png"/><noscript><img title="1506737724666759.png" alt="10.png" src="/uploads/20170930/1506737724666759.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>10</p>
<p><span style="font-family:宋体">到这里，我们应该能得出</span>L2CAP<span style="font-family:宋体">协议的数据结构：</span></p>
<p><img title="1506737732474342.png" alt="11.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737732474342.png"/><noscript><img title="1506737732474342.png" alt="11.png" src="/uploads/20170930/1506737732474342.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>11</p>
<p>4<span style="font-family:宋体">，</span> <span style="font-family:宋体">随后数据进入到了</span>l2cap_bredr_sig_cmd<span style="font-family:宋体">函数进行处理。这里也就是处理</span>L2CAP<span style="font-family:宋体">各种请求的核心函数了：</span>&nbsp;</p>
<p><img title="1506737740312472.png" alt="12.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737740312472.png"/><noscript><img title="1506737740312472.png" alt="12.png" src="/uploads/20170930/1506737740312472.png"/></noscript></p>
<p><span style="font-family:宋体">图</span>12</p>
<p><img title="1506737748405457.png" alt="13.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737748405457.png"/><noscript><img title="1506737748405457.png" alt="13.png" src="/uploads/20170930/1506737748405457.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>13</p>
<p><span style="font-family:宋体">好了，接下来终于可以分析漏洞了。我们的漏洞发生在对</span><strong>L2CAP_CONFIG_RSP</strong><strong><span style="font-family:宋体">（</span>config response</strong><strong><span style="font-family:宋体">）</span></strong><span style="font-family: 宋体">这个</span>cmd<span style="font-family:宋体">的处理上。其实漏洞分析</span>armis<span style="font-family:宋体">的</span>paper<span style="font-family:宋体">已经写的很详尽了，我这里也就权当翻译了吧，然后再加点自己的理解。那么来看</span>l2cap_config_rsp:&nbsp;</p>
<p><img title="1506737755119517.png" alt="14.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737755119517.png"/><noscript><img title="1506737755119517.png" alt="14.png" src="/uploads/20170930/1506737755119517.png"/></noscript></p>
<p style="text-align: center;">14</p>
<p><span style="font-family:宋体">当收到的数据包里，满足</span><strong>result == L2CAP_CONF_PENDING</strong><span style="font-family: 宋体">，且自身的连接状态</span><strong>conf_state == CONF_LOC_CONF_PEND</strong><span style="font-family:宋体">的时候，会走到</span>&nbsp;<strong>l2cap_parse_conf_rsp</strong><span style="font-family: 宋体">函数里，而且传过去的</span>buf<span style="font-family:宋体">是个长度为</span>64<span style="font-family:宋体">的数据，参数</span>len <span style="font-family:宋体">，参数</span>rsp-&gt;data<span style="font-family:宋体">都是由包中的内容来任意确定。那么在</span><strong>l2cap_parse_conf_rsp</strong><span style="font-family:宋体">函数里：</span></p>
<p><img title="1506737764724904.png" alt="15.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737764724904.png"/><noscript><img title="1506737764724904.png" alt="15.png" src="/uploads/20170930/1506737764724904.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>15</p>
<p><img title="1506737770681962.png" alt="16.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737770681962.png"/><noscript><img title="1506737770681962.png" alt="16.png" src="/uploads/20170930/1506737770681962.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>16</p>
<p><span style="font-family:宋体">仔细阅读这个函数的代码可以知道，这个函数的功能就是<strong>根据传进来的包，来构造将要发出去的包</strong>。而数据的出口就是传进去的</span>64<span style="font-family:宋体">字节大小的</span>buf<span style="font-family:宋体">。但是对传入的包的数据的长度并没有做检验，那么当</span>len<span style="font-family:宋体">很大时，就会一直往出口</span>buf<span style="font-family:宋体">里写数据，比如有</span>64<span style="font-family:宋体">个</span><strong>L2CAP_CONF_MTU</strong><span style="font-family:宋体">类型的</span>opt<span style="font-family:宋体">，那么就会往</span>buf<span style="font-family:宋体">里写上</span><strong>64*(L2CAP_CONF_OPT_SIZE + 2)</strong><span style="font-family: 宋体">个字节，那么显然这里就发生了溢出。由于</span>buf<span style="font-family:宋体">是栈上定义的数据结构，那么这里就是一个栈溢出。</span> <span style="font-family:宋体">不过值得注意的是，代码要走进去，需要</span><strong>conf_state == CONF_LOC_CONF_PEND</strong><span style="font-family: 宋体">，这个状态是在处理</span><strong>L2CAP_CONF_REQ</strong><span style="font-family:宋体">数据包的时候设置的：</span></p>
<p><img title="1506737780721327.png" alt="17.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737780721327.png"/><noscript><img title="1506737780721327.png" alt="17.png" src="/uploads/20170930/1506737780721327.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>17</p>
<p><img title="1506737789338011.png" alt="18.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737789338011.png"/><noscript><img title="1506737789338011.png" alt="18.png" src="/uploads/20170930/1506737789338011.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>18</p>
<p><span style="font-family:宋体">当收到</span>L2CAP_CONF_REQ<span style="font-family:宋体">的包中包含有</span>L2CAP_CONF_EFS<span style="font-family:宋体">类型的数据【</span>1<span style="font-family:宋体">】，而且</span>L2CAP_CONF_EFS<span style="font-family:宋体">数据的</span><strong>stype == L2CAP_SERV_NOTRAFIC</strong><span style="font-family: 宋体">【</span>2<span style="font-family:宋体">】的时候，</span>conf_state<span style="font-family:宋体">会被置</span>CONF_LOC_CONF_PEND</p>
<p><span style="font-family:宋体">到这里，这个漏洞触发的思路也就清楚了：</span></p>
<p>&nbsp;1<span style="font-family: 宋体">，建立和目标机器的</span>L2CAP <span style="font-family:宋体">连接，这里注意</span>sock_type<span style="font-family:宋体">的选择要是</span>SOCK_RAW<span style="font-family:宋体">，如果不是，内核会自动帮我们完成</span>sent_infomation_request,&nbsp;send_connection_request,&nbsp;send_configure_request<span style="font-family:宋体">这些操作，也就无法触发目标机器的漏洞了。</span>&nbsp;</p>
<p>2<span style="font-family:宋体">，建立</span>SOCK_RAW<span style="font-family:宋体">连接，</span>connect<span style="font-family:宋体">的时候，会自动完成</span>sent_infomation_request<span style="font-family:宋体">的操作，不过这个不影响。</span>&nbsp;</p>
<p>3<span style="font-family:宋体">，接下来我们需要完成</span>send_connection_request<span style="font-family:宋体">操作，来确定</span>SCID,DCID<span style="font-family:宋体">。完成这个操作的过程是发送合法的</span> L2CAP_CONN_REQ<span style="font-family:宋体">数据包。</span>&nbsp;</p>
<p>4<span style="font-family:宋体">，接下来需要发送包含有</span>L2CAP_CONF_EFS<span style="font-family:宋体">类型的数据，而且</span>L2CAP_CONF_EFS<span style="font-family:宋体">数据的</span>stype ==L2CAP_SERV_NOTRAFIC<span style="font-family:宋体">的</span>L2CAP_CONF_REQ<span style="font-family:宋体">包，这一步是为了让目标机器的</span>conf_state<span style="font-family:宋体">变成</span>CONF_LOC_CONF_PEND<span style="font-family:宋体">。</span>&nbsp;</p>
<p>5<span style="font-family:宋体">，这里就到了发送</span>cmd_len<span style="font-family:宋体">很长的</span>L2CAP_CONN_RSP<span style="font-family:宋体">包了。这个包的</span>result<span style="font-family:宋体">字段需要是</span>L2CAP_CONF_PENDING<span style="font-family:宋体">。那么这个包发过去之后，目标机器就内核栈溢出了，要么重启了，要么死机了。</span></p>
<p><span style="font-family:宋体">这个漏洞是这几个漏洞里，触发最难的。</span></p>
<p><strong>CVE-2017-1000250</strong></p>
<p><span style="font-family:宋体">这个漏洞是</span>BlueZ<span style="font-family:宋体">的</span>SDP<span style="font-family:宋体">服务里的信息泄露漏洞。这个不像</span>L2CAP<span style="font-family:宋体">层的连接那么复杂，主要就是上层服务，收到数据就进行处理。那么我们也只需要关注处理的函数。</span> <span style="font-family:宋体">之前说过，</span>BlueZ<span style="font-family:宋体">的</span>SDP<span style="font-family:宋体">收到数据是从</span>io_session_event<span style="font-family:宋体">开始。之后，数据的流向是：</span></p>
<table width="827" cellspacing="0" cellpadding="0">
<tbody>
<tr class="firstRow">
<td width="25">
<p>1</p>
</td>
<td>
<p>iosessionevent&#8211;&gt;handlerequest&#8211;&gt;processrequest</p>
</td>
</tr>
</tbody>
</table>
<p><img title="1506737804197624.png" alt="19.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737804197624.png"/><noscript><img title="1506737804197624.png" alt="19.png" src="/uploads/20170930/1506737804197624.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>19</p>
<p><span style="font-family:宋体">有必要介绍一下</span>SDP<span style="font-family:宋体">协议的数据结构：</span> &nbsp;<span style="font-family:宋体">它有一个</span>sdp_pud_hdr<span style="font-family:宋体">的头部，头部数据里定义了</span>PUD<span style="font-family:宋体">命令的类型，</span>tid<span style="font-family:宋体">，以及</span>pdu parameter<span style="font-family:宋体">的长度，然后就是具体的</span>parameter<span style="font-family:宋体">。最后一个字段是</span>continuation state<span style="font-family:宋体">，当一个包发不完所要发送的数据的时候，这个字段就会有效。对与这个字段，</span>BlueZ<span style="font-family:宋体">给了它一个定义：</span></p>
<p><img title="1506737813133689.png" alt="20.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737813133689.png"/><noscript><img title="1506737813133689.png" alt="20.png" src="/uploads/20170930/1506737813133689.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>20</p>
<p><span style="font-family:宋体">对于远程的连接，</span>PDU<span style="font-family:宋体">命令类型只能是这三个：</span>SDP_SVC_SEARCH_REQ,&nbsp;SDP_SVC_ATTR_REQ,&nbsp;SDP_SVC_SEARCH_ATTR_REQ<span style="font-family:宋体">。这个漏洞呢，出现在对</span>SDP_SVC_SEARCH_ATTR_REQ<span style="font-family:宋体">命令的处理函数里面</span> service_search_attr_req <span style="font-family:宋体">。这个函数有点长，就直接说它干了啥，不贴代码了：</span></p>
<p>1<span style="font-family:宋体">，</span> extract_des(pdata, data_left, &amp;pattern, &amp;dtd, SDP_TYPE_UUID);&nbsp;<span style="font-family:宋体">解析</span>service search pattern<span style="font-family:宋体">（对应</span>SDP<span style="font-family:宋体">协议数据结构图）</span>&nbsp;</p>
<p>2<span style="font-family:宋体">，</span>max = getbe16(pdata); <span style="font-family:宋体">获得</span>Maximu Attribute Byte&nbsp;</p>
<p>3<span style="font-family:宋体">，</span>scanned = extract_des(pdata, data_left, &amp;seq, &amp;dtd,&nbsp;SDP_TYPE_ATTRID);<span style="font-family:宋体">解析</span>Attribute ID list&nbsp;</p>
<p>4<span style="font-family:宋体">，</span>if (sdp_cstate_get(pdata, data_left, &amp;cstate) &lt; 0) ;<span style="font-family:宋体">获取</span>continuation state<span style="font-family:宋体">状态</span>cstate<span style="font-family:宋体">，如果不为</span>0<span style="font-family:宋体">，则将包里的</span>continuation state<span style="font-family:宋体">数据复制给</span>cstate.</p>
<p><span style="font-family:宋体">漏洞发生在对</span>cstate<span style="font-family:宋体">状态不为</span>0<span style="font-family:宋体">的时候的处理，我们重点看这部分的代码：</span>&nbsp;</p>
<p><img title="1506737822291975.png" alt="21.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737822291975.png"/><noscript><img title="1506737822291975.png" alt="21.png" src="/uploads/20170930/1506737822291975.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>21</p>
<p>sdp_get_cached_rsp<span style="font-family:宋体">函数其实是对</span>cstate<span style="font-family:宋体">的</span>timestamp<span style="font-family:宋体">值的检验，如何过这个检验之后再说。当代码走到【</span>1<span style="font-family:宋体">】处的</span>memcpy<span style="font-family:宋体">时，由于</span><strong>cstate-&gt;maxBytesSent</strong><span style="font-family:宋体">就是由数据包里的数据所控制，而且没有做任何检验，所以这里可以为任意的</span>uint16t<span style="font-family:宋体">值。那么很明显，这里就出现了一个对</span>pResponse<span style="font-family:宋体">的越界读的操作。而越界读的数据还会通过</span>SDP RESPONSE<span style="font-family:宋体">发送给攻击方，那么一个信息泄露就发生了。</span></p>
<p><span style="font-family:宋体">写这个</span>poc<span style="font-family:宋体">需要注意</span>sdp_get_cached_rsp<span style="font-family:宋体">的检验的绕过，那么首先需要得到一个</span>timestamp<span style="font-family:宋体">。当一次发送的包不足以发送完所有的数据的时候，会设置</span>cstate<span style="font-family:宋体">状态，所以如果我们发给服务端的包里，</span>max<span style="font-family:宋体">字段非常小，那么服务端就会给我们回应一个带</span>cstate<span style="font-family:宋体">状态的包，这里面会有</span>timestamp:&nbsp;</p>
<p><img title="1506737830307651.png" alt="22.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737830307651.png"/><noscript><img title="1506737830307651.png" alt="22.png" src="/uploads/20170930/1506737830307651.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>22</p>
<p><span style="font-family:宋体">所以，我们的</span>poc<span style="font-family:宋体">应该是这个步骤：</span>&nbsp;</p>
<p>1<span style="font-family:宋体">，建立</span>SDP<span style="font-family:宋体">连接。这里我们的</span>socket<span style="font-family:宋体">需要是</span>SOCK_STREAM<span style="font-family:宋体">类型，而且</span>connet<span style="font-family:宋体">的时候，</span>addr<span style="font-family:宋体">的</span>psm<span style="font-family:宋体">字段要是</span>0x0001<span style="font-family:宋体">。关于连接的</span>PSM<span style="font-family:宋体">：</span>&nbsp;</p>
<p><img title="1506737838351518.png" alt="23.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737838351518.png"/><noscript><img title="1506737838351518.png" alt="23.png" src="/uploads/20170930/1506737838351518.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>23</p>
<p>2<span style="font-family:宋体">，发送一个不带</span>cstate<span style="font-family:宋体">状态的数据包，而且指定</span>Maximu Attribute Byte<span style="font-family:宋体">的值非常小。这一步是为了让服务端给我们返回一个带</span>timestamp<span style="font-family:宋体">的包。</span>&nbsp;</p>
<p>3<span style="font-family:宋体">，接收这个带</span>timestamp<span style="font-family:宋体">的包，并将</span>timestamp<span style="font-family:宋体">提取。</span>&nbsp;</p>
<p>4<span style="font-family:宋体">，发送一个带</span>cstate<span style="font-family:宋体">状态的数据包，</span>cstate<span style="font-family:宋体">的</span>timestamp<span style="font-family:宋体">是指定为提取出来的值，服务端</span>memcpy<span style="font-family:宋体">的时候，则就会把</span>pResponse+maxBytesSent<span style="font-family:宋体">的内容发送给我们，读取这个数据包，则就获取了泄露的数据。</span></p>
<p><strong>CVE-2017-0785</strong></p>
<p><span style="font-family:宋体">这个漏洞也是</span>SDP<span style="font-family:宋体">的信息泄露漏洞，不过是</span>BlueDroid<span style="font-family:宋体">的。与</span>BlueZ<span style="font-family:宋体">的那个是有些类似的。我们也从对</span>SDP<span style="font-family:宋体">数据包的处理函数说起。</span> SDP<span style="font-family:宋体">数据包会通过</span>sdp_data_ind<span style="font-family:宋体">函数送给</span>sdp_server_handle_client_req<span style="font-family:宋体">。与</span>BlueZ<span style="font-family:宋体">一样，这个函数也会根据包中的</span>pud_id<span style="font-family:宋体">来确定具体的处理函数。这个漏洞发生在对</span>SDP_PDU_SERVICE_SEARCH_REQ<span style="font-family:宋体">命令的处理，对包内数据的解析与上文</span>BlueZ<span style="font-family:宋体">中的大同小异，不过注意在</span>BlueDroid<span style="font-family:宋体">中，</span>cstate<span style="font-family:宋体">结构与</span>BlueZ<span style="font-family:宋体">中有些不同：</span>&nbsp;</p>
<p><img title="1506737847566193.png" alt="24.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737847566193.png"/><noscript><img title="1506737847566193.png" alt="24.png" src="/uploads/20170930/1506737847566193.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>24</p>
<p><span style="font-family:宋体">这里主要看漏洞：</span></p>
<p><img title="1506737856198565.png" alt="25.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737856198565.png"/><noscript><img title="1506737856198565.png" alt="25.png" src="/uploads/20170930/1506737856198565.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>25</p>
<p><img title="1506737865534942.png" alt="26.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737865534942.png"/><noscript><img title="1506737865534942.png" alt="26.png" src="/uploads/20170930/1506737865534942.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>26</p>
<p><span style="font-family:宋体">①，②中代码可以看出，变量</span>num_rsp_handles<span style="font-family:宋体">的值，一定程度上可以由包中的</span>Maximu Attribute Byte<span style="font-family:宋体">字段控制。</span> <span style="font-family:宋体">③中代码是对带</span>cstate<span style="font-family:宋体">的包的处理，第一步是对大小的检查，第二步是获得</span>cont_offset<span style="font-family:宋体">，然后对</span>cont_offset<span style="font-family:宋体">进行检查，第三步就到了</span>&nbsp;<strong>rem_handles = num_rsp_handles &#8211; cont_offset</strong>&nbsp;&nbsp;<span style="font-family:宋体">可以思考一种情况，如果</span>num_rsp_handles &lt; cont_offset<span style="font-family:宋体">，那么这个代码就会发生整数的下溢，而</span>num_rsp_handles<span style="font-family:宋体">在一定程度上我们可以控制，而且是可以控制它变成０，那么只要</span>cont_offset<span style="font-family:宋体">不为０，这里就会发生整数下溢。发生下溢的结果给了</span>rem_handles<span style="font-family:宋体">，而这个变量代表的是还需要发送的数据数。</span> <span style="font-family:宋体">在④中，如果</span>rem_handles<span style="font-family:宋体">是发生了下溢的结果，由于它是</span>uint16_t<span style="font-family:宋体">类型，那么它将变成一个很大的数，所以会走到</span><strong>pccb-&gt;cont_offset +=&nbsp;cur_handles</strong>;,cur_handles<span style="font-family:宋体">是一个固定的值，那么如果这个下溢的过程，发生很多次，</span>pccb-&gt;cont_offset<span style="font-family:宋体">就会变得很大，那么在５处，就会有一个对</span>rsp_handles<span style="font-family:宋体">数组的越界读的产生。</span></p>
<p><span style="font-family:宋体">下面的操作可以让这个越界读发生：</span>&nbsp;</p>
<p><span style="font-family:宋体">１，发送一个不带</span>cstate<span style="font-family:宋体">的包，</span> <span style="font-family:宋体">而且</span>Maximu Attribute Byte<span style="font-family:宋体">字段设置的比较大。那么结果就是</span>rem_handles = num_rsp_handles<span style="font-family:宋体">，而由于</span>max_replies<span style="font-family:宋体">比较大，所以</span><strong>num_rsp_handles</strong><span style="font-family:宋体">会成为一个比较大的值。只要在④中保证</span>rem_handles&gt; cur_handles<span style="font-family:宋体">，那么</span>pccb-&gt;cont_offset<span style="font-family:宋体">就会成为一个非０值</span>cur_handles<span style="font-family:宋体">。这一步是为了使得</span>pccb-&gt;cont_offset<span style="font-family:宋体">成为一个非０值。</span>&nbsp;</p>
<p><span style="font-family:宋体">２，接收服务端的回应包，这个回应包里的</span>cstate<span style="font-family:宋体">字段将会含有刚刚的</span>pccb-&gt;cont_offset<span style="font-family:宋体">值，我们取得这个值。</span>&nbsp;</p>
<p><span style="font-family:宋体">３，发送一个带</span>cstate<span style="font-family:宋体">的包，</span>cont_offset<span style="font-family:宋体">指定为刚刚提取的值，而且设置</span>Maximu Attribute Byte<span style="font-family:宋体">字段为０。那么服务端收到这个包后，就会走到</span><strong>rem_handles = num_rsp_handles &#8211; cont_offset</strong><span style="font-family:宋体">从而发生整数下溢，同时</span>pccb-&gt;cont_offset<span style="font-family:宋体">又递增一个</span>cur_handles<span style="font-family:宋体">大小。</span>&nbsp;</p>
<p><span style="font-family:宋体">４，重复２和３的过程，那么</span>pccb-&gt;cont_offset<span style="font-family:宋体">将越来越大，从而在⑤出发生越界读，我们提取服务端返回的数据，就可以获得泄露的信息的内容。</span></p>
<p><strong>CVE-2017-0781</strong></p>
<p><span style="font-family:宋体">现在我们到了</span>BNEP<span style="font-family:宋体">服务。</span>BNEP<span style="font-family:宋体">的协议格式，下面两张图可以说明的很清楚：</span>&nbsp;</p>
<p><img title="1506737874975768.png" alt="27.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737874975768.png"/><noscript><img title="1506737874975768.png" alt="27.png" src="/uploads/20170930/1506737874975768.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>27</p>
<p><img title="1506737882593537.png" alt="28.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737882593537.png"/><noscript><img title="1506737882593537.png" alt="28.png" src="/uploads/20170930/1506737882593537.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>28</p>
<p>BlueDroid<span style="font-family: 宋体">中</span>BNEP<span style="font-family:宋体">服务对于接受到的数据包的处理也不复杂：</span>&nbsp;</p>
<p>1,<span style="font-family:宋体">解析得到</span>BNEP_TYPE<span style="font-family:宋体">，得到</span>extension<span style="font-family:宋体">位。</span>&nbsp;</p>
<p>2,<span style="font-family:宋体">检查连接状态，如果已经连接则后续可以处理非</span><strong>BNEP_FRAME_CONTROL</strong><span style="font-family:宋体">的包，如果没有建立连接，则后续只处理</span>BNEP_FRAME_CONTROL<span style="font-family:宋体">的包。</span>&nbsp;</p>
<p>3,<span style="font-family:宋体">去</span>BNEP_TYPE<span style="font-family:宋体">对应的处理函数进行处理。</span>&nbsp;</p>
<p>4,<span style="font-family:宋体">对于</span>BNEP_TYPE<span style="font-family:宋体">不是</span>BNEP_FRAME_CONTROL<span style="font-family:宋体">而且有</span>extension<span style="font-family:宋体">位的，还需要对</span>extension<span style="font-family:宋体">的数据进行处理。</span>&nbsp;</p>
<p>5,<span style="font-family:宋体">调用</span>pan<span style="font-family:宋体">层的回调函数。</span></p>
<p><span style="font-family:宋体">值得注意的是，</span>BNEP<span style="font-family:宋体">连接真正建立起来，需要先处理一个合法的</span><strong>BNEP_FRAME_CONTROL</strong><span style="font-family:宋体">数据包。</span> CVE-2017-0781<span style="font-family:宋体">正是连接还没建立起来，在处理</span><strong>BNEP_FRAME_CONTROL</strong><span style="font-family:宋体">时所发生的问题：</span>&nbsp;</p>
<p><img title="1506737890216129.png" alt="29.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737890216129.png"/><noscript><img title="1506737890216129.png" alt="29.png" src="/uploads/20170930/1506737890216129.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>29</p>
<p><span style="font-family:宋体">上述代码中，</span>malloc<span style="font-family:宋体">了一个</span>remlen<span style="font-family:宋体">的大小，这个是和收到的数据包的长度相关的。可是</span>memcpy<span style="font-family:宋体">的时候，却是从</span><strong>pbcb-&gt;p_pending_data</strong><strong><span style="font-family:宋体">＋１</span></strong><span style="font-family:宋体">开始拷贝数据，那么这里会直接溢出一个</span><strong>sizeof(*(pbcb-&gt;p_pending_data))</strong><span style="font-family:宋体">大小的内容。这个大小是</span>8.<span style="font-family:宋体">所以只要代码走到这，就会有一个</span>8<span style="font-family:宋体">字节大小的堆溢出。而要走到这，只需要过那个</span>if<span style="font-family:宋体">的判断条件，而这个</span>if<span style="font-family:宋体">其实是对</span><strong>BNEP_SETUP_CONNECTION_REQUEST_MSG</strong><span style="font-family: 宋体">命令处理失败后的错误处理函数。那么只要发送一个错误的</span><strong>BNEP_SETUP_CONNECTION_REQUEST_MSG</strong><span style="font-family: 宋体">命令包，就可以进入到这段代码了触发堆溢出了。</span></p>
<p><span style="font-family:宋体">所以我们得到</span>poc<span style="font-family:宋体">的编写过程：</span>&nbsp;</p>
<p><span style="font-family:宋体">１，建立</span>BNEP<span style="font-family:宋体">连接，这个和</span>SDP<span style="font-family:宋体">类似，只是需要指定</span>PSM<span style="font-family:宋体">为</span>BNEP<span style="font-family:宋体">对应的</span>0x000F<span style="font-family:宋体">。</span>&nbsp;</p>
<p><span style="font-family:宋体">２，发送一个</span>BNEPTYPE<span style="font-family:宋体">为</span><strong>BNEP_FRAME_CONTROL</strong><span style="font-family:宋体">，</span>extension<span style="font-family:宋体">字段为１，</span>ctrl_type<span style="font-family:宋体">为</span><strong>BNEP_SETUP_CONNECTION_REQUEST_MSG</strong><span style="font-family: 宋体">的错误的</span>BNEP<span style="font-family:宋体">包：</span>&nbsp;</p>
<p><img title="1506737899364595.png" alt="30.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737899364595.png"/><noscript><img title="1506737899364595.png" alt="30.png" src="/uploads/20170930/1506737899364595.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>30</p>
<p><strong>CVE-2017-0782</strong></p>
<p><span style="font-family:宋体">这个也是由于</span>BNEP<span style="font-family:宋体">协议引起的漏洞，首先它是个整数溢出，整数溢出导致的后果是堆溢出。</span> <span style="font-family:宋体">问题出在</span>BNEP<span style="font-family:宋体">对</span>extension<span style="font-family:宋体">字段的处理上：</span>&nbsp;</p>
<p><img title="1506737907261020.png" alt="31.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737907261020.png"/><noscript><img title="1506737907261020.png" alt="31.png" src="/uploads/20170930/1506737907261020.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>31</p>
<p><img title="1506737915912892.png" alt="32.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737915912892.png"/><noscript><img title="1506737915912892.png" alt="32.png" src="/uploads/20170930/1506737915912892.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>32</p>
<p><span style="font-family:宋体">上述代码中，【１】的</span>ext_len<span style="font-family:宋体">从数据包中获得，没有长度的检查，可为任意值。而当</span>control_type<span style="font-family:宋体">为一个非法值的时候，会走到【２】</span>,<span style="font-family:宋体">那么这里就很有说法了，我们如果设置</span>ext_len<span style="font-family:宋体">比较大，那么这里就会发生一个整数下溢。从而使得</span>rem_len<span style="font-family:宋体">变成一个很大的</span>uint16_t<span style="font-family:宋体">的值。这个值将会影响后续的处理：</span></p>
<p><img title="1506737924688796.png" alt="33.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737924688796.png"/><noscript><img title="1506737924688796.png" alt="33.png" src="/uploads/20170930/1506737924688796.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>33</p>
<p><span style="font-family:宋体">上面的代码中，【１】处将发生整数下溢出，使得</span>rem_len<span style="font-family:宋体">成为一个很大的值（比如</span>0xfffd<span style="font-family:宋体">），【２】处会将这个值赋值给</span>p_buf-&gt;len<span style="font-family:宋体">。【３】处是回调函数处理这个</span>p_buf<span style="font-family:宋体">，在</span>BlueDroid<span style="font-family:宋体">中这个函数是</span><strong>pan_data_buf_ind_cb</strong><span style="font-family:宋体">，这个函数会有一条路径调到</span><strong>bta_pan_data_buf_ind_cback</strong><span style="font-family:宋体">，而在这个函数中：</span></p>
<p><img title="1506737932948708.png" alt="34.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737932948708.png"/><noscript><img title="1506737932948708.png" alt="34.png" src="/uploads/20170930/1506737932948708.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>34</p>
<p>memcpy<span style="font-family:宋体">用到了我们传进来的</span>pbuf<span style="font-family:宋体">，而</span><strong>pbuf-&gt;len</strong><span style="font-family:宋体">是刚刚下溢之后的很大的值，所以主要保证</span><strong>tBTA_PAN_DATA_PARAMS&gt; pbuf-&gt;offset</strong><span style="font-family:宋体">，这里就会发生一次很大字节的堆溢出。</span></p>
<p><span style="font-family:宋体">代码首先要走到</span>extension<span style="font-family:宋体">的处理，这个的前提是连接状态是</span>BNEP_STATE_CONNECTED<span style="font-family:宋体">。而这个状态的建立，需要服务端先接收一个正确的</span><strong>BNEP_SETUP_CONNECTION_REQUEST_MSG</strong><span style="font-family: 宋体">请求包，同时要想</span>pan_data_buf_ind_cb<span style="font-family:宋体">调用到</span>bta_pan_data_buf_ind_cback<span style="font-family:宋体">产生堆溢出，需要在建立连接的时候指定</span>UUID<span style="font-family:宋体">为</span><strong>UUID_SERV_CLASS_PANU</strong><span style="font-family:宋体">可以阅读这两个函数来找到这样做的原因，这里就不再贴代码了。清楚这一点之后，我们就可以构造我们的</span>poc<span style="font-family:宋体">了：</span>&nbsp;</p>
<p><span style="font-family:宋体">１，建立</span>BNEP<span style="font-family:宋体">连接，这里只是建立起初步的连接，</span>conn_state<span style="font-family:宋体">还不是</span><strong>BNEP_STATE_CONNECTED</strong><span style="font-family:宋体">，这一步通过</span>connect<span style="font-family:宋体">实现</span>&nbsp;</p>
<p><span style="font-family:宋体">２，发送一个正确的</span><strong>BNEP_SETUP_CONNECTION_REQUEST_MSG</strong><span style="font-family: 宋体">请求包，同时指定</span>UUID<span style="font-family:宋体">为</span>UUID_SERV_CLASS_PANU<span style="font-family:宋体">。这个包将是这样子：</span></p>
<p><img title="1506737941889803.png" alt="35.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737941889803.png"/><noscript><img title="1506737941889803.png" alt="35.png" src="/uploads/20170930/1506737941889803.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>35</p>
<p>3<span style="font-family:宋体">，发送一个</span>extension<span style="font-family:宋体">字段可导致整数下溢的包，而且注意控制</span>pbuf-&gt;offset<span style="font-family:宋体">变得比较小：</span>&nbsp;</p>
<p><img title="1506737949386823.png" alt="36.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170930/1506737949386823.png"/><noscript><img title="1506737949386823.png" alt="36.png" src="/uploads/20170930/1506737949386823.png"/></noscript></p>
<p style="text-align: center;"><span style="font-family:宋体">图</span>36</p>
<p><span style="font-family:宋体">这样</span>PoC<span style="font-family:宋体">就完成了。</span>&nbsp;<strong>CVE-2017-0781</strong><span style="font-family:宋体">和</span><strong>CVE-2017-0782</strong><span style="font-family:宋体">导致了堆溢出，一般会使得</span><strong>com.android.bluetooth</strong><span style="font-family:宋体">崩溃，但是这个进程崩溃系统不会有提醒，需要去</span>logcat<span style="font-family:宋体">来找崩溃的日志。<strong>这是两个很有品质的堆溢出漏洞，结合前面的信息泄露漏洞，是完全可以转化为远程代码执行的。</strong></span></p>
<p><span style="font-size: 20px;"><strong>0x03</strong></span></p>
<p><span style="font-family:宋体">这篇分析到这里也就结束了，蓝牙出漏洞是个比较危险的事情，希望没有修补的能尽快修补，补丁链接如下：</span></p>
<p><a href="https://git.kernel.org/pub/scm/bluetooth/bluez.git/commit/?id=9e009647b14e810e06626dde7f1bb9ea3c375d09" target="_self">CVE-2017-1000250</a></p>
<p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e860d2c904d1a9f38a24eb44c9f34b8f915a6ea3" target="_self">CVE-2017-1000251</a></p>
<p><a href="https://android.googlesource.com/platform/system/bt/+/226ea26684d4cd609a5b456d3d2cc762453c2d75" target="_self">CVE-2017-0785</a></p>
<p><a href="https://android.googlesource.com/platform/system/bt/+/c513a8ff5cfdcc62cc14da354beb1dd22e56be0e" target="_self">CVE-2017-0781</a></p>
<p><a href="https://android.googlesource.com/platform/system/bt/+/4e47f3db62bab524946c46efe04ed6a2b896b150" target="_self">CVE-2017-0782</a></p>
<p><span style="font-family:宋体">确定自己是否有漏洞可以用我们提供的</span>poc<span style="font-family:宋体">呀，关于蓝牙漏洞的研究，也希望能和各位多多交流。</span></p>
<p><strong><span style="font-family:宋体">参考文档</span>:</strong></p>
<p>1,<a href="https://www.armis.com/blueborne/">https://www.armis.com/blueborne/</a>&nbsp;</p>
<p>2,<a href="http://blog.csdn.net/rain0993/article/details/8533246">http://blog.csdn.net/rain0993/article/details/8533246</a>&nbsp;</p>
<p>3,<a href="https://people.csail.mit.edu/albert/bluez-intro/index.html">https://people.csail.mit.edu/albert/bluez-intro/index.html</a>&nbsp;</p>
                <div class="foot_description" style="background-color: #fff;">
                    本文为 360安全卫士 授权嘶吼发布，如若转载，请注明原文地址：                        <a href="http://www.4hou.com/technology/7837.html" target=_blank>http://www.4hou.com/technology/7837.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="7837" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            0</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/technology/7837.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=7837' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Ftechnology%2F7837.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='360安全卫士' src='http://img.4hou.com/wp-content/uploads/2017/06/837963f5c83ace913607-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                                360安全卫士                                                            <i class="mem_level"></i>
                             </a></h1>
                        <p class="authorzybottom">360安全卫士官方账号</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=360安全卫士&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/technology/7837.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/466d0230010252c76d27.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/web/7678.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/e7f3d8cb8b2b457ad170.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/info/news/7640.html" target=_blank>
                                            <img data-original="/uploads/20170914/1505361302514047.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7579.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/5b720555de5a9a4f0d26.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="7837" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
      </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='360安全卫士' src='http://img.4hou.com/wp-content/uploads/2017/06/837963f5c83ace913607-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                    360安全卫士                                    <i class="mem_level"></i>
                </a></h1>
            <p class="article_author_type">360安全卫士官方账号 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=360安全卫士&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7839.html" target="_blank">如何在世界上戒备最森严的地方窃取信息？NSA绝密文件泄漏过程曝光</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7828.html" target="_blank">银行木马Retefe变种通过“永恒之蓝”漏洞感染多国银行网站</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7837.html" target="_blank">BlueBorne 蓝牙漏洞深入分析与PoC</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/industry/7836.html" target="_blank">占便宜没够，看看优惠券中的欺诈套路</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/5725.html" target="_blank">恶意软件中的符号解析</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script type="text/javascript"  src="//idm-su.baidu.com/su.js"></script>
</body>
</html>