<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>“隐魂”木马篡改主页分析：史上反侦察力最强木马的犯罪素描 - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="前不久，360安全中心率先发布了MBR木马——“隐魂”的预警，对木马入侵过程分析（史上反侦察力最强木马“隐魂”：撑起色情播放器百万推广陷阱）后发现，“隐魂”的反侦察能力极高，堪称迄今最复杂的MBR木马。360安全中心随…" />
    <meta name="keywords" content="" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">“隐魂”木马篡改主页分析：史上反侦察力最强木马的犯罪素描</h1>
                <p class="art_time">2017年10月1日发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/technology">技术</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>51,373</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>2</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>前不久，360安全中心率先发布了MBR木马——“隐魂”的预警，对木马入侵过程分析（史上反侦察力最强木马“隐魂”：撑起色情播放器百万推广陷阱后发现，“隐魂”的反侦察能力极高，堪称迄今最复杂的MBR木马。</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p>前不久，360安全中心率先发布了MBR木马——“隐魂”的预警，对木马入侵过程分析（史上反侦察力最强木马“隐魂”：撑起色情播放器百万推广陷阱）后发现，“隐魂”的反侦察能力极高，堪称迄今最复杂的MBR木马。360安全中心随即对该木马展开了持续追踪，本篇是对其篡改主页的行为详细介绍。</p>
<p><span style="font-size: 20px"><strong>1摘要</strong></span></p>
<p>首先，我们来进一步了解“隐魂”木马的反侦察能力和复杂性。</p>
<p>（1）隐蔽性极高：“隐魂”木马会通过挂钩磁盘底层驱动实现自我保护，普通的ARK工具或查杀类工具无法深入磁盘底层，难以有效检测到MBR被修改；同时，应用层代码在TimerQueue中调度，目前除了利用调试器进行反复测试外，根本没有其他方法能检测该系统触发机制；另外，内核LoadImage挂钩代码在Nt节的空白区域，这部分在未知内存区域执行的代码也是检测工具的一大盲区。</p>
<p>（2）对抗性极强：为了与检测工具及杀软对抗，“隐魂”使用签名和PDB文件名方式，禁止一系列驱动加载，即使加载成功相关功能函数也会被IAT挂钩。</p>
<p>（3）兼容性极高：“隐魂”是目前支持系统范围最广的MBR木马，从Windows XP到Win10X64位最新系统的均支持，兼容性远远超过2016年开始活跃的暗云Ⅲ木马。</p>
<p>其次，我们再来说一下“隐魂”木马在篡改主页时是如何清理犯罪现场的。</p>
<p>（1）声东击西：不同于直接在浏览器进程中添加参数的劫持方式，“隐魂”为了躲避查杀，采取了结束原浏览器进程——创建新的系统进程——再创建新浏览器进程的方式绕了个大圈才完成主页篡改。</p>
<p>（2）釜底抽薪：“隐魂”会把大多数杀软的正常挂钩全部抹掉，使得浏览器主页失去安全类软件的保护。</p>
<p>接下来，将从WindowsNt系统加载前 (BootKit) 、系统加载后(RootKit)、注入桌面进程explorer</p>
<p>改首页共三部分对木马的执行流程进行详细分析。</p>
<p><span style="font-size: 20px"><strong>2 NT系统加载前</strong></span></p>
<p><strong>2.1 MBR部分</strong></p>
<p>将自身代码拷贝到 0x600处执行。</p>
<p style="text-align: center"><img title="1503051535141890.png" alt="1.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051535141890.png" /><noscript><img title="1503051535141890.png" alt="1.png" src="/uploads/20170818/1503051535141890.png" /></noscript></p>
<p style="text-align: center">图1</p>
<p>而后使用int 13 42扩展读功能读取0x1个扇区 到 0x7c00，</p>
<p>位置是由bp指定的。</p>
<p style="text-align: center"><img title="1503051543517374.png" alt="2.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051543517374.png" /><noscript><img title="1503051543517374.png" alt="2.png" src="/uploads/20170818/1503051543517374.png" /></noscript></p>
<p style="text-align: center">图2</p>
<p>读取：</p>
<p style="text-align: center"><img title="1503051549606299.png" alt="3.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051549606299.png" /><noscript><img title="1503051549606299.png" alt="3.png" src="/uploads/20170818/1503051549606299.png" /></noscript></p>
<p style="text-align: center">图3</p>
<p>而后跳转到 0x7c00处继续执行。</p>
<p style="text-align: center"><img title="1503051558908412.png" alt="4.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051558908412.png" /><noscript><img title="1503051558908412.png" alt="4.png" src="/uploads/20170818/1503051558908412.png" /></noscript></p>
<p style="text-align: center">图4</p>
<p>跳转:</p>
<p style="text-align: center"><img title="1503051565624228.png" alt="5.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051565624228.png" /><noscript><img title="1503051565624228.png" alt="5.png" src="/uploads/20170818/1503051565624228.png" /></noscript></p>
<p style="text-align: center">图5</p>
<p>并将自身代码再次拷贝到0x600处执行:</p>
<p style="text-align: center"><img title="1503051572702347.png" alt="6.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051572702347.png" /><noscript><img title="1503051572702347.png" alt="6.png" src="/uploads/20170818/1503051572702347.png" /></noscript></p>
<p style="text-align: center">图6</p>
<p>这次相同位置连续读取 0x20个扇区：</p>
<p style="text-align: center"><img title="1503051580368934.png" alt="7.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051580368934.png" /><noscript><img title="1503051580368934.png" alt="7.png" src="/uploads/20170818/1503051580368934.png" /></noscript></p>
<p style="text-align: center">图7</p>
<p>定位位置:</p>
<p style="text-align: center"><img title="1503051587410758.png" alt="8.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051587410758.png" /><noscript><img title="1503051587410758.png" alt="8.png" src="/uploads/20170818/1503051587410758.png" /></noscript></p>
<p style="text-align: center">图8</p>
<p>读取20个扇区:</p>
<p style="text-align: center"><img title="1503051596625926.png" alt="9.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051596625926.png" /><noscript><img title="1503051596625926.png" alt="9.png" src="/uploads/20170818/1503051596625926.png" /></noscript></p>
<p style="text-align: center">图9</p>
<p>然后将代码拷贝到 0x101000 大小为0x1400。</p>
<p style="text-align: center"><img title="1503051604585464.png" alt="10.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051604585464.png" /><noscript><img title="1503051604585464.png" alt="10.png" src="/uploads/20170818/1503051604585464.png" /></noscript></p>
<p style="text-align: center">图10</p>
<p>而后跳转到 0x10100处执行:</p>
<p style="text-align: center"><img title="1503051613960503.png" alt="11.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051613960503.png" /><noscript><img title="1503051613960503.png" alt="11.png" src="/uploads/20170818/1503051613960503.png" /></noscript></p>
<p style="text-align: center">图11</p>
<p>然后预留高端地址0x14 = 20KB页面&nbsp; 用来存放代码。</p>
<p style="text-align: center"><img title="1503051620985730.png" alt="12.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051620985730.png" /><noscript><img title="1503051620985730.png" alt="12.png" src="/uploads/20170818/1503051620985730.png" /></noscript></p>
<p style="text-align: center">图12</p>
<p>将自身代码拷贝到高端地址:</p>
<p style="text-align: center"><img title="1503051627309867.png" alt="13.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051627309867.png" /><noscript><img title="1503051627309867.png" alt="13.png" src="/uploads/20170818/1503051627309867.png" /></noscript></p>
<p style="text-align: center">图13</p>
<p>跳转到 0x9a400 处执行挂钩代码。</p>
<p style="text-align: center"><img title="1503051681419947.png" alt="14.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051681419947.png" /><noscript><img title="1503051681419947.png" alt="14.png" src="/uploads/20170818/1503051681419947.png" /></noscript></p>
<p style="text-align: center">图14</p>
<p>然后挂钩int13中断:</p>
<p style="text-align: center"><img title="1503051689636507.png" alt="15.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051689636507.png" /><noscript><img title="1503051689636507.png" alt="15.png" src="/uploads/20170818/1503051689636507.png" /></noscript></p>
<p style="text-align: center">图15</p>
<p>挂钩后：</p>
<p style="text-align: center"><img title="1503051697191581.png" alt="16.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051697191581.png" /><noscript><img title="1503051697191581.png" alt="16.png" src="/uploads/20170818/1503051697191581.png" /></noscript></p>
<p style="text-align: center">图16</p>
<p>挂钩处代码为 0x9a400 +&nbsp; 45 = 0x9a445。</p>
<p style="text-align: center"><img title="1503051704690977.png" alt="17.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051704690977.png" /><noscript><img title="1503051704690977.png" alt="17.png" src="/uploads/20170818/1503051704690977.png" /></noscript></p>
<p style="text-align: center">图17</p>
<p><strong>2.2 Int13挂钩部分</strong></p>
<p>Int13挂钩中断被执行，搜索硬编码并挂钩:</p>
<p style="text-align: center"><img title="1503051712664418.png" alt="18.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051712664418.png" /><noscript><img title="1503051712664418.png" alt="18.png" src="/uploads/20170818/1503051712664418.png" /></noscript></p>
<p style="text-align: center">图18</p>
<p>挂钩函数为:</p>
<p style="text-align: center"><img title="1503051719948864.png" alt="19.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051719948864.png" /><noscript><img title="1503051719948864.png" alt="19.png" src="/uploads/20170818/1503051719948864.png" /></noscript></p>
<p style="text-align: center">图19</p>
<p>挂钩后函数被修改为:</p>
<p style="text-align: center"><img title="1503051727476858.png" alt="20.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051727476858.png" /><noscript><img title="1503051727476858.png" alt="20.png" src="/uploads/20170818/1503051727476858.png" /></noscript></p>
<p style="text-align: center">图20</p>
<p><strong>2.3 BootMgr部分</strong></p>
<p>当系统控制权交给BootMgr 16位代码后，</p>
<p>准备转移给32位代码执行时挂钩中断被执行。</p>
<p>相关函数为：</p>
<p style="text-align:center"><img title="1503051734695361.png" alt="21.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051734695361.png" /><noscript><img title="1503051734695361.png" alt="21.png" src="/uploads/20170818/1503051734695361.png" /></noscript></p>
<p style="text-align: center">图21</p>
<p>跳转：</p>
<p>然后直接搜0x400000 地址 并挂钩</p>
<p style="text-align: center"><img title="1503051742971276.png" alt="22.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051742971276.png" /><noscript><img title="1503051742971276.png" alt="22.png" src="/uploads/20170818/1503051742971276.png" /></noscript></p>
<p style="text-align: center">图22</p>
<p>从BootMgr PE节信息中搜可执行代码，自带反汇编引擎搜索ImgpLoadPEImage对&nbsp; LdrRelocateImageWithBias的调用，然后Patch对该函数调用。</p>
<p>挂钩前该处调用为:</p>
<p style="text-align: center"><img title="1503051751442394.png" alt="23.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051751442394.png" /><noscript><img title="1503051751442394.png" alt="23.png" src="/uploads/20170818/1503051751442394.png" /></noscript></p>
<p style="text-align: center">图23</p>
<p>特征码为：</p>
<p style="text-align: center"><img title="1503051758472169.png" alt="24.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051758472169.png" /><noscript><img title="1503051758472169.png" alt="24.png" src="/uploads/20170818/1503051758472169.png" /></noscript></p>
<p style="text-align: center">图24</p>
<p>搜到后 特征码 0xc0000221 及 0x20B后，</p>
<p>找到下一个Call调用 机器码为0xE8且指令长度为5即为搜索成功。</p>
<p style="text-align: center"><img title="1503051765789489.png" alt="25.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051765789489.png" /><noscript><img title="1503051765789489.png" alt="25.png" src="/uploads/20170818/1503051765789489.png" /></noscript></p>
<p style="text-align: center">图25</p>
<p>后挂钩 ：</p>
<p style="text-align: center"><img title="1503051773981625.png" alt="26.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051773981625.png" /><noscript><img title="1503051773981625.png" alt="26.png" src="/uploads/20170818/1503051773981625.png" /></noscript></p>
<p style="text-align: center">图26</p>
<p>挂钩后调用为：</p>
<p style="text-align: center"><img title="1503051780118650.png" alt="27.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051780118650.png" /><noscript><img title="1503051780118650.png" alt="27.png" src="/uploads/20170818/1503051780118650.png" /></noscript></p>
<p style="text-align: center">图27</p>
<p>Winload挂钩函数为：</p>
<p style="text-align:center"><img title="1503051788103543.png" alt="28.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051788103543.png" /><noscript><img title="1503051788103543.png" alt="28.png" src="/uploads/20170818/1503051788103543.png" /></noscript></p>
<p style="text-align: center">图28</p>
<p><strong>2.4 WinLoad部分</strong></p>
<p>当系统执行到bootmgr!BmpTransferExecution&nbsp; 将控制权转移给Winload时候，</p>
<p>挂钩函数HookWinLoad被执行。</p>
<p>先将 LdrRelocateImageWithBias 函数地址放置在堆栈上，等挂钩Winload函数执行完毕后就</p>
<p>调用LdrRelocateImageWithBias 接着执行原来的流程。</p>
<p>后续的挂钩执行都是如此，并未恢复原先代码。</p>
<p>&nbsp;</p>
<p style="text-align:center"><img title="1503051795499109.png" alt="29.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051795499109.png" /><noscript><img title="1503051795499109.png" alt="29.png" src="/uploads/20170818/1503051795499109.png" /></noscript></p>
<p style="text-align: center">图29</p>
<p>调用为：</p>
<p style="text-align:center"><img title="1503051803783672.png" alt="30.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051803783672.png" /><noscript><img title="1503051803783672.png" alt="30.png" src="/uploads/20170818/1503051803783672.png" /></noscript></p>
<p style="text-align: center">图30</p>
<p>按系统分别挂钩：</p>
<p style="text-align:center"><img title="1503051810394355.png" alt="31.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051810394355.png" /><noscript><img title="1503051810394355.png" alt="31.png" src="/uploads/20170818/1503051810394355.png" /></noscript></p>
<p style="text-align: center">图31</p>
<p>然后同样是搜索ImgpLoadPEImage对&nbsp; LdrRelocateImageWithBias的调用，然后Patch对该函数调用，该部分代码同BootMgr一样。</p>
<p>挂钩后函数为:</p>
<p style="text-align: center"><img title="1503051818671179.png" alt="32.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051818671179.png" /><noscript><img title="1503051818671179.png" alt="32.png" src="/uploads/20170818/1503051818671179.png" /></noscript></p>
<p style="text-align: center">图32</p>
<p>先将恢复对函数LdrRelocateImageWithBias的调用：</p>
<p style="text-align:center"><img title="1503051827867889.png" alt="33.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051827867889.png" /><noscript><img title="1503051827867889.png" alt="33.png" src="/uploads/20170818/1503051827867889.png" /></noscript></p>
<p style="text-align: center">图33</p>
<p>而后将 0x9aa9a函数放置在堆栈上等待被调用:</p>
<p style="text-align:center"><img title="1503051836684016.png" alt="34.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051836684016.png" /><noscript><img title="1503051836684016.png" alt="34.png" src="/uploads/20170818/1503051836684016.png" /></noscript></p>
<p style="text-align: center">图34</p>
<p>LdrRelocateImageWithBias调用完成后 HooNt函数被执行(0x9aa9a)：</p>
<p><img title="1503051849182646.png" alt="35.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051849182646.png" /><noscript><img title="1503051849182646.png" alt="35.png" src="/uploads/20170818/1503051849182646.png" /></noscript></p>
<p style="text-align: center">图35</p>
<p>先恢复堆栈 后续执行流程 将winload!ImgpLoadPEImage+0x67d 放置在返回地址处：</p>
<p style="text-align: center"><img title="1503051882270782.png" alt="36.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051882270782.png" /><noscript><img title="1503051882270782.png" alt="36.png" src="/uploads/20170818/1503051882270782.png" /></noscript></p>
<p style="text-align: center">图36</p>
<p>通过反汇编引擎搜调用代码 搜IoInitSystem 对 IopInitializeBootDrivers的调用。</p>
<p style="text-align: center"><img title="1503051889476911.png" alt="37.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051889476911.png" /><noscript><img title="1503051889476911.png" alt="37.png" src="/uploads/20170818/1503051889476911.png" /></noscript></p>
<p style="text-align: center">图37</p>
<p><span style="font-size: 20px"><strong>3 NT系统加载后</strong></span></p>
<p><strong>3.1 加载ShellCode部分</strong></p>
<p>当系统执行到 Nt 中 IoInitSystem&nbsp; 对 IopInitializeBootDrivers调用时候，恶意代码被执行。</p>
<p>先将函数 IopInitializeBootDrivers 放置堆栈上，然后关闭写保护恢复原始挂钩处代码，而后将后续加载木马代码函数地址（LoadTheShellCode）放置堆栈上。</p>
<p style="text-align: center"><img title="1503051899231760.png" alt="38.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051899231760.png" /><noscript><img title="1503051899231760.png" alt="38.png" src="/uploads/20170818/1503051899231760.png" /></noscript></p>
<p style="text-align: center">图38</p>
<p>当函数IopInitializeBootDrivers 调用完成后， 再次将Nt正确函数返回地址放置堆栈上。</p>
<p style="text-align: center"><img title="1503051912197868.png" alt="39.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051912197868.png" /><noscript><img title="1503051912197868.png" alt="39.png" src="/uploads/20170818/1503051912197868.png" /></noscript></p>
<p style="text-align: center">图39</p>
<p>而后将ShllCode1代码映射， 大小为0xca0。</p>
<p style="text-align: center"><img title="1503051923128573.png" alt="40.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051923128573.png" /><noscript><img title="1503051923128573.png" alt="40.png" src="/uploads/20170818/1503051923128573.png" /></noscript></p>
<p style="text-align: center">图40</p>
<p>校验代码并执行。</p>
<p><strong>3.2 ShellCode1部分</strong></p>
<p>该部分功能为读取磁盘指定位置代码并加载ShellCode2。</p>
<p>先获取相关函数地址，</p>
<p>后读取磁盘数据 检测完整并获取大小， 大小为0x4a000。</p>
<p style="text-align: center"><img title="1503051930586659.png" alt="41.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051930586659.png" /><noscript><img title="1503051930586659.png" alt="41.png" src="/uploads/20170818/1503051930586659.png" /></noscript></p>
<p style="text-align: center">图41</p>
<p>然后为第二块ShellCode申请内存 大小为 0x4c08。</p>
<p>申请后执行：</p>
<p style="text-align:center"><img title="1503051937399287.png" alt="42.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051937399287.png" /><noscript><img title="1503051937399287.png" alt="42.png" src="/uploads/20170818/1503051937399287.png" /></noscript></p>
<p style="text-align: center">图42</p>
<p><strong>3.3 ShellCode2部分</strong></p>
<p>该部分主要为解压之前读取的资源数据并查找加载其中/bin/i386/bootmgr NE文件并加载。</p>
<p>校验完整性 ，并解压数据:</p>
<p style="text-align: center"><img title="1503051945420500.png" alt="43.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051945420500.png" /><noscript><img title="1503051945420500.png" alt="43.png" src="/uploads/20170818/1503051945420500.png" /></noscript></p>
<p style="text-align: center">图43</p>
<p>然后为第三块NE 格式ShellCode申请空间 大小为0x1f00，准备执行，并将资源作为参数传入。</p>
<p style="text-align: center"><img title="1503051953744839.png" alt="44.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051953744839.png" /><noscript><img title="1503051953744839.png" alt="44.png" src="/uploads/20170818/1503051953744839.png" /></noscript></p>
<p style="text-align: center">图44</p>
<p><strong>3.4 ShellCode3部分</strong></p>
<p>主要为加载 /bin/i386/kernel 到内存并执行，Kenel部分为内核关键代码部分。</p>
<p style="text-align: center"><img title="1503051961286399.png" alt="45.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051961286399.png" /><noscript><img title="1503051961286399.png" alt="45.png" src="/uploads/20170818/1503051961286399.png" /></noscript></p>
<p style="text-align: center">图45</p>
<p>拷贝NE文件资源，大小为0x10380：</p>
<p style="text-align: center"><img title="1503051984950487.png" alt="46.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051984950487.png" /><noscript><img title="1503051984950487.png" alt="46.png" src="/uploads/20170818/1503051984950487.png" /></noscript></p>
<p style="text-align: center">图46</p>
<p>而后帮第四块ShellCode修正导入表重定位并执行。</p>
<p>&nbsp;</p>
<p style="text-align: center"><img title="1503051994925224.png" alt="47.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503051994925224.png" /><noscript><img title="1503051994925224.png" alt="47.png" src="/uploads/20170818/1503051994925224.png" /></noscript></p>
<p style="text-align: center">图47</p>
<p><strong>3.5 ShellCode4部分</strong></p>
<p>该部分为内核关键代码，包含注入代码挂钩LoadImage 反内核调试代码。</p>
<p>入口出先断开内核调试：</p>
<p style="text-align: center"><img title="1503052002974558.png" alt="48.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052002974558.png" /><noscript><img title="1503052002974558.png" alt="48.png" src="/uploads/20170818/1503052002974558.png" /></noscript></p>
<p style="text-align: center">图48</p>
<p>而后读取磁盘数据并保存：</p>
<p style="text-align: center"><img title="1503052009191619.png" alt="49.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052009191619.png" /><noscript><img title="1503052009191619.png" alt="49.png" src="/uploads/20170818/1503052009191619.png" /></noscript></p>
<p style="text-align: center">图49</p>
<p>创建设备跟应用层交互：</p>
<p style="text-align: center"><img title="1503052017901348.png" alt="50.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052017901348.png" /><noscript><img title="1503052017901348.png" alt="50.png" src="/uploads/20170818/1503052017901348.png" /></noscript></p>
<p style="text-align: center">图50</p>
<p>而后重载内核获取一些导出符号，占满情况下，用于清理挂钩回调:</p>
<p style="text-align: center"><img title="1503052025946815.png" alt="51.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052025946815.png" /><noscript><img title="1503052025946815.png" alt="51.png" src="/uploads/20170818/1503052025946815.png" /></noscript></p>
<p style="text-align: center">图51</p>
<p>设置LoadImage回调 主要后续用于APC注入svchost跟explorer用来修改用户主页。</p>
<p>将真正函数地址LoadImageNotify作为参数传入。</p>
<p style="text-align: center"><img title="1503052033371311.png" alt="52.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052033371311.png" /><noscript><img title="1503052033371311.png" alt="52.png" src="/uploads/20170818/1503052033371311.png" /></noscript></p>
<p style="text-align: center">图52</p>
<p>查找节后面空闲区域 ，将自身挂钩代码拷贝过去。</p>
<p style="text-align:center"><img title="1503052039855597.png" alt="53.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052039855597.png" /><noscript><img title="1503052039855597.png" alt="53.png" src="/uploads/20170818/1503052039855597.png" /></noscript></p>
<p style="text-align: center">图53</p>
<p>拷贝代码：</p>
<p style="text-align: center"><img title="1503052047127802.png" alt="54.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052047127802.png" /><noscript><img title="1503052047127802.png" alt="54.png" src="/uploads/20170818/1503052047127802.png" /></noscript></p>
<p style="text-align: center">图54</p>
<p>代码为：</p>
<p style="text-align: center"><img title="1503052055361575.png" alt="55.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052055361575.png" /><noscript><img title="1503052055361575.png" alt="55.png" src="/uploads/20170818/1503052055361575.png" /></noscript></p>
<p style="text-align: center">图55</p>
<p>其中AAAAAAAA 为占位后续将填入实际地址。</p>
<p>然后加载第五块ShellCode,并且挂钩：</p>
<p style="text-align: center"><img title="1503052063767731.png" alt="56.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052063767731.png" /><noscript><img title="1503052063767731.png" alt="56.png" src="/uploads/20170818/1503052063767731.png" /></noscript></p>
<p style="text-align: center">图56</p>
<p>而该挂钩会反复被检测执行:</p>
<p style="text-align: center"><img title="1503052070249400.png" alt="57.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052070249400.png" /><noscript><img title="1503052070249400.png" alt="57.png" src="/uploads/20170818/1503052070249400.png" /></noscript></p>
<p style="text-align: center">图57</p>
<p>挂钩函数为：</p>
<p style="text-align: center"><img title="1503052130331517.png" alt="58.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052130331517.png" /><noscript><img title="1503052130331517.png" alt="58.png" src="/uploads/20170818/1503052130331517.png" /></noscript></p>
<p style="text-align: center">图58</p>
<p>LoadImage中判断svchost.exe进程创建:</p>
<p style="text-align: center"><img title="1503052094243437.png" alt="59.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052094243437.png" /><noscript><img title="1503052094243437.png" alt="59.png" src="/uploads/20170818/1503052094243437.png" /></noscript></p>
<p style="text-align: center">图59</p>
<p>如果是svchost.exe进程创建：</p>
<p style="text-align: center"><img title="1503052140418169.png" alt="60.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052140418169.png" /><noscript><img title="1503052140418169.png" alt="60.png" src="/uploads/20170818/1503052140418169.png" /></noscript></p>
<p style="text-align: center">图60</p>
<p>判断是否为指定的svchost.exe：</p>
<p style="text-align: center"><img title="1503052152677473.png" alt="61.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052152677473.png" /><noscript><img title="1503052152677473.png" alt="61.png" src="/uploads/20170818/1503052152677473.png" /></noscript></p>
<p style="text-align: center">图 61</p>
<p>主要通过命令行方式判断：</p>
<p style="text-align: center"><img title="1503052179338085.png" alt="62.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052179338085.png" /><noscript><img title="1503052179338085.png" alt="62.png" src="/uploads/20170818/1503052179338085.png" /></noscript></p>
<p style="text-align: center">图62</p>
<p>匹配命令行后准备注入代码：</p>
<p style="text-align: center"><img title="1503052189343429.png" alt="63.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052189343429.png" /><noscript><img title="1503052189343429.png" alt="63.png" src="/uploads/20170818/1503052189343429.png" /></noscript></p>
<p style="text-align: center">图63</p>
<p>将APC&nbsp; NormalRoutine设置为Ne 入口点 得到执行：</p>
<p style="text-align: center"><img title="1503052206750938.png" alt="64.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052206750938.png" /><noscript><img title="1503052206750938.png" alt="64.png" src="/uploads/20170818/1503052206750938.png" /></noscript></p>
<p style="text-align: center">图64</p>
<p>Exploer注入代码：</p>
<p style="text-align: center"><img title="1503052216822833.png" alt="65.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052216822833.png" /><noscript><img title="1503052216822833.png" alt="65.png" src="/uploads/20170818/1503052216822833.png" /></noscript></p>
<p style="text-align: center">图65</p>
<p><strong>3.6 ShellCode5部分</strong></p>
<p>该内核块功能主要为防止被检出查杀。</p>
<p>获取签名公司列表信息：</p>
<p></p>
<p style="text-align: center"><img title="1503052225640415.png" alt="66.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052225640415.png" /><noscript><img title="1503052225640415.png" alt="66.png" src="/uploads/20170818/1503052225640415.png" /></noscript></p>
<p style="text-align: center">图66</p>
<p>代码：</p>
<p style="text-align: center"><img title="1503052232993095.png" alt="67.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052232993095.png" /><noscript><img title="1503052232993095.png" alt="67.png" src="/uploads/20170818/1503052232993095.png" /></noscript></p>
<p style="text-align: center">图67</p>
<p>而后调用ShellCode4中设置LoadImage回调函数。</p>
<p>&nbsp;</p>
<p style="text-align: center"><img title="1503052241936802.png" alt="68.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052241936802.png" /><noscript><img title="1503052241936802.png" alt="68.png" src="/uploads/20170818/1503052241936802.png" /></noscript></p>
<p style="text-align: center">图68</p>
<p>在回调中判断驱动是否有PDB信息，分三种情况Patch</p>
<p>1 如果没有PDB符号信息且匹配签名 则直接Patch入口点。</p>
<p>&nbsp;</p>
<p style="text-align: center"><img title="1503052247204840.png" alt="69.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052247204840.png" /><noscript><img title="1503052247204840.png" alt="69.png" src="/uploads/20170818/1503052247204840.png" /></noscript></p>
<p style="text-align: center">图69</p>
<p>2 如果有PDB信息，一些常见的工具，也Patch入口点，如gmer.pdb ,Win64AST.pdb。</p>
<p style="text-align: center"><img title="1503052258795859.png" alt="70.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052258795859.png" /><noscript><img title="1503052258795859.png" alt="70.png" src="/uploads/20170818/1503052258795859.png" /></noscript></p>
<p style="text-align: center">图70</p>
<p>3 如果Pdb有 且hash 比对一致则导入表 Hook：</p>
<p>&nbsp;</p>
<p style="text-align: center"><img title="1503052265757545.png" alt="71.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052265757545.png" /><noscript><img title="1503052265757545.png" alt="71.png" src="/uploads/20170818/1503052265757545.png" /></noscript></p>
<p style="text-align: center">图71</p>
<p>还会IAT Hook文件操作函数，防止查杀类驱动读取文件恢复钩子。</p>
<p>ZwCreateFile:</p>
<p style="text-align: center"><img title="1503052272741770.png" alt="72.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052272741770.png" /><noscript><img title="1503052272741770.png" alt="72.png" src="/uploads/20170818/1503052272741770.png" /></noscript></p>
<p style="text-align: center">图72</p>
<p>IofCallDriver:</p>
<p style="text-align:center"><img title="1503052280994243.png" alt="73.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052280994243.png" /><noscript><img title="1503052280994243.png" alt="73.png" src="/uploads/20170818/1503052280994243.png" /></noscript></p>
<p style="text-align: center">图73</p>
<p>防止文件簇读取方式：</p>
<p style="text-align: center"><img title="1503052290683561.png" alt="74.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052290683561.png" /><noscript><img title="1503052290683561.png" alt="74.png" src="/uploads/20170818/1503052290683561.png" /></noscript></p>
<p style="text-align: center">图74</p>
<p>获取文件保护列表函数：</p>
<p style="text-align: center"><img title="1503052297709591.png" alt="75.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052297709591.png" /><noscript><img title="1503052297709591.png" alt="75.png" src="/uploads/20170818/1503052297709591.png" /></noscript></p>
<p style="text-align: center">图75</p>
<p>Patch函数：</p>
<p style="text-align: center"><img title="1503052305893101.png" alt="76.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052305893101.png" /><noscript><img title="1503052305893101.png" alt="76.png" src="/uploads/20170818/1503052305893101.png" /></noscript></p>
<p style="text-align: center">图76</p>
<p style="text-align: center"><img title="1503052312416370.png" alt="77.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052312416370.png" /><noscript><img title="1503052312416370.png" alt="77.png" src="/uploads/20170818/1503052312416370.png" /></noscript></p>
<p style="text-align: center">图 77</p>
<p><span style="font-size: 20px"><strong>4 篡改主页部分</strong></span></p>
<p><strong>4.1 ShellCode1部分</strong></p>
<p>APC注入Explorer.exe后，入口点修正导入表 ，创建线程并加载改首页模块。</p>
<p style="text-align: center"><img title="1503052320245121.png" alt="78.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052320245121.png" /><noscript><img title="1503052320245121.png" alt="78.png" src="/uploads/20170818/1503052320245121.png" /></noscript></p>
<p style="text-align: center">图78</p>
<p>线程函数中申请执行空间，并将代码拷贝。</p>
<p>高端地址执行：</p>
<p style="text-align: center"><img title="1503052328971668.png" alt="79.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052328971668.png" /><noscript><img title="1503052328971668.png" alt="79.png" src="/uploads/20170818/1503052328971668.png" /></noscript></p>
<p style="text-align: center">图79</p>
<p>然后修正导入表，重定位：</p>
<p style="text-align:center"><img title="1503052337765922.png" alt="80.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052337765922.png" /><noscript><img title="1503052337765922.png" alt="80.png" src="/uploads/20170818/1503052337765922.png" /></noscript></p>
<p>&nbsp;</p>
<p style="text-align: center">图 80</p>
<p>执行入口点函数：</p>
<p style="text-align: center"><img title="1503052350141029.png" alt="81.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052350141029.png" /><noscript><img title="1503052350141029.png" alt="81.png" src="/uploads/20170818/1503052350141029.png" /></noscript></p>
<p style="text-align: center">图81</p>
<p><strong>4.2 ShellCode2部分</strong></p>
<p>初始化系统模块名字，挂钩时候使用：</p>
<p style="text-align: center"><img title="1503052399843202.png" alt="82.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052399843202.png" /><noscript><img title="1503052399843202.png" alt="82.png" src="/uploads/20170818/1503052399843202.png" /></noscript></p>
<p style="text-align: center">图82</p>
<p>初始化恢复钩子列表，发现这些函数一旦被挂钩就直接恢复。</p>
<p style="text-align: center"><img title="1503052411569538.png" alt="83.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052411569538.png" /><noscript><img title="1503052411569538.png" alt="83.png" src="/uploads/20170818/1503052411569538.png" /></noscript></p>
<p style="text-align: center">图83</p>
<p>将原始代码备份，并保存到链表中，头部指令最多长度为0x20。</p>
<p style="text-align: center"><img title="1503052425976074.png" alt="84.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052425976074.png" /><noscript><img title="1503052425976074.png" alt="84.png" src="/uploads/20170818/1503052425976074.png" /></noscript></p>
<p style="text-align: center">图84</p>
<p>然后打开首页页面地址：</p>
<p style="text-align: center"><img title="1503052434772145.png" alt="85.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052434772145.png" /><noscript><img title="1503052434772145.png" alt="85.png" src="/uploads/20170818/1503052434772145.png" /></noscript></p>
<p style="text-align: center">图 85</p>
<p>其中共享内存区数据为：</p>
<p style="text-align: center"><img title="1503052443157392.png" alt="86.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052443157392.png" /><noscript><img title="1503052443157392.png" alt="86.png" src="/uploads/20170818/1503052443157392.png" /></noscript></p>
<p style="text-align: center">图86</p>
<p>然后枚举所有加载模块 IAT挂钩CreateProcessW函数。</p>
<p style="text-align: center"><img title="1503052451564724.png" alt="87.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052451564724.png" /><noscript><img title="1503052451564724.png" alt="87.png" src="/uploads/20170818/1503052451564724.png" /></noscript></p>
<p style="text-align: center">图87</p>
<p>挂钩回调函数为：</p>
<p style="text-align:center"><img title="1503052461496164.png" alt="88.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052461496164.png" /><noscript><img title="1503052461496164.png" alt="88.png" src="/uploads/20170818/1503052461496164.png" /></noscript></p>
<p style="text-align: center">图88</p>
<p>主要挂钩Shell32.dll对CreateProcessW函数调用。而后检测之前的初始化的系统函数是否被Hook，进行恢复。</p>
<p style="text-align: center"><img title="1503052468790726.png" alt="89.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052468790726.png" /><noscript><img title="1503052468790726.png" alt="89.png" src="/uploads/20170818/1503052468790726.png" /></noscript></p>
<p style="text-align: center">图89</p>
<p>CreateProcessW挂钩中判断创建进程是否为浏览器列表之一：</p>
<p style="text-align: center"><img title="1503052475550816.png" alt="90.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052475550816.png" /><noscript><img title="1503052475550816.png" alt="90.png" src="/uploads/20170818/1503052475550816.png" /></noscript></p>
<p style="text-align: center">图90</p>
<p>浏览器列表为：</p>
<p style="text-align: center"><img title="1503052482681313.png" alt="91.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052482681313.png" /><noscript><img title="1503052482681313.png" alt="91.png" src="/uploads/20170818/1503052482681313.png" /></noscript></p>
<p style="text-align: center">图91</p>
<p>而后创建verclsid.exe 为傀儡进程，修改主页：</p>
<p style="text-align: center"><img title="1503052490587450.png" alt="92.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052490587450.png" /><noscript><img title="1503052490587450.png" alt="92.png" src="/uploads/20170818/1503052490587450.png" /></noscript></p>
<p style="text-align: center">图92</p>
<p>而后创建傀儡进程：</p>
<p style="text-align: center"><img title="1503052497584505.png" alt="93.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052497584505.png" /><noscript><img title="1503052497584505.png" alt="93.png" src="/uploads/20170818/1503052497584505.png" /></noscript></p>
<p style="text-align: center">图93</p>
<p>将代码映射到傀儡进程QueueUserAPC APC函数：</p>
<p style="text-align: center"><img title="1503052505698848.png" alt="94.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052505698848.png" /><noscript><img title="1503052505698848.png" alt="94.png" src="/uploads/20170818/1503052505698848.png" /></noscript></p>
<p style="text-align: center">图94</p>
<p><span style="font-size: 16px"><strong>4.3 ShellCode3部分</strong></span></p>
<p>该部分代码为QueueUserAPC 注入到 verclsid.exe 中执行。</p>
<p>入口点为从PEB LDR中获取信息，修正重定位修正导入表：</p>
<p style="text-align: center"><img title="1503052515234825.png" alt="95.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052515234825.png" /><noscript><img title="1503052515234825.png" alt="95.png" src="/uploads/20170818/1503052515234825.png" /></noscript></p>
<p style="text-align: center">图95</p>
<p>然后Patch傀儡进程入口点。</p>
<p style="text-align: center"><img title="1503052523422823.png" alt="96.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052523422823.png" /><noscript><img title="1503052523422823.png" alt="96.png" src="/uploads/20170818/1503052523422823.png" /></noscript></p>
<p style="text-align: center">图96</p>
<p>而后在调用CreateProcessW创建带有命令行的浏览器进程</p>
<p style="text-align: center"><img title="1503052530580034.png" alt="97.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052530580034.png" /><noscript><img title="1503052530580034.png" alt="97.png" src="/uploads/20170818/1503052530580034.png" /></noscript></p>
<p style="text-align: center">图97</p>
<p>完成修改主页：</p>
<p style="text-align: center"><img title="1503052538150182.png" alt="98.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052538150182.png" /><noscript><img title="1503052538150182.png" alt="98.png" src="/uploads/20170818/1503052538150182.png" /></noscript></p>
<p style="text-align: center">图98</p>
<p><strong>svshost部分</strong></p>
<p>主要为创建TimerQueue中 回写LoadImage回调并回写MBR：</p>
<p>该部分代码难以有效检出。</p>
<p>创建：</p>
<p style="text-align:center"><img title="1503052547431350.png" alt="99.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052547431350.png" /><noscript><img title="1503052547431350.png" alt="99.png" src="/uploads/20170818/1503052547431350.png" /></noscript></p>
<p style="text-align: center">图99</p>
<p>给驱动发送命令写入：</p>
<p style="text-align: center"><img title="1503052555116274.png" alt="100.png" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170818/1503052555116274.png" /><noscript><img title="1503052555116274.png" alt="100.png" src="/uploads/20170818/1503052555116274.png" /></noscript></p>
<p style="text-align: center">图100</p>
<p><span style="font-size: 20px"><strong>5 尾声</strong></span></p>
<p>“隐魂”木马创下了两周内攻击量上百万次的记录，可谓迄今传播速度最快的MBR木马。其高超的反侦察能力及复杂的利用技巧让不少检测手段力不从心，如今其攻势虽然放缓但远不曾停止，被推广利益驱使的作者很有可能继续兴风作浪，通过远程控制的方式实施对个人数据及财物的大规模攻击。</p>
                <div class="foot_description" style="background-color: #fff;">
                    本文为 360安全卫士 授权嘶吼发布，如若转载，请注明原文地址：                        <a href="http://www.4hou.com/technology/7327.html" target=_blank>http://www.4hou.com/technology/7327.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="7327" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            2</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/technology/7327.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=7327' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Ftechnology%2F7327.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='360安全卫士' src='http://img.4hou.com/wp-content/uploads/2017/06/837963f5c83ace913607-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                                360安全卫士                                                            <i class="mem_level"></i>
                             </a></h1>
                        <p class="authorzybottom">360安全卫士官方账号</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=360安全卫士&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/mobile/7911.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/10/7a78a3181ab22305db6d.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7327.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/dc66849a794865029375.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7837.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/466d0230010252c76d27.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/web/7678.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/e7f3d8cb8b2b457ad170.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="7327" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
      </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='360安全卫士' src='http://img.4hou.com/wp-content/uploads/2017/06/837963f5c83ace913607-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=360安全卫士" class="upload-img" target=_blank>
                    360安全卫士                                    <i class="mem_level"></i>
                </a></h1>
            <p class="article_author_type">360安全卫士官方账号 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=360安全卫士&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/system/7938.html" target="_blank">Authenticode签名伪造——针对文件类型的签名伪造</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/business/7974.html" target="_blank">爱奇艺业务安全风控体系的建设实践</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/tools/7968.html" target="_blank">如何使用Sysmon寻找带宏的Word恶意文档</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7946.html" target="_blank">新思科技评估IPhone X Face ID及生物识别系统的安全性</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7969.html" target="_blank">“中国菜刀”出海：有人用它从澳大利亚军方偷了30GB绝密数据</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script type="text/javascript"  src="//idm-su.baidu.com/su.js"></script>
</body>
</html>