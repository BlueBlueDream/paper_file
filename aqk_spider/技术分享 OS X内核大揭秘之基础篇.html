<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】OS X内核大揭秘之基础篇 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="macOS,内核"/>
    
        <meta name="description" content="虽然近年来的许多研究都集中在 Windows 操作系统上，但在安全性方面，iPhone 上的 iOS 和 MacBook 上的 macOS 操作系统也不容忽视。本文将介绍OS X内核的相关知识，为利用打下基础。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】OS X内核大揭秘之基础篇</h2>
                <div class="article-msg">
                    <span class="time">2017-10-09 12:07:33</span>
                    
                                        <span class="read">阅读：13842次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4501"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4501" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://theori.io/research/korean/osx-kernel-exploit-1"
                             target="_blank">来源： theori.io</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=145812086" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t010b843a7ca0ddf316.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=145812086" style="color:#848e99;">天鸽</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="white-space: normal; text-align: center;"><img src="http://p3.qhimg.com/t0135ab1ccd7f7c2399.jpg" title="t011814e74b9736b5cf.jpg" alt="http://p3.qhimg.com/t011814e74b9736b5cf.jpg"/></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">译者：</span><a href="http://bobao.360.cn/member/contribute?uid=145812086" target="_blank" style="text-decoration-line: none; color: rgb(0, 112, 192); line-height: 28px; font-weight: 900; font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">天鸽</a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">预估稿费：200RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="white-space: normal;"><span style="font-family: 微软雅黑, sans-serif;"></span><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">传送门</span></p><hr/><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/4500.html" target="_self" style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-weight: 900; font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">【技术分享】OS X内核大揭秘之利用篇</span></a></p><p style="text-indent: 2em;"><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">前言</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">虽然近年来的许</span><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">多研究都集中在 Windows 操作系统上，但在安全性方面，iPhone 上的 iOS 和 MacBook 上的 macOS 操作系统也不容忽视。在本系列博客中，我们将探讨 OS X 内核中的 bug 分析和漏洞利用技术。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（１）寻找内核bug</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以使用模糊测试和代码审计的方法找到在内核级执行中的 bug，如 <span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);"><strong>BSD</strong></span>、<strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);">Mach</span></strong> 和<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);"><strong> IOKit</strong></span>。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">BSD：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">内核的 BSD 部分提供了大多数系统调用、网络和文件系统的功能。源自 FreeBSD 5。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Mach：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">来自 CMU 开发的 Mach 3.0 微内核。实现了内核映射和 IPC 等基本服务。用户空间应用程序可以通过 Mach Trap 访问 Mach 服务。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">IOKit：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">IOKit 是一个用 C++ 编写的框架，它为 XNU 提供了驱动程序，而 Apple 提供了自己的运行时系统 libkern。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（２）初步利用</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">任意读／写可用于获取利用此漏洞必要的数据，或者在内核区域中创建任意数据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">由于每个 bug 都有自己独特的数据，所以应该读／写可以用于该漏洞利用的数据。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（３）内核权限获取和AAR/AAW</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了获得<strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);"> kernel_task</span></strong>(pid=0) 权限所需的值，我们先遍历内核中的所有进程以获取 ipc object 和 kernel task，然后将数据转储到用户空间。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">你可以使用它进行内核级的读／写。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（４）获得root权限</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于每个进程都被加载到内核内存中，所以我们可以捕获目标进程，并将下面的进程权限结构的 CR_RUID(Credential Real UID) 更改为 0。</span></p><pre class="brush:cpp;toolbar:false">[bsd/sys/ucred.h]
/*
&nbsp;*&nbsp;In-kernel&nbsp;credential&nbsp;structure.
&nbsp;*
&nbsp;*&nbsp;Note&nbsp;that&nbsp;this&nbsp;structure&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;outside&nbsp;the&nbsp;kernel,&nbsp;nor&nbsp;should
&nbsp;*&nbsp;it&nbsp;or&nbsp;copies&nbsp;of&nbsp;it&nbsp;be&nbsp;exported&nbsp;outside.
&nbsp;*/
struct&nbsp;ucred&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;TAILQ_ENTRY(ucred)&nbsp;&nbsp;cr_link;&nbsp;/*&nbsp;never&nbsp;modify&nbsp;this&nbsp;without&nbsp;KAUTH_CRED_HASH_LOCK&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;u_long&nbsp;&nbsp;cr_ref;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;reference&nbsp;count&nbsp;*/
struct&nbsp;posix_cred&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;/*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;credential&nbsp;hash&nbsp;depends&nbsp;on&nbsp;everything&nbsp;from&nbsp;this&nbsp;point&nbsp;on
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(see&nbsp;kauth_cred_get_hashkey)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;uid_t&nbsp;&nbsp;&nbsp;cr_uid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;effective&nbsp;user&nbsp;id&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;uid_t&nbsp;&nbsp;&nbsp;cr_ruid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;real&nbsp;user&nbsp;id&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;uid_t&nbsp;&nbsp;&nbsp;cr_svuid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;saved&nbsp;user&nbsp;id&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;short&nbsp;&nbsp;&nbsp;cr_ngroups;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;number&nbsp;of&nbsp;groups&nbsp;in&nbsp;advisory&nbsp;list&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;gid_t&nbsp;&nbsp;&nbsp;cr_groups[NGROUPS];&nbsp;/*&nbsp;advisory&nbsp;group&nbsp;list&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;gid_t&nbsp;&nbsp;&nbsp;cr_rgid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;real&nbsp;group&nbsp;id&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;gid_t&nbsp;&nbsp;&nbsp;cr_svgid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;saved&nbsp;group&nbsp;id&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;uid_t&nbsp;&nbsp;&nbsp;cr_gmuid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;UID&nbsp;for&nbsp;group&nbsp;membership&nbsp;purposes&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;cr_flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;flags&nbsp;on&nbsp;credential&nbsp;*/
}&nbsp;cr_posix;
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;label&nbsp;&nbsp;&nbsp;&nbsp;*cr_label;&nbsp;&nbsp;/*&nbsp;MAC&nbsp;label&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;/*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;NOTE:&nbsp;If&nbsp;anything&nbsp;else&nbsp;(besides&nbsp;the&nbsp;flags)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;added&nbsp;after&nbsp;the&nbsp;label,&nbsp;you&nbsp;must&nbsp;change
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;kauth_cred_find().
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;au_session&nbsp;cr_audit;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;user&nbsp;auditing&nbsp;data&nbsp;*/
};</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更改完成后，该进程将返回到 root 目录。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">于是，如果你运行 system(&quot;/bin/bash&quot;);，将可以获得 root 权限的 shell。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">背景知识</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Kernel Zone</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在 OS X 中，内核使用一个称为 Zone 的结构来分配堆。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Zone 使用 zalloc(zone) 和 kalloc(size) 进行分配，使用 zfree(zone,ptr) 和 kfree(ptr,size) 进行释放。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">当调用 kalloc 时，zalloc 在内部被调用。kalloc zone 可以通过 sudo zprint kalloc 找到。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">zone metadata：第一页中包含的 zone 信息有 size、page_count、alloc_element、free_element 等。</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">OOL(Out-Of-Line) Port</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在 IPC 通信中加载的非内联数据包</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">它保存在内核中，直到它收到 OOL 的数据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在做 OS X 内核利用时，可以通过 OOL 的 Leak 进行 fakeport 攻击。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">OS X 内核漏洞缓解技术</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">LASLR</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">引导时内核内存地址随机化</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Kext(Kernel Extension) 和内核共享相同的 kslide</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">旁路攻击：kslide地址计算（kslide=kernel_base - kernel text base)</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">DEP</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">防止内核中的 RWX 权限</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">旁路攻击：ROP</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">SMEP/SMAP</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Intel CPU 提供的内核内存保护计算</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">SMEP(Supervisor Mode Execution Protection)：无法在用户地址空间中执行内核代码</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">SMAP(Supervisor Mode Access Protection)：不允许在用户地址空间中访问内存。仅在支持的 CPU 体系结构上可用。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">旁路攻击：启用 ROP 绕过内核</span></p><p style="text-indent: 2em;"><span style="font-size: 18px; color: rgb(54, 96, 146);"><strong><span style="font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">vm_map_copy()更改</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">OS X 10.11 El Capitan 以前的内核中，可以使用溢出漏洞捕获 kdata 指针和 vm_map_copy 的 size，从而读取任意的数据，但这里 vm_map_copy 结构体发生了变化。(osfmk/vm/vm_map.h)</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">// 更改前</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:cpp;toolbar:false">struct&nbsp;vm_map_copy{
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;type;
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VM_MAP_COPY_ENTRY_LIST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VM_MAP_COPY_OBJECT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VMMAP_COPY_KERNEL_BUFFER&nbsp;&nbsp;&nbsp;&nbsp;3
&nbsp;&nbsp;&nbsp;&nbsp;vm_object_offset_t&nbsp;offset;
&nbsp;&nbsp;&nbsp;&nbsp;vm_map_size_t&nbsp;size;
&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;vm_map_header&nbsp;&nbsp;&nbsp;&nbsp;hdr;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vm_object_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;{&nbsp;//&nbsp;&lt;&lt;=&nbsp;Before&nbsp;Change
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*kdata;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vm_size_t&nbsp;kalloc_size;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}c_k;
&nbsp;&nbsp;&nbsp;&nbsp;}c_u;
};</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">// 更改后</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:cpp;toolbar:false">struct&nbsp;vm_map_copy{
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;type;
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VM_MAP_COPY_ENTRY_LIST&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VM_MAP_COPY_OBJECT&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;#define&nbsp;VM_MAP_COPY_KERNEL_BUFFER&nbsp;3
&nbsp;&nbsp;&nbsp;&nbsp;vm_object_offset_t&nbsp;offset;
&nbsp;&nbsp;&nbsp;&nbsp;vm_map_size_t&nbsp;size;
&nbsp;&nbsp;&nbsp;&nbsp;union{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;vm_map_header&nbsp;hdr;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vm_object_t&nbsp;object;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint8_t&nbsp;kdata[0];&nbsp;//&nbsp;&lt;&lt;=&nbsp;Changed
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然而，在 OS X 10.11 El capitan 的 ipc_kmsg_copyout_ool_descriptor() 中存在一种绕过竞争条件技术的情况。（目前该结构体已被修复）</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其他</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">iOS 和 macOS 的结构和安全性补丁是非常相似的，所以通常可以把它们放在一起。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">攻击是棘手的，除非有一个完美的溢出 bug。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">许多 bug 很难通过远程攻击实现。（例如，使用safari漏洞获取内核权限的过程）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在早期版本的 OS X 中，通过将数据写入一个空指针，可以相对简单地实现 LPE（参见下面的源代码）。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:cpp;toolbar:false">void&nbsp;null_page(){
&nbsp;&nbsp;sync();
&nbsp;&nbsp;vm_address_t&nbsp;addr=0;
&nbsp;&nbsp;vm_deallocate(mach_task_self(),0x0,0x1000);
&nbsp;&nbsp;vm_allocate(mach_task_self(),&amp;addr,0x1000,0);
&nbsp;&nbsp;uint64_t&nbsp;*&nbsp;np=0;
&nbsp;&nbsp;for(int&nbsp;i=1;i&lt;0x100;i++)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;np[i]&nbsp;=&nbsp;0x4141414141414141;
&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从 iOS 9.2，macOS 10.11 开始及以后的版本中，重新分配的内存地址很难被预测。（freelist randomization）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在 iOS 10，macOS 10.12 中，vm_map_size(vm_map_copy) 堆利用的漏洞也已经被修补。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">内核调试</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">简介</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">一旦内核崩溃，操作系统将停止工作，因此你必须安装一个或多个虚拟机，并使用 kdp 来进行调试。如果你使用的是 OS X 中的“Parallels Desktop”，则可以使用恢复分区来安装 OSX 虚拟机。如果你已经有所需的 OSX 版本，则可以通过搜索安装镜像文件或虚拟机。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">首先你需要下载内核调试工具包（Kernel Debug Kit），以便于在主机（host）中配置各种调试环境。内核调试工具包允许你使用 LLDB 或 GDB 加载和调试默认情况下不被包含的符号。如果你希望直接分析内核二进制文件并监视 1day 漏洞，则可以使用内核调试工具包在存在漏洞的 OSX 版本上进行分析。</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">主机设置</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">https://developer.apple.com/download/more/?=Kernel%20Debug%20Kit</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://p7.qhimg.com/t01f0390c92217f38e5.png" title="t01b07fbe1cfe3e067c.png" alt="t01b07fbe1cfe3e067c.png" width="800" height="270"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">它与 OSX 的版本是对应的，因此请根据你正在分析的 1-day 漏洞版本进行下载。安装并运行下载的 dmg 文件时，调试工具包存在于 /Library/Developer/KDKs/ 路径下。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://p1.qhimg.com/t0169d959b8ff68248f.png" title="t0101bd13670d16794d.png" alt="t0101bd13670d16794d.png" width="800" height="45"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在 OSX 上运行的内核二进制文件存在于路径 /System/Library/Kernels/kernel 下。你可以将二进制文件 attach 到调试器上，通过配置调试工具包，即使主机和客户机的 OSX 版本不同，你也可以进行调试。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">现在，使用 LLDB 完成对主机的配置。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://p9.qhimg.com/t013c6c8b4d4c277571.png" title="t0142ffd7f3cad4aa70.png" alt="t0142ffd7f3cad4aa70.png" width="800" height="120"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如果你将二进制文件加载到 LLDB 时看到了上面的报错信息。这很容易解决，如下所示。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;command&nbsp;script&nbsp;import&nbsp;&quot;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py&quot;
songsangjun-ui-MacBook-Pro:~&nbsp;s0ngsari$&nbsp;echo&nbsp;&quot;settings&nbsp;set&nbsp;target.load-script-from-symbol-file&nbsp;true&quot;&nbsp;&gt;&nbsp;~/.lldbinit</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">请注意主机和客户机都必须禁用 System Integrity Protection(SIP)。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">你已经完成了对主机环境的配置，现在再对客户机进行配置就可以调试内核了。</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">客户机设置</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">OSX 可以使用 nvram 设置引导参数（boot-args）。</span></p><pre class="brush:bash;toolbar:false">$&nbsp;nvram&nbsp;boot-args</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">boot-args 是作为 OS 在启动时设置的参数。但我们使用这些参数是为了记录调试所需的中断和日志信息。boot-args 有很多参数，这里我们先设置 debug。可以参考下面的图表。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://p4.qhimg.com/t015769df67693a5ad6.png" title="t01ed684192df6b1d86.png" alt="t01ed684192df6b1d86.png" width="800" height="330"/></span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><img src="http://p0.qhimg.com/t010f3675cef61d01e6.png" title="t01ed684192df6b1d86.png" alt="t01ed684192df6b1d86.png" width="800" height="330"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">调试内核时，给 debug 参数赋值 0x144。DB_NMI 标志允许调试器使用 NMI 中断 attach 到调试对象上。你可以设置如下所示的选项。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">$&nbsp;sudo&nbsp;nvram&nbsp;boot-args=&quot;debug=0x144&nbsp;-v&quot;
DB_LOG_PI_SCRN
DB_ARP
DB_NMI
Boot&nbsp;Verbose&nbsp;mode
$&nbsp;sudo&nbsp;reboot</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">之后，boot-args 被设置并产生一个 NMI 中断，从而允许调试器调试内核。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">有时候即使 NMI 已经在调试对象中给出，也不能进行调试，那么需要在调试器中添加 arp 表。</span></p><pre class="brush:bash;toolbar:false">$&nbsp;arp&nbsp;-s&nbsp;&lt;DebuggeeIP&gt;&nbsp;&lt;DebuggeeMac&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">这样就完成了主机和客户机的配置，可以继续下面的调试了。</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">attach 到调试器</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">作为本文的例子，我们将调试的 1day 漏洞是 CVE-2017-2370。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">$&nbsp;vi&nbsp;test.c
$&nbsp;clang&nbsp;-o&nbsp;test&nbsp;test.c</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在客户机中编译 PoC 并产生一个 NMI，NMI 可以通过命令 Command + Alt + Control + Shift + Esc 产生。一旦产生了 NMI，操作系统将被安全地停止运行。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">在调试器中，你可以使用 kdp-remote 进行远程调试，首先打开 KDK 的内核二进制文件。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">songsangjun-ui-MacBook-Pro:~&nbsp;s0ngsari$&nbsp;lldb&nbsp;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel
(lldb)&nbsp;target&nbsp;create&nbsp;&quot;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel&quot;
Loading&nbsp;kernel&nbsp;debugging&nbsp;from&nbsp;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/kernel.py
LLDB&nbsp;version&nbsp;lldb-350.0.21.9
settings&nbsp;set&nbsp;target.process.python-os-plugin-path&nbsp;&quot;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/core/operating_system.py&quot;
settings&nbsp;set&nbsp;target.trap-handler-names&nbsp;hndl_allintrs&nbsp;hndl_alltraps&nbsp;trap_from_kernel&nbsp;hndl_double_fault&nbsp;hndl_machine_check&nbsp;_fleh_prefabt&nbsp;_ExceptionVectorsBase&nbsp;_ExceptionVectorsTable&nbsp;_fleh_undef&nbsp;_fleh_dataabt&nbsp;_fleh_irq&nbsp;_fleh_decirq&nbsp;_fleh_fiq_generic&nbsp;_fleh_dec
command&nbsp;script&nbsp;import&nbsp;&quot;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel.dSYM/Contents/Resources/DWARF/../Python/lldbmacros/xnu.py&quot;
xnu&nbsp;debug&nbsp;macros&nbsp;loaded&nbsp;successfully.&nbsp;Run&nbsp;showlldbtypesummaries&nbsp;to&nbsp;enable&nbsp;type&nbsp;summaries.
Current&nbsp;executable&nbsp;set&nbsp;to&nbsp;&#39;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel&#39;&nbsp;(x86_64).
(lldb)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如果没有报错，则使用 kdp-remote 命令链接到远程调试器。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;kdp-remote&nbsp;&lt;debuggeeIP&gt;
Version:&nbsp;Darwin&nbsp;Kernel&nbsp;Version&nbsp;16.1.0:&nbsp;Wed&nbsp;Oct&nbsp;19&nbsp;20:31:56&nbsp;PDT&nbsp;2016;&nbsp;root:xnu-3789.21.4~4/RELEASE_X86_64;&nbsp;UUID=75CA1C4D-7BF4-321B-B544-D8F1B6D60EF8;&nbsp;stext=0xffffff8014200000
Kernel&nbsp;UUID:&nbsp;75CA1C4D-7BF4-321B-B544-D8F1B6D60EF8
Load&nbsp;Address:&nbsp;0xffffff8014200000
Kernel&nbsp;slid&nbsp;0x14000000&nbsp;in&nbsp;memory.
Loaded&nbsp;kernel&nbsp;file&nbsp;/Library/Developer/KDKs/KDK_10.12.1_16B2657.kdk/System/Library/Kernels/kernel
Loading&nbsp;94&nbsp;kext&nbsp;modules&nbsp;warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.kec.corecrypto&nbsp;(809FEC94-017C-307A-B099-A01EFF5485FB)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.kec.pthread&nbsp;(36567317-B854-3157-ABF3-CEAD0A3770BB)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.kec.Libm&nbsp;(51D82C5F-0248-334D-ADC6-5861BBB83C97)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOACPIFamily&nbsp;(4F7FB6AD-2498-3F71-827C-ED7AA4BF2511)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleACPIPlatform&nbsp;(249D7BA8-3FD5-3207-A482-0605CB898037)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleFDEKeyStore&nbsp;(EA5D0966-E8EA-337A-98EB-195806E8F723)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOReportFamily&nbsp;(B14DC3D3-7250-3DA3-BF50-C666EBEDAF4C)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.DiskImages&nbsp;(05A729EF-20B8-3254-8F13-42DF42E0544B)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleBusPowerController&nbsp;(DB526B45-1A45-3A81-A0C1-57F826CADEDF)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.KernelRelayHost&nbsp;(3B58E6F0-DE92-3289-9D3B-3BF12208585F)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleCredentialManager&nbsp;(54677B39-44B3-3AAA-BBEC-D78D0B5CC1A7)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleMobileFileIntegrity&nbsp;(0EFA4D2C-2271-3C43-B777-17D05716144A)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleKeyStore&nbsp;(75515493-6D25-39F7-8F0B-B08B505CAB74)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.security.TMSafetyNet&nbsp;(1CB512A3-24BD-344A-BFB4-44A61F27AB03)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.kext.AppleMatch&nbsp;(3B280DAB-903F-33DC-8110-525A1154B11E)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.security.sandbox&nbsp;(32039FC4-CA9B-3B74-B326-A2BF5CFE45E1)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.security.quarantine&nbsp;(EC92F0F9-694E-3E22-8B2C-4A071D20C6BA)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.nke.applicationfirewall&nbsp;(2A0DC0EF-655C-3D4B-93FD-3AED72BEBBDC)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleAPIC&nbsp;(BC2E6D01-BCBB-3525-BF38-BF99C3F1EC46)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleSMBIOS&nbsp;(9BB02681-4B47-3592-AD62-71FB0BF56965)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleRTC&nbsp;(3FD1BCF4-8AFC-3CE6-A36E-26410544AD14)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOSMBusFamily&nbsp;(185F0EBF-0262-3370-BD47-8FE4C8AA726E)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleACPIEC&nbsp;(BC227AE1-3CD5-3938-9C8C-009F1A966FBE)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleHPET&nbsp;(2CFB49B8-4CC2-320B-9C6E-99646DFD8571)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleACPIButtons&nbsp;(4D5E51D6-8A6B-3B6A-A8F2-472D56C9D0C3)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleSmartBatteryManager&nbsp;(31670664-0EF0-39B5-A13F-15B8F9EC1283)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleEFIRuntime&nbsp;(6B7A5B9A-C313-3F7F-B6E2-60EE54593BC8)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleEFINVRAM&nbsp;(6F4404D6-8625-35CA-AEB6-6ECD7B64FA52)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBHostPacketFilter&nbsp;(9888F9CD-B7EE-3A9D-8530-6FA4C167B26C)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBEHCI&nbsp;(BF6EF9A2-F090-3094-B3FA-F34351D946CF)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBUHCI&nbsp;(4EF43593-FC11-31E6-8B27-E7A6B5703C15)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBUHCIPCI&nbsp;(4EC90565-DB48-3190-8608-1F6DA30B8691)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBXHCI&nbsp;(E5F9850E-A1A1-305F-854D-48B46C08B2EC)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBXHCIPCI&nbsp;(B4287428-23D9-3547-93B5-2FEB73A02EA6)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBEHCIPCI&nbsp;(4FCE62CA-0477-34A2-9564-86F807CDBD4D)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOATAFamily&nbsp;(BC25A382-3DA0-33C7-93C5-E8A823B50F98)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleIntelPIIXATA&nbsp;(BDC5E432-B04E-3ACF-A213-672128140381)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOAHCIFamily&nbsp;(5C275B66-A173-3D92-853A-44FC35D45FFC)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleAHCIPort&nbsp;(BE72151C-73BE-35B7-8C31-74F49E4C5E98)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleIntel8254XEthernet&nbsp;(34B30414-098D-3D22-AAB5-1A754D0647C6)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOAHCIBlockStorage&nbsp;(C449634B-8121-3BFB-972D-966847C4321F)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOAHCISerialATAPI&nbsp;(681FA1E2-E3DE-3FEB-ACA7-16FC2B9078A6)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.filesystems.hfs.encodings.kext&nbsp;(68A8D6C1-CDCA-371C-970B-325BF2E7ECAB)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.filesystems.hfs.kext&nbsp;(6C6C4A98-1534-3C52-B006-00FBC479233E)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.BootCache&nbsp;(C38789F4-9226-303C-99BE-3B8EAF8EC5C2)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.AppleFSCompression.AppleFSCompressionTypeZlib&nbsp;(9B32DDE9-151F-31A1-90E9-3CEB2C7BE27C)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.AppleFSCompression.AppleFSCompressionTypeDataless&nbsp;(C6F882D7-C35C-3963-A2FA-10033FF40107)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBHostCompositeDevice&nbsp;(30502C8D-F4B2-345F-B8F0-F8C54CAD7F46)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.networking&nbsp;(74394A72-1E87-363E-8CFD-182BD8C9362E)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.AppleUSBHub&nbsp;(F7BC6869-E4BA-3291-B7EA-BF28A0ABEF4A)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.IOUSBHostHIDDevice&nbsp;(0548123A-013B-3C74-86A8-33DF73E9CBBB)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleHIDKeyboard&nbsp;(664B787F-6DE5-3211-9081-E434055A550B)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.parallels.kext.video&nbsp;(5520E5F4-AC7C-9446-6088-5D8CAF25478D)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.parallels.driver.AppleIntelAC97Controller&nbsp;(705C3A56-06CE-E995-5A75-618C5EF3D45D)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.vecLib.kext&nbsp;(C0ABF85C-CA30-3F02-9E1E-06F3BA5047A8)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOSlowAdaptiveClockingFamily&nbsp;(F026208D-CC0C-3599-B303-9196904A584E)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleIntelSlowAdaptiveClocking&nbsp;(6FE984DD-A1FE-309E-83CF-B346989A6F17)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.IOPlatformPluginFamily&nbsp;(087648A2-8A44-3095-AEC7-44A872A46205)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.IOPlatformPluginLegacy&nbsp;(9156271B-C61E-3B40-B5B6-102369F12A8B)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleSMC&nbsp;(969D80B2-E714-3145-95B0-F61627E0EE4D)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.ACPI_SMC_PlatformPlugin&nbsp;(7224B682-B40F-3A4A-BCA0-82727D251ECB)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.parallels.kext.tg&nbsp;(09C02F97-D104-80F1-2A96-6BEF8A2F6967)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleSMBusController&nbsp;(4DAA381E-3690-3E94-8025-DFB34F714094)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleMCCSControl&nbsp;(102DD5D9-2DD5-3BCB-B5C0-BE08E1049CD6)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleUpstreamUserClient&nbsp;(F39509A4-191C-35DA-B7D9-08F95E5AB8BC)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleHV&nbsp;(39AC9B9B-7B20-322F-82F0-044B3CC08D43)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleSSE&nbsp;(907BB577-46DF-3C86-9034-758B61AD054D)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.Dont_Steal_Mac_OS_X&nbsp;(B97F871A-44FD-3EA4-BC46-8FD682118C79)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOBluetoothFamily&nbsp;(794ACDDD-2B46-3BF0-94E9-4FD7C109A427)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOBluetoothSerialManager&nbsp;(6F68B8CF-6543-328E-AF57-DD250412CF02)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOSurface&nbsp;(D3B2D208-487C-3166-9F7D-D6159AABC428)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.iokit.IOUserEthernet&nbsp;(5EE448BD-95EC-35AD-B7FC-A1237E4BB346)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.pmtelemetry&nbsp;(F46D019B-17FF-3CD5-A093-0894B81C1404)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.parallels.driver.AppleIntelAC97Audio&nbsp;(F8F3B21C-958B-BB10-E13C-42CA34BF6815)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.AppleOSXWatchdog&nbsp;(757A8B72-2A1A-32BA-99EC-6D802DE6E91F)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.kext.triggers&nbsp;(4E564246-8804-3673-B440-606AD360A3BB)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.filesystems.autofs&nbsp;(AA36D92F-D92B-3102-BAE3-F86A0A298143)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.filesystems.smbfs&nbsp;(42EF3BC8-5041-3E94-BC74-9D5906694E3A)
.warning:&nbsp;Can&#39;t&nbsp;find&nbsp;binary/dSYM&nbsp;for&nbsp;com.apple.driver.usb.cdc&nbsp;(6CB80B6B-9071-38ED-9A4B-635ABF20A429)
.Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
&nbsp;done.
Target&nbsp;arch:&nbsp;x86_64
Instantiating&nbsp;threads&nbsp;completely&nbsp;from&nbsp;saved&nbsp;state&nbsp;in&nbsp;memory.
kernel&nbsp;was&nbsp;compiled&nbsp;with&nbsp;optimization&nbsp;-&nbsp;stepping&nbsp;may&nbsp;behave&nbsp;oddly;&nbsp;variables&nbsp;may&nbsp;not&nbsp;be&nbsp;available.
Process&nbsp;1&nbsp;stopped
*&nbsp;thread&nbsp;#2:&nbsp;tid&nbsp;=&nbsp;0x16cc,&nbsp;0xffffff801440bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513,&nbsp;name&nbsp;=&nbsp;&#39;0xffffff801c791028&#39;,&nbsp;queue&nbsp;=&nbsp;&#39;0x0&#39;,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;signal&nbsp;SIGSTOP
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#0:&nbsp;0xffffff801440bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513&nbsp;[opt]
(lldb)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如果正确地捕获到了内核，就可以通过恢复调试对象进程并运行 PoC 来检查是否会产生崩溃。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;c
Process&nbsp;1&nbsp;resuming
(lldb)&nbsp;Unloading&nbsp;1&nbsp;kext&nbsp;modules&nbsp;.&nbsp;done.
Process&nbsp;1&nbsp;stopped
*&nbsp;thread&nbsp;#4:&nbsp;tid&nbsp;=&nbsp;0x1af6,&nbsp;0xffffff8014751a8c&nbsp;kernel`fp_lookup(p=0xffffff801ebec780,&nbsp;fd=1,&nbsp;resultfp=0xffffff806eb6bf20,&nbsp;locked=0)&nbsp;+&nbsp;92&nbsp;at&nbsp;kern_descrip.c:3879,&nbsp;name&nbsp;=&nbsp;&#39;0xffffff801c09a9a8&#39;,&nbsp;queue&nbsp;=&nbsp;&#39;0x0&#39;,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;EXC_BAD_INSTRUCTION&nbsp;(code=13,&nbsp;subcode=0x0)
frame&nbsp;#0:&nbsp;0xffffff8014751a8c&nbsp;kernel`fp_lookup(p=0xffffff801ebec780,&nbsp;fd=1,&nbsp;resultfp=0xffffff806eb6bf20,&nbsp;locked=0)&nbsp;+&nbsp;92&nbsp;at&nbsp;kern_descrip.c:3879&nbsp;[opt]
(lldb)&nbsp;register&nbsp;read
General&nbsp;Purpose&nbsp;Registers:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rax&nbsp;=&nbsp;0x4141414141414141
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbx&nbsp;=&nbsp;0x0000000000000001
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx&nbsp;=&nbsp;0x0000000000000001
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx&nbsp;=&nbsp;0xffffff8020d0e800
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdi&nbsp;=&nbsp;0xffffff801ebec848
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsi&nbsp;=&nbsp;0x0000000000000001
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbp&nbsp;=&nbsp;0xffffff806eb6bef0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsp&nbsp;=&nbsp;0xffffff806eb6bec0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8&nbsp;=&nbsp;0x0000000000000000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r9&nbsp;=&nbsp;0x00007fffda6afa50
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r10&nbsp;=&nbsp;0x000000000000000a
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r11&nbsp;=&nbsp;0x0000000000000246
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r12&nbsp;=&nbsp;0xffffff801ebec780
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r13&nbsp;=&nbsp;0xffffff801ec3e4f8
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r14&nbsp;=&nbsp;0x0000000000000000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r15&nbsp;=&nbsp;0xffffff806eb6bf20
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rip&nbsp;=&nbsp;0xffffff8014751a8c&nbsp;&nbsp;kernel`fp_lookup&nbsp;+&nbsp;92&nbsp;at&nbsp;kern_descrip.c:3879
&nbsp;&nbsp;&nbsp;&nbsp;rflags&nbsp;=&nbsp;0x0000000000010246
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cs&nbsp;=&nbsp;0x0000000000000008
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fs&nbsp;=&nbsp;0x0000000000000000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs&nbsp;=&nbsp;0x0000000000000000
(lldb)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">LLDB 和 GDB 的命令有所不同，最好将它们分开学习。或者使用一个名为 kgmacros 的脚本，总的来说使用 GDB 进行调试也不错。</span></p><p style="text-indent: 2em;"><span style="color: rgb(54, 96, 146); font-size: 18px;"><strong><span style="color: rgb(54, 96, 146); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">记录堆日志</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">运行 Poc 并设置断点来跟踪堆是很困难的。但是，你可以通过上面说到的 boot-args 来跟踪堆。这可以跟踪 OSX 堆的所覆盖的 zone。</span></p><pre class="brush:bash;toolbar:false">$&nbsp;sudo&nbsp;nvram&nbsp;boot-args=&quot;debug=0x144&nbsp;-v&nbsp;-zc&nbsp;zlog1=kalloc.128&nbsp;zlog2=kalloc.256&quot;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">与上面的命令一样，使用 -zc zlog1=zone，然后重启。最重要的是知道 Poc 所使用的 zone。我们只跟踪所选择的 zone，而不是全部，所以如果你想跟踪起来比较轻松，就只传递一个 zone 到 boot-args 中。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">使用 zlog 时</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;bt
*&nbsp;thread&nbsp;#2:&nbsp;tid&nbsp;=&nbsp;0x0cb5,&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513,&nbsp;name&nbsp;=&nbsp;&#39;0xffffff8019752980&#39;,&nbsp;queue&nbsp;=&nbsp;&#39;0x0&#39;,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;signal&nbsp;SIGSTOP
&nbsp;&nbsp;*&nbsp;frame&nbsp;#0:&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger(message=&lt;unavailable&gt;)&nbsp;+&nbsp;910&nbsp;at&nbsp;model_dep.c:1025&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0xffffff8011ef368c&nbsp;kernel`panic(str=&quot;\&quot;a&nbsp;freed&nbsp;zone&nbsp;element&nbsp;has&nbsp;been&nbsp;modified&nbsp;in&nbsp;zone&nbsp;%s:&nbsp;expected&nbsp;%p&nbsp;but&nbsp;found&nbsp;%p,&nbsp;bits&nbsp;changed&nbsp;%p,&nbsp;at&nbsp;offset&nbsp;%d&nbsp;of&nbsp;%d&nbsp;in&nbsp;element&nbsp;%p,&nbsp;cookies&nbsp;%p&nbsp;%p\&quot;@/Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.21.4/osfmk/kern/zalloc.c:651&quot;)&nbsp;+&nbsp;236&nbsp;at&nbsp;debug.c:458&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0xffffff8011f3f5c0&nbsp;kernel`backup_ptr_mismatch_panic&nbsp;[inlined]&nbsp;zone_element_was_modified_panic(offset=0)&nbsp;+&nbsp;800&nbsp;at&nbsp;zalloc.c:642&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0xffffff8011f3f559&nbsp;kernel`backup_ptr_mismatch_panic(zone=&lt;unavailable&gt;,&nbsp;element=&lt;unavailable&gt;,&nbsp;primary=4702111234474983745,&nbsp;backup=&lt;unavailable&gt;)&nbsp;+&nbsp;697&nbsp;at&nbsp;zalloc.c:710&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0xffffff8011f3e739&nbsp;kernel`try_alloc_from_zone(zone=&lt;unavailable&gt;,&nbsp;check_poison=&lt;unavailable&gt;)&nbsp;+&nbsp;521&nbsp;at&nbsp;zalloc.c:832&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0xffffff8011f3d174&nbsp;kernel`zalloc_internal(zone=&lt;unavailable&gt;,&nbsp;canblock=1,&nbsp;nopagewait=0)&nbsp;+&nbsp;484&nbsp;at&nbsp;zalloc.c:2284&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#7:&nbsp;0xffffff8011f84580&nbsp;kernel`vm_map_copyin_internal&nbsp;+&nbsp;51&nbsp;at&nbsp;vm_map.c:9428&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#8:&nbsp;0xffffff8011f8454d&nbsp;kernel`vm_map_copyin_internal(src_map=&lt;unavailable&gt;,&nbsp;src_addr=140351705630208,&nbsp;len=3240,&nbsp;flags=&lt;unavailable&gt;,&nbsp;copy_result=&lt;unavailable&gt;)&nbsp;+&nbsp;253&nbsp;at&nbsp;vm_map.c:10279&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#9:&nbsp;0xffffff8011ed7629&nbsp;kernel`ipc_kmsg_copyin_ool_descriptor&nbsp;[inlined]&nbsp;vm_map_copyin_common(src_map=&lt;unavailable&gt;,&nbsp;src_destroy=&lt;unavailable&gt;,&nbsp;copy_result=0xffffff8071adbe40,&nbsp;use_maxprot=0)&nbsp;+&nbsp;201&nbsp;at&nbsp;vm_map.c:10187&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#10:&nbsp;0xffffff8011ed7616&nbsp;kernel`ipc_kmsg_copyin_ool_descriptor(dsc=0xffffff8018874c98,&nbsp;user_dsc=&lt;unavailable&gt;,&nbsp;is_64bit=&lt;unavailable&gt;,&nbsp;paddr=&lt;unavailable&gt;,&nbsp;copy=0xffffff8071adbe40,&nbsp;space_needed=&lt;unavailable&gt;,&nbsp;map=&lt;unavailable&gt;,&nbsp;mr=&lt;unavailable&gt;)&nbsp;+&nbsp;182&nbsp;at&nbsp;ipc_kmsg.c:2701&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#11:&nbsp;0xffffff8011ed7c25&nbsp;kernel`ipc_kmsg_copyin_body(kmsg=0xffffff8018874c00,&nbsp;space=0xffffff8018925b40,&nbsp;map=0xffffff801c0e9e08)&nbsp;+&nbsp;613&nbsp;at&nbsp;ipc_kmsg.c:3035&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#12:&nbsp;0xffffff8011ee992f&nbsp;kernel`mach_msg_overwrite_trap(args=&lt;unavailable&gt;)&nbsp;+&nbsp;287&nbsp;at&nbsp;mach_msg.c:548&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#13:&nbsp;0xffffff8011ff26ae&nbsp;kernel`mach_call_munger64(state=0xffffff8018dd12c0)&nbsp;+&nbsp;430&nbsp;at&nbsp;bsd_i386.c:562&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#14:&nbsp;0xffffff8011ea5f66&nbsp;kernel`hndl_mach_scall64&nbsp;+&nbsp;22</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">未使用 zlog 时</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;bt
*&nbsp;thread&nbsp;#2:&nbsp;tid&nbsp;=&nbsp;0x13ab,&nbsp;0xffffff8015c0bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513,&nbsp;name&nbsp;=&nbsp;&#39;0xffffff80200f4288&#39;,&nbsp;queue&nbsp;=&nbsp;&#39;0x0&#39;,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;signal&nbsp;SIGSTOP
&nbsp;&nbsp;*&nbsp;frame&nbsp;#0:&nbsp;0xffffff8015c0bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0xffffff8015c0bb4e&nbsp;kernel`Debugger(message=&lt;unavailable&gt;)&nbsp;+&nbsp;910&nbsp;at&nbsp;model_dep.c:1025&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0xffffff8015af368c&nbsp;kernel`panic(str=&quot;\&quot;Invalid&nbsp;queue&nbsp;element&nbsp;linkage&nbsp;for&nbsp;%p:&nbsp;next&nbsp;%p&nbsp;next-&gt;prev&nbsp;%p&nbsp;prev&nbsp;%p&nbsp;prev-&gt;next&nbsp;%p\&quot;@/Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.21.4/osfmk/kern/queue.h:245&quot;)&nbsp;+&nbsp;236&nbsp;at&nbsp;debug.c:458&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0xffffff8015bec040&nbsp;kernel`pmap_enter_options&nbsp;[inlined]&nbsp;__QUEUE_ELT_VALIDATE&nbsp;+&nbsp;81&nbsp;at&nbsp;queue.h:244&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0xffffff8015bebfef&nbsp;kernel`pmap_enter_options&nbsp;[inlined]&nbsp;insque&nbsp;at&nbsp;queue.h:347&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0xffffff8015bebfef&nbsp;kernel`pmap_enter_options&nbsp;[inlined]&nbsp;pv_hash_add&nbsp;+&nbsp;32&nbsp;at&nbsp;pmap_internal.h:544&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0xffffff8015bebfcf&nbsp;kernel`pmap_enter_options(pmap=&lt;unavailable&gt;,&nbsp;vaddr=&lt;unavailable&gt;,&nbsp;pn=&lt;unavailable&gt;,&nbsp;prot=&lt;unavailable&gt;,&nbsp;fault_type=&lt;unavailable&gt;,&nbsp;flags=&lt;unavailable&gt;,&nbsp;wired=&lt;unavailable&gt;,&nbsp;options=&lt;unavailable&gt;,&nbsp;arg=&lt;unavailable&gt;)&nbsp;+&nbsp;5103&nbsp;at&nbsp;pmap_x86_common.c:926&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#7:&nbsp;0xffffff8015b6fb41&nbsp;kernel`vm_fault_enter(m=0xffffff801c1c3c00,&nbsp;pmap=&lt;unavailable&gt;,&nbsp;vaddr=140736734584832,&nbsp;prot=&lt;unavailable&gt;,&nbsp;caller_prot=&lt;unavailable&gt;,&nbsp;wired=0,&nbsp;change_wiring=&lt;unavailable&gt;,&nbsp;no_cache=0,&nbsp;cs_bypass=&lt;unavailable&gt;,&nbsp;user_tag=1962753648,&nbsp;pmap_options=&lt;unavailable&gt;,&nbsp;need_retry=&lt;unavailable&gt;,&nbsp;type_of_fault=&lt;unavailable&gt;)&nbsp;+&nbsp;4481&nbsp;at&nbsp;vm_fault.c:3292&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#8:&nbsp;0xffffff8015b71405&nbsp;kernel`vm_fault_internal(map=&lt;unavailable&gt;,&nbsp;vaddr=&lt;unavailable&gt;,&nbsp;caller_prot=&lt;unavailable&gt;,&nbsp;change_wiring=0,&nbsp;interruptible=2,&nbsp;caller_pmap=0x0000000000000000,&nbsp;caller_pmap_addr=0,&nbsp;physpage_p=&lt;unavailable&gt;)&nbsp;+&nbsp;4421&nbsp;at&nbsp;vm_fault.c:4086&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#9:&nbsp;0xffffff8015c069fc&nbsp;kernel`user_trap&nbsp;[inlined]&nbsp;vm_fault(map=&lt;unavailable&gt;,&nbsp;vaddr=&lt;unavailable&gt;,&nbsp;fault_type=&lt;unavailable&gt;,&nbsp;change_wiring=0,&nbsp;interruptible=2,&nbsp;caller_pmap=&lt;unavailable&gt;,&nbsp;caller_pmap_addr=0)&nbsp;+&nbsp;652&nbsp;at&nbsp;vm_fault.c:3397&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#10:&nbsp;0xffffff8015c069d8&nbsp;kernel`user_trap(saved_state=0xffffff801ff11060)&nbsp;+&nbsp;616&nbsp;at&nbsp;trap.c:1120&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#11:&nbsp;0xffffff8015aa5655&nbsp;kernel`hndl_alltraps&nbsp;+&nbsp;229</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">当查看调用栈时，差异是很明显的。使用了 zlog 时，你可以看到调用栈被分配给了 zalloc，但未使用 zlog 时就看不到。所以如果你要分析 1day 漏洞的堆腐败时，了解 zone 的概念并使用 zlog 可以进行更好的调试。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px; color: rgb(54, 96, 146);"><strong><span style="font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更多内容</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">了解 bug 很重要，但调试也很重要。做调试时我会使用一些简单的命令。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;bt
*&nbsp;thread&nbsp;#2:&nbsp;tid&nbsp;=&nbsp;0x1650,&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513,&nbsp;name&nbsp;=&nbsp;&#39;0xffffff801a0eee18&#39;,&nbsp;queue&nbsp;=&nbsp;&#39;0x0&#39;,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;signal&nbsp;SIGSTOP
&nbsp;&nbsp;*&nbsp;frame&nbsp;#0:&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger&nbsp;[inlined]&nbsp;hw_atomic_sub(delt=1)&nbsp;at&nbsp;locks.c:1513&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0xffffff801200bb4e&nbsp;kernel`Debugger(message=&lt;unavailable&gt;)&nbsp;+&nbsp;910&nbsp;at&nbsp;model_dep.c:1025&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0xffffff8011ef368c&nbsp;kernel`panic(str=&quot;\&quot;a&nbsp;freed&nbsp;zone&nbsp;element&nbsp;has&nbsp;been&nbsp;modified&nbsp;in&nbsp;zone&nbsp;%s:&nbsp;expected&nbsp;%p&nbsp;but&nbsp;found&nbsp;%p,&nbsp;bits&nbsp;changed&nbsp;%p,&nbsp;at&nbsp;offset&nbsp;%d&nbsp;of&nbsp;%d&nbsp;in&nbsp;element&nbsp;%p,&nbsp;cookies&nbsp;%p&nbsp;%p\&quot;@/Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.21.4/osfmk/kern/zalloc.c:651&quot;)&nbsp;+&nbsp;236&nbsp;at&nbsp;debug.c:458&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0xffffff8011f3f5c0&nbsp;kernel`backup_ptr_mismatch_panic&nbsp;[inlined]&nbsp;zone_element_was_modified_panic(offset=0)&nbsp;+&nbsp;800&nbsp;at&nbsp;zalloc.c:642&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0xffffff8011f3f559&nbsp;kernel`backup_ptr_mismatch_panic(zone=&lt;unavailable&gt;,&nbsp;element=&lt;unavailable&gt;,&nbsp;primary=4702111234474983745,&nbsp;backup=&lt;unavailable&gt;)&nbsp;+&nbsp;697&nbsp;at&nbsp;zalloc.c:710&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0xffffff8011f3e739&nbsp;kernel`try_alloc_from_zone(zone=&lt;unavailable&gt;,&nbsp;check_poison=&lt;unavailable&gt;)&nbsp;+&nbsp;521&nbsp;at&nbsp;zalloc.c:832&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0xffffff8011f3d174&nbsp;kernel`zalloc_internal(zone=&lt;unavailable&gt;,&nbsp;canblock=1,&nbsp;nopagewait=0)&nbsp;+&nbsp;484&nbsp;at&nbsp;zalloc.c:2284&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#7:&nbsp;0xffffff8011ed5248&nbsp;kernel`ipc_kmsg_alloc(msg_and_trailer_size=4352)&nbsp;+&nbsp;248&nbsp;at&nbsp;ipc_kmsg.c:929&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#8:&nbsp;0xffffff8011ef832d&nbsp;kernel`ipc_kobject_server(request=&lt;unavailable&gt;,&nbsp;option=&lt;unavailable&gt;)&nbsp;+&nbsp;141&nbsp;at&nbsp;ipc_kobject.c:299&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#9:&nbsp;0xffffff8011ed5f61&nbsp;kernel`ipc_kmsg_send(kmsg=&lt;unavailable&gt;,&nbsp;option=&lt;unavailable&gt;,&nbsp;send_timeout=&lt;unavailable&gt;)&nbsp;+&nbsp;225&nbsp;at&nbsp;ipc_kmsg.c:1826&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#10:&nbsp;0xffffff8011ee9957&nbsp;kernel`mach_msg_overwrite_trap(args=&lt;unavailable&gt;)&nbsp;+&nbsp;327&nbsp;at&nbsp;mach_msg.c:556&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#11:&nbsp;0xffffff8011ff26ae&nbsp;kernel`mach_call_munger64(state=0xffffff8019fed920)&nbsp;+&nbsp;430&nbsp;at&nbsp;bsd_i386.c:562&nbsp;[opt]
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#12:&nbsp;0xffffff8011ea5f66&nbsp;kernel`hndl_mach_scall64&nbsp;+&nbsp;22</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">bt 命令是 BackTrace 的缩写，它用于将线程堆栈信息打印出来。你可以选择跳转到单个 frame 并查看其局部变量。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;frame&nbsp;select&nbsp;5
frame&nbsp;#5:&nbsp;0xffffff8011f3e739&nbsp;kernel`try_alloc_from_zone(zone=&lt;unavailable&gt;,&nbsp;check_poison=&lt;unavailable&gt;)&nbsp;+&nbsp;521&nbsp;at&nbsp;zalloc.c:832&nbsp;[opt]</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如果你使用 frame select 命令选择了一个 frame，则会把当前 frame 的信息打印出来，并且 rip 也会变为该 frame 的地址。如下所示。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;register&nbsp;read
General&nbsp;Purpose&nbsp;Registers:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbx&nbsp;=&nbsp;0xffffff801f977000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbp&nbsp;=&nbsp;0xffffff8872cabc50
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsp&nbsp;=&nbsp;0xffffff8872cabc10
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r12&nbsp;=&nbsp;0x7e415085550ee3c7
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r13&nbsp;=&nbsp;0x4141414141414141
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r14&nbsp;=&nbsp;0xffffff8017cd70a0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r15&nbsp;=&nbsp;0x4141414141414141
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rip&nbsp;=&nbsp;0xffffff8011f3e739&nbsp;&nbsp;kernel`try_alloc_from_zone&nbsp;+&nbsp;521&nbsp;at&nbsp;zalloc.c:832</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">你可以看到 rip 确实在我们选择的 frame 中，并且可以看到该函数局部变量的值。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;frame&nbsp;var
(zone_t)&nbsp;zone&nbsp;=&nbsp;&lt;variable&nbsp;not&nbsp;available&gt;
(boolean_t&nbsp;*)&nbsp;check_poison&nbsp;=&nbsp;&lt;variable&nbsp;not&nbsp;available&gt;
(zone_page_metadata&nbsp;*)&nbsp;page_meta&nbsp;=&nbsp;0xffffff8017cd70a0
(vm_offset_t)&nbsp;element&nbsp;=&nbsp;18446743524483756032
(vm_offset_t&nbsp;*)&nbsp;primary&nbsp;=&nbsp;0xffffff801f977000
(vm_offset_t)&nbsp;next_element_primary&nbsp;=&nbsp;4702111234474983745
(vm_offset_t)&nbsp;next_element&nbsp;=&nbsp;9097641255853024199
(vm_offset_t)&nbsp;next_element_backup&nbsp;=&nbsp;4702111234474983745
(vm_offset_t&nbsp;*)&nbsp;backup&nbsp;=&nbsp;&lt;no&nbsp;location,&nbsp;value&nbsp;may&nbsp;have&nbsp;been&nbsp;optimized&nbsp;out&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">OSX 中 Page 的第一部分被称为元数据（Meta data），它包含了有关该 zone 的大量信息，如堆的元数据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">对于 iOS 10，有如下元数据：</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">zindex：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">zone_array 中的索引</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">Page_count：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">分配的页面大小</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">free_count：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">页面中 free element 数量</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">freelist_offset：</span></strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">页面中第一个 free element 的地址</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">下面我们看一下名为 primary 的变量。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;memory&nbsp;read&nbsp;0xffffff801f977000
0xffffff801f977000:&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;&nbsp;AAAAAAAAAAAAAAAA
0xffffff801f977010:&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;41&nbsp;&nbsp;AAAAAAAAAAAAAAAA</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如果 PoC 被正确地触发，那么正常情况下会显示一串 A。由于分配给 zone 的元素在 memset 中以 A 填充，因此结果如上所示。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">以这种方式触发 PoC 后，如果存在你所需的 frame，则可以通过选择该 frame 并检查局部变量的方式进行调试。请注意 frame 相关的命令通常是很有用的。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">我们可以查看在 Mac 上运行的所有任务的基址，内核任务也在其中。可以看到内核任务名为 kernel_task，你可以使用下面的命令将其输出。</span></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">(lldb)&nbsp;showalltasks&nbsp;
task&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vm_map&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ipc_space&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#acts&nbsp;flags&nbsp;&nbsp;&nbsp;&nbsp;pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;process&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io_policy&nbsp;&nbsp;wq_state&nbsp;&nbsp;command&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0xffffff80185b3aa0&nbsp;&nbsp;&nbsp;0xffffff8014d1e6e8&nbsp;&nbsp;&nbsp;0xffffff80180ab800&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;134&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;0xffffff80126ba360&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1&nbsp;-1&nbsp;-1&nbsp;&nbsp;&nbsp;&nbsp;kernel_task&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0xffffff80185b3000&nbsp;&nbsp;&nbsp;0xffffff8018db0838&nbsp;&nbsp;&nbsp;0xffffff80180ab840&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;0xffffff8018d81128&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1&nbsp;-1&nbsp;-1&nbsp;&nbsp;&nbsp;&nbsp;launchd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0xffffff801961c000&nbsp;&nbsp;&nbsp;0xffffff8019603268&nbsp;&nbsp;&nbsp;0xffffff80195c2740&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34&nbsp;&nbsp;&nbsp;0xffffff8018d80cb0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1&nbsp;-1&nbsp;-1&nbsp;&nbsp;&nbsp;&nbsp;UserEventAgent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0xffffff801961caa0&nbsp;&nbsp;&nbsp;0xffffff8019603838&nbsp;&nbsp;&nbsp;0xffffff80195c2980&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;36&nbsp;&nbsp;&nbsp;0xffffff8018d80838&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TQ&nbsp;-1&nbsp;-1&nbsp;-1&nbsp;&nbsp;&nbsp;&nbsp;uninstalld&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0xffffff8019634aa0&nbsp;&nbsp;&nbsp;0xffffff8019603458&nbsp;&nbsp;&nbsp;0xffffff80195c29c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;37&nbsp;&nbsp;&nbsp;0xffffff8018d81e90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1&nbsp;-1&nbsp;-1&nbsp;&nbsp;&nbsp;&nbsp;kextd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;n</pre></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="http://theori.io/research/korean/osx-kernel-exploit-1" target="_blank">原文链接：http://theori.io/research/korean/osx-kernel-exploit-1</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】OS X内核大揭秘之基础篇 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4501" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="b35647466e73a72e6a4b888c6ad8c3bd">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="17247" user-name="万能的张老师" href="javascript:;">
                万能的张老师            </a>
                        <span class="comment-time">2017-10-09 18:59:53</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="17247">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_17247" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">mark!</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="17244" user-name="opoooi" href="javascript:;">
                opoooi            </a>
                        <span class="comment-time">2017-10-09 12:31:37</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="17244">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_17244" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@Brightiup: 转发</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="4501" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4515.html" alt="【漏洞预警】dnsmasq: 多个严重漏洞预警" target="_blank">【漏洞预警】dnsmasq: 多个严重...</a></li>
                                <li><a href="/learning/detail/4526.html" alt="【技术分享】微软 Office Word 无宏命令执行漏洞" target="_blank">【技术分享】微软 Office W...</a></li>
                                <li><a href="/learning/detail/4530.html" alt="【技术分享】快报！Windows DNS客户端中惊现多重堆缓冲区溢出漏洞" target="_blank">【技术分享】快报！Windows ...</a></li>
                                <li><a href="/learning/detail/4520.html" alt="【技术分享】揭秘通杀多款趋势科技产品的RCE漏洞" target="_blank">【技术分享】揭秘通杀多款趋势科技产...</a></li>
                                <li><a href="/learning/detail/4534.html" alt="【技术分享】Lua程序逆向之Luac文件格式分析" target="_blank">【技术分享】Lua程序逆向之Luac...</a></li>
                                <li><a href="/learning/detail/4531.html" alt="【技术分享】ChromeOS基于eCryptfs的用户数据安全保护机制" target="_blank">【技术分享】ChromeOS基于eCr...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://appscan.360.cn/  " alt="360显危镜" target="_blank">360显危镜</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
